<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>æŠ¢çº¢åŒ…æ¨¡æ‹Ÿå™¨</title>
    <style>
        /* -------- æç®€æ ·å¼é‡ç½® -------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none
        }

        /* -------- é¡¶éƒ¨ä¿¡æ¯æ  -------- */
        .header {
            background: #fff;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            font-size: 14px;
            color: #666
        }

        .header-value {
            color: #333;
            font-weight: 500
        }

        /* -------- èŠå¤©åŒºåŸŸ -------- */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #ededed
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start
        }

        .message.self {
            flex-direction: row-reverse
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            flex-shrink: 0;
            font-size: 20px
        }

        .message-info {
            min-width: 25%;
            max-width: 70%;
            /* ä½ çš„å€¼ */
            overflow-wrap: anywhere;
            word-break: break-all;
            /* å¼ºåˆ¶ä»»æ„å­—ç¬¦æ–­è¡Œï¼Œä¸å†æ’‘ç ´ */
        }

        .nickname {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px
        }

        .message.self .nickname {
            text-align: right
        }

        /* æ–‡æœ¬æ°”æ³¡ï¼šè¶…å‡ºå®½åº¦æ‰æ¢è¡Œ */
        .bubble {
            background: #fff;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .1);

            max-width: 100%;
        }

        .message.self .bubble:not(.redpacket-bubble) {
            background: #95ec69;
            /* åªæŸ“æ–‡æœ¬ï¼Œä¸æŸ“çº¢åŒ… */
        }

        /* è¡¨æƒ…å¡ç‰‡ï¼šç‹¬ç«‹åœ†è§’ï¼Œçª„å±å®Œæ•´æ˜¾ç¤º */
        .emoji-card {
            width: 90px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 4px;
            flex-shrink: 0
        }

        .emoji-card img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        /* çº¢åŒ…æ°”æ³¡ï¼šæ‰çŸ©å½¢çº¢åº•é‡‘å­— */
        .redpacket-bubble {
            background: linear-gradient(135deg, #d93030 0%, #fd505e 100%);
            color: #ffdb75;
            border-radius: 8px;
            min-height: 20px;
            min-width: 240px;
            display: inline-flex;
            flex-direction: column;
        }


        .redpacket-line0 {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }

        .redpacket-line1 {
            display: flex;
            align-items: center;
        }




        .redpacket-icon {
            font-size: 42px;
            margin-right: 8px
        }

        .redpacket-type-name {
            font-size: 15px;
            font-weight: 500;
            color: #ffdb75
        }

        .redpacket-type-count {
            font-size: 12px;
            color: #fff;
        }

        .redpacket-note {
            font-size: 12px;
            color: #fff;
            margin-bottom: 0px;
            opacity: .9
        }

        .redpacket-status {
            font-size: 12px;
            color: #fff;
            margin-bottom: 0px
        }

        .grab-btn {
            width: 100%;
            height: 32px;
            /* æŒ‰éœ€ç»™é«˜åº¦ */
            display: flex;
            align-items: center;
            /* å‚ç›´å±…ä¸­ */
            justify-content: center;
            /* æ°´å¹³å±…ä¸­ */
            background: #ffdb70;
            color: #d93030;
            border: 1px solid #ffdb75;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .grab-btn:disabled {
            background: none;
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed
        }

        /* -------- åº•éƒ¨æ“ä½œåŒº -------- */
        .input-area {
            background: #fff;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-right: 10px;
            color: #666
        }

        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            outline: none;
            font-size: 14px
        }

        .send-btn {
            background: #07c160;
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px
        }

        .action-buttons {
            display: flex;
            gap: 10px
        }

        .action-btn {
            background: #07c160;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            flex: 1
        }

        /* -------- è¡¨æƒ…å¼¹çª— -------- */
        .emoji-modal {
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            border-radius: 12px 12px 0 0;
            max-height: 60vh;
            z-index: 300;
            flex-direction: column
        }

        .emoji-modal.show {
            display: flex
        }

        .emoji-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0
        }

        .emoji-title {
            font-size: 16px;
            font-weight: 500
        }

        .emoji-close {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 12px;
            overflow-y: auto
        }

        .emoji-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer
        }

        .emoji-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px
        }

        .emoji-name {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-align: center;
            max-width: 60px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        /* -------- é€šç”¨å¼¹çª— -------- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 1000;
            justify-content: center;
            align-items: center
        }

        .modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            max-width: 50%;
            max-height: 80%;
            overflow-y: auto;
            width: 400px
        }

        .modal-header {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center
        }

        .modal-body {
            margin-bottom: 20px
        }

        .form-group {
            margin-bottom: 15px
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer
        }

        .radio-label input[type=radio] {
            margin-right: 5px
        }

        .modal-footer {
            display: flex;
            gap: 10px
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px
        }

        .modal-btn-primary {
            background: #07c160;
            color: #fff
        }

        .modal-btn-default {
            background: #f0f0f0;
            color: #333
        }

        /* -------- çº¢åŒ…è¯¦æƒ… -------- */
        .redpacket-detail {
            text-align: center;

        }

        .redpacket-amount {
            font-size: 36px;
            color: #f44336;
            font-weight: bold;
            margin: 15px 0
        }

        .redpacket-records {
            max-height: 180px;

            overflow-y: auto;
            margin-top: 15px
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
            color: #666
        }

        @media (max-width:767px) {
            .header-value {
                font-size: 14px
            }

            .bubble {
                max-width: 70%
            }

            .action-btn,
            .grab-btn,
            .send-btn {
                min-height: 44px
            }

            .modal-content {
                width: 90%
            }
        }
    </style>
</head>

<body>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="header">
        <div class="header-item">
            <div class="header-label">ç¾¤äººæ•°</div>
            <div class="header-value" id="memberCount">100</div>
        </div>
        <div class="header-item">
            <div class="header-label">å·²æŠ¢çº¢åŒ…</div>
            <div class="header-value" id="grabbedCount">0</div>
        </div>
        <div class="header-item">
            <div class="header-label">ç°é‡‘ä½™é¢</div>
            <div class="header-value" id="balance">Â¥50.00</div>
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-container" id="chatContainer"></div>

    <!-- åº•éƒ¨æ“ä½œåŒº -->
    <div class="input-area">
        <div class="input-wrapper">
            <button class="emoji-btn" id="emojiBtn">ğŸ˜Š</button>
            <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
            <button class="send-btn" id="sendBtn">å‘é€</button>
        </div>
        <div class="action-buttons">
            <button class="action-btn" id="redpacketBtn">å‘çº¢åŒ…</button>
            <button class="action-btn" id="clearBtn">æ¸…ç©ºèŠå¤©</button>
        </div>
    </div>

    <!-- è¡¨æƒ…å¼¹çª— -->
    <div class="emoji-modal" id="emojiModal">
        <div class="emoji-header">
            <div class="emoji-title">è¡¨æƒ…åŒ…</div>
            <button class="emoji-close" id="emojiClose">&times;</button>
        </div>
        <div class="emoji-grid" id="emojiGrid"></div>
    </div>

    <!-- å‘çº¢åŒ…å¼¹çª— -->
    <div class="modal" id="redpacketModal">
        <div class="modal-content">
            <div class="modal-header">å‘çº¢åŒ…</div>
            <div class="modal-body">
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="redpacketType" value="luck"
                            checked>æ‹¼æ‰‹æ°”çº¢åŒ…</label>
                    <label class="radio-label"><input type="radio" name="redpacketType" value="normal">æ™®é€šçº¢åŒ…</label>
                </div>
                <div class="form-group"><label class="form-label">é‡‘é¢</label><input type="number" class="form-input"
                        id="redpacketAmount" placeholder="0.00" step="0.01"></div>
                <div class="form-group"><label class="form-label">ä»½æ•°</label><input type="number" class="form-input"
                        id="redpacketCount" placeholder="1" min="1"></div>
                <div class="form-group"><label class="form-label">å¤‡æ³¨ï¼ˆâ‰¤10æ±‰å­—ï¼‰</label><input type="text" class="form-input"
                        id="redpacketNote" placeholder="æ­å–œå‘è´¢" maxlength="10"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-default" id="cancelRedpacket">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" id="confirmRedpacket">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- çº¢åŒ…è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="redpacketDetailModal">
        <div class="modal-content">
            <div class="modal-header" id="detailTitle">çº¢åŒ…è¯¦æƒ…</div>
            <div class="modal-body" id="detailContent"></div>
            <div class="modal-footer"><button class="modal-btn modal-btn-primary" id="closeDetail">å…³é—­</button></div>
        </div>
    </div>

    <script>
        /* -------------------- é…ç½®å‚æ•°ï¼ˆä¸­æ–‡æ³¨é‡Šï¼‰ -------------------- */
        const CONFIG = {
            minRedpacketAmount: 0.01,       // çº¢åŒ…æœ€å°é‡‘é¢ï¼ˆå…ƒï¼‰
            minRedpacketCount: 1,           // çº¢åŒ…æœ€å°ä»½æ•°
            memberCount: 230,               // åˆå§‹ç¾¤äººæ•°
            initialBalance: 50,             // ç©å®¶åˆå§‹ä½™é¢ï¼ˆå…ƒï¼‰
            messageFrequency: 3000,         // ç¾¤å‹å‘è¨€é—´éš”ï¼ˆmsï¼‰
            redpacketFrequency: 8000,       // ç¾¤å‹å‘çº¢åŒ…é—´éš”ï¼ˆmsï¼‰
            maxMessages: 100,               // èŠå¤©æ¶ˆæ¯æœ€å¤§ä¿ç•™æ¡æ•°
            redpacketTimeout: 4000,        // çº¢åŒ…è¶…æ—¶è‡ªåŠ¨æŠ¢å…‰æ—¶é—´ï¼ˆmsï¼‰
            maxTextLength: 100,             // æ–‡æœ¬æ¶ˆæ¯æœ€å¤§å­—æ•°
            emojiSendProb: 0.35,            // ç¾¤å‹å‘è¨€æ—¶å‘è¡¨æƒ…æ¦‚ç‡
            redpacketNoteProb: 0.85         // ç¾¤å‹å‘çº¢åŒ…å¸¦å¤‡æ³¨æ¦‚ç‡
        };

        /* -------------------- å…¨å±€çŠ¶æ€ -------------------- */
        let state = {
            memberCount: CONFIG.memberCount,
            balance: CONFIG.initialBalance,
            grabbedCount: 0,
            messages: [],
            redpackets: {},
            members: []
        };

        /* -------------------- å·¥å…·å‡½æ•° -------------------- */
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const randAmount = (min, max) => Math.floor(Math.random() * (max - min) * 100) / 100 + min;

        /* -------------------- ç¾¤å‹æ±  -------------------- */
        const firstNames = ['å”', 'æ—', 'ç‹', 'æ', 'å¼ ', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´', 'å¾', 'å­™', 'èƒ¡',
            'æœ±', 'é«˜', 'ä½•', 'éƒ­', 'é©¬', 'å¸å¾’', 'æ¬§é˜³', 'ä¸œæ–¹', 'å¸é©¬', 'ä¸Šå®˜', 'ä¸ŠåŸ', 'çš‡ç”«', 'å¤§', 'é™ˆ',
            'AAAæ°´ç®¡æ‰¹å‘è€', 'AAAäº”é‡‘æ‰¹å‘è€', 'AAAé©¬æ¡¶åœˆæ‰¹å‘å°', 'AAAåƒåœ¾æ‰¹å‘é˜¿', 'AAAä¸‰è½®è½¦æ‰¹å‘è€', 'AAAè´å¡”æ‰¹å‘è€å¨œ '
            , 'ç¿Ÿé©è‹±', 'é‚£è‰ºå¨œ', 'ä¸‰æ¢¦å¥‡ç¼˜', 'èƒ¡è‰ºè²', 'ä¸‡äººè¿·', 'å¼€å¿ƒå§', 'å¨œå§çš„å°', 'ä¸‰æ¢¦çš„å°', 'é‚£è‰ºå¨œçš„å¤§'
            , 'å¼€å¿ƒå§', 'å¼€å¿ƒå§çš„', 'å¼€å¿ƒå§çš„å¤§', 'é‚£è‰ºå¨œçš„è‡­', 'å¼€å¿ƒå§çš„è‡­', 'é¥­ä¼Ÿéª‘çš„', 'æ·‹æ·‹çš„', 'è„šæ·‹çš„'
            , 'æ¥¼å…°å¤å›½çš„', 'æ‘†åœ°æ‘Šçš„', 'é€å¤–å–çš„', 'å»–æ™¯è½©çš„', 'å»–ä¸¹ä¸¹çš„'];

        const lastNames = ['å¾å¤', 'å‚»é€¼', 'å°ç‹—', 'å›½', 'å»º', 'æ–‡', 'å¹³', 'å¿—', 'å¼º', 'å†›', 'å‹‡', 'å¥', 'åˆš', 'å³°',
            'è¶…', 'æ³¢', 'è¾‰', 'çº¢åŒ…', 'å±', 'å¤§ä¾¿', 'å­å®‰', 'é¸¡', 'å…‰å¤´', 'å¤§çˆ·', 'å¤§å¦ˆ', 'å¥¶å¥¶', 'çˆ·çˆ·', 'å©†å©†', 'å­™å­',
            'äº¤äº¤', 'å°–å°–', 'å¤§å”', 'å¤§å«‚', 'å¤§å¤´', 'ç‹—å­', 'çŒ«', 'ç†Š', 'è›‹', 'é“æŸ±', 'ç¿ èŠ±', 'äºŒå¦', 'è€å­', 'è€æ¿',
            'ä¸œè¥¿', 'è´±è´§', 'è´±äºº', 'æ‹‰æ‹‰', 'å¤ªç¥–', 'è´å¡”', 'é»‘è´å¡”', 'å¤§è´å¡”', 'èšå§', 'å‹¾å·´', 'è¾¾æŸ”å¸®', 'çš„è€å­'
            , 'çš„èµ°åœ°é¸¡', 'çš„å±å«', 'çš„ä¸‰è§’ç¯“å­', 'çš„å©†å©†', 'çš„è€å©†', 'çš„è€å…¬', 'çš„ç›‘æŠ¤äºº', 'çš„çˆ¸çˆ¸'
            , 'çš„å¨˜äº²', 'çš„å¥´å©¢', 'çš„å“€å®¶'

            , 'çš„éŸ³æ˜¥', 'çš„éŸ³åœ°', 'çš„éº»å²©', 'çš„è¥æ°´', 'çš„å¦‚å·', 'çš„å› é‡‘', 'çš„æ•¬ä¸š'

        ];

        const avatars = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“'];
        const messagePool = ['å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼å¤§å®¶å¥½ï¼', 'åˆ«åµäº†', 'è°å‘çº¢åŒ…å•Š', '666', 'ä¸æ˜¯å“¥ä»¬å„¿', 'å•¥æ„æ€', 'å¤§å®¶å¥½å•Š'];
        const redpacketNotePool = ['æ­å–œå‘è´¢', 'å¤§å‰å¤§åˆ©', 'è°¢è°¢è€æ¿', 'å¥½è¿è¿è¿', 'å¿ƒæƒ³äº‹æˆ', 'ä¸‡äº‹å¦‚æ„', 'è´¢æºæ»šæ»š', 'ç¬‘å£å¸¸å¼€', 'æ­¥æ­¥é«˜å‡', 'ç¦æ˜Ÿé«˜ç…§'];

        /* -------------------- è¡¨æƒ…é…ç½®ï¼ˆå·²æ›¿æ¢ä¸ºæŒ‡å®šå¤–é“¾ï¼‰ -------------------- */
        const EMOJI_LIST = [
            { name: 'ä¸æœ', src: 'https://s41.ax1x.com/2025/12/06/pZmJQaD.jpg' },
            { name: 'é‚£è‰ºå¨œ', src: 'https://s41.ax1x.com/2025/12/19/pZ1jWHP.jpg' },
            { name: 'äº¤å‡ºæ¥', src: 'https://s41.ax1x.com/2025/12/08/pZnYQDx.jpg' }
        ];

        /* -------------------- åˆå§‹åŒ–ç¾¤å‹ -------------------- */
        function initMembers() {
            for (let i = 0; i < CONFIG.memberCount; i++) {
                const nickname = firstNames[rand(0, firstNames.length - 1)] + lastNames[rand(0, lastNames.length - 1)];
                state.members.push({ id: i, nickname, avatar: avatars[rand(0, avatars.length - 1)] });
            }
        }

        /* -------------------- é¡¶éƒ¨ä¿¡æ¯ -------------------- */
        function updateHeader() {
            $('#memberCount').textContent = state.memberCount;
            $('#grabbedCount').textContent = state.grabbedCount;
            $('#balance').textContent = `Â¥${state.balance.toFixed(2)}`;
        }

        /* -------------------- æ¶ˆæ¯ç®¡ç† -------------------- */
        function addMessage(msg) {
            state.messages.push(msg);
            if (state.messages.length > CONFIG.maxMessages) state.messages.shift();
            renderMessages();
        }
        function renderMessages() {
            const box = $('#chatContainer');
            box.innerHTML = '';


            state.messages.forEach(msg => {
                const row = document.createElement('div');
                row.className = `message ${msg.isSelf ? 'self' : ''}`;

                if (msg.type === 'text') {
                    row.innerHTML = `
        <div class="avatar">${msg.avatar}</div>
        <div class="message-info">
          <div class="nickname">${msg.nickname}</div>
          <div class="bubble">${msg.content}</div>
        </div>`;
                }
                else if (msg.type === 'emoji') {
                    row.innerHTML = `
        <div class="avatar">${msg.avatar}</div>
        <div class="message-info">
          <div class="nickname">${msg.nickname}</div>
          <div class="emoji-card"><img src="${msg.src}" alt="è¡¨æƒ…"></div>
        </div>`;
                }
                else if (msg.type === 'redpacket') {
                    const rp = state.redpackets[msg.redpacketId];
                    const expired = Date.now() - msg.timestamp > CONFIG.redpacketTimeout;
                    const selfGrab = rp.grabbedUsers.some(u => u.userId === -1);
                    const done = rp.grabbedCount >= rp.count;
                    const statusText = expired || done ? 'å·²æŠ¢å®Œ' : `å‰©ä½™${rp.count - rp.grabbedCount}ä¸ª`;
                    const noteHtml = rp.note ? `<div class="redpacket-note">${rp.note}</div>` : '';
                    let btnHtml = '';
                    if (!expired && !done && !selfGrab) {
                        btnHtml = `<button class="grab-btn" onclick="grabRedpacket(event,'${msg.redpacketId}')">æŠ¢çº¢åŒ…</button>`;
                    } else if (selfGrab) {
                        const amt = rp.grabbedUsers.find(u => u.userId === -1).amount;
                        btnHtml = `<div class="grab-btn" style="border:none;">æŠ¢åˆ°Â¥${amt.toFixed(2)}</div>`;
                    } else {
                        // btnHtml = `<div class="grab-btn" style="border:none;">å·²æŠ¢å®Œ</div>`;
                    }

                    row.innerHTML = `
        <div class="avatar">${msg.avatar}</div>
        <div class="message-info">
          <div class="nickname">${msg.nickname}</div>

          <div class="bubble redpacket-bubble" onclick="showRedpacketDetail('${msg.redpacketId}')">

            <div class="redpacket-line0">
                <div class="redpacket-line1">
                    <span class="redpacket-icon">ğŸ§§</span>

                    <div class="redpacket-title">
                        <div class="redpacket-type-name">${rp.type === 'luck' ? 'æ‹¼æ‰‹æ°”çº¢åŒ…' : 'æ™®é€šçº¢åŒ…'}<span class="redpacket-type-count"> * ${rp.count} ä¸ª</span><br>${noteHtml}</div>
                    </div>

              
               
                </div>
                    ${btnHtml}
                <div class="redpacket-status">${statusText}</div>
                
            </div>


            
           
          </div>
        </div>`;
                }
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;



        }

        /* -------------------- è¡¨æƒ…å¼¹çª— -------------------- */
        function renderEmojiGrid() {
            const grid = $('#emojiGrid'); grid.innerHTML = '';
            EMOJI_LIST.forEach(em => {
                const item = document.createElement('div'); item.className = 'emoji-item';
                item.innerHTML = `<img src="${em.src}" alt="è¡¨æƒ…"><div class="emoji-name">${em.name}</div>`;
                item.onclick = () => sendEmoji(em.src);
                grid.appendChild(item);
            });
        }
        function sendEmoji(src) {
            addMessage({ type: 'emoji', nickname: 'å¤§å…­å…­', avatar: 'ğŸƒ', src, isSelf: true, timestamp: Date.now() });
            $('#emojiModal').classList.remove('show');
        }
        $('#emojiBtn').onclick = () => { renderEmojiGrid(); $('#emojiModal').classList.add('show'); };
        $('#emojiClose').onclick = () => $('#emojiModal').classList.remove('show');
        $('#emojiModal').onclick = e => { if (e.target.id === 'emojiModal') $('#emojiModal').classList.remove('show'); };

        /* -------------------- æ–‡å­—å‘é€ -------------------- */
        $('#sendBtn').onclick = () => {
            const inp = $('#messageInput');
            const txt = inp.value.trim();
            if (!txt) return;
            if (txt.length > CONFIG.maxTextLength) { alert(`æ¶ˆæ¯ä¸èƒ½è¶…è¿‡${CONFIG.maxTextLength}å­—`); return; }
            addMessage({ type: 'text', nickname: 'å¤§å…­å…­', avatar: 'ğŸƒ', content: txt, isSelf: true, timestamp: Date.now() });
            inp.value = '';
        };
        $('#messageInput').onkeypress = e => { if (e.key === 'Enter') $('#sendBtn').onclick(); };

        /* -------------------- å‘çº¢åŒ… -------------------- */
        $('#redpacketBtn').onclick = () => {
            const modal = $('#redpacketModal');
            modal.style.display = 'flex';
            $('#redpacketAmount').value = randAmount(1, 10).toFixed(2);
            $('#redpacketCount').value = rand(1, 5);
            $('#redpacketCount').max = state.memberCount;
        };
        $('#cancelRedpacket').onclick = () => $('#redpacketModal').style.display = 'none';
        $('#confirmRedpacket').onclick = () => {
            const type = document.querySelector('input[name="redpacketType"]:checked').value;
            const amount = parseFloat($('#redpacketAmount').value);
            const count = parseInt($('#redpacketCount').value);
            const note = $('#redpacketNote').value.trim().slice(0, 10);

            if (!amount || amount < CONFIG.minRedpacketAmount) { alert(`é‡‘é¢ä¸èƒ½å°äº${CONFIG.minRedpacketAmount}`); return; }
            if (!count || count < CONFIG.minRedpacketCount) { alert(`ä»½æ•°ä¸èƒ½å°äº${CONFIG.minRedpacketCount}`); return; }
            if (count > state.memberCount) { alert(`ä»½æ•°ä¸èƒ½è¶…è¿‡å½“å‰ç¾¤äººæ•°ï¼ˆ${state.memberCount}ï¼‰`); return; }
            let total = type === 'luck' ? amount : amount * count;
            if (type === 'luck' && amount < count * CONFIG.minRedpacketAmount) { alert(`æ€»é‡‘é¢éœ€â‰¥${(count * CONFIG.minRedpacketAmount).toFixed(2)}`); return; }
            if (state.balance < total) { alert('ä½™é¢ä¸è¶³'); return; }

            const rpId = Date.now().toString();
            const rp = { id: rpId, type, senderId: -1, senderName: 'å¤§å…­å…­', totalAmount: total, count, grabbedCount: 0, grabbedUsers: [], createdAt: Date.now(), note };
            // åˆ†é…é‡‘é¢
            if (type === 'luck') {
                let rema = total, cnt = count; rp.amounts = [];
                for (let i = 0; i < count - 1; i++) {
                    const maxAmt = rema - cnt * CONFIG.minRedpacketAmount + CONFIG.minRedpacketAmount;
                    const amt = randAmount(CONFIG.minRedpacketAmount, maxAmt);
                    rp.amounts.push(amt); rema -= amt; cnt--;
                }
                rp.amounts.push(rema);
            } else rp.amounts = new Array(count).fill(amount);

            state.redpackets[rpId] = rp;
            state.balance -= total;
            updateHeader();
            addMessage({ type: 'redpacket', nickname: 'å¤§å…­å…­', avatar: 'ğŸƒ', redpacketId: rpId, isSelf: true, timestamp: Date.now() });
            $('#redpacketModal').style.display = 'none';
            scheduleRedpacketGrabs(rpId);
        };

        /* -------------------- æŠ¢çº¢åŒ… -------------------- */
        function grabRedpacket(e, rpId) {
            e.stopPropagation();
            const rp = state.redpackets[rpId];
            if (!rp || rp.grabbedCount >= rp.count) return;
            if (rp.grabbedUsers.some(u => u.userId === -1)) return;
            const amt = rp.amounts[rp.grabbedCount];
            rp.grabbedCount++;
            rp.grabbedUsers.push({ userId: -1, nickname: 'å¤§å…­å…­', amount: amt });
            state.balance += amt; state.grabbedCount++;
            updateHeader(); renderMessages();
        }

        /* -------------------- é™†ç»­æŠ¢çº¢åŒ… -------------------- */
        function scheduleRedpacketGrabs(rpId) {
            const rp = state.redpackets[rpId];
            if (!rp) return;
            const times = [];
            for (let i = 0; i < rp.count; i++) times.push(rand(1000, CONFIG.redpacketTimeout - 1000));
            times.sort((a, b) => a - b);
            times.forEach(t => {
                setTimeout(() => {
                    if (rp.grabbedCount < rp.count) {
                        const m = state.members[rand(0, state.memberCount - 1)];
                        const amt = rp.amounts[rp.grabbedCount];
                        rp.grabbedCount++;
                        rp.grabbedUsers.push({ userId: m.id, nickname: m.nickname, amount: amt });
                        renderMessages();
                    }
                }, t);
            });
        }

        /* -------------------- çº¢åŒ…è¯¦æƒ… -------------------- */
        function showRedpacketDetail(rpId) {
            const rp = state.redpackets[rpId]; if (!rp) return;
            const selfGrab = rp.grabbedUsers.some(u => u.userId === -1);
            const myAmt = selfGrab ? rp.grabbedUsers.find(u => u.userId === -1).amount : 0;
            const noteHtml = rp.note ? `<div style="color:#666;font-size:14px;margin:8px 0;">${rp.note}</div>` : '';
            $('#detailTitle').textContent = rp.type === 'luck' ? 'æ‹¼æ‰‹æ°”çº¢åŒ…' : 'æ™®é€šçº¢åŒ…';
            $('#detailContent').innerHTML = `
    <div class="redpacket-detail">
      <div style="color:#666;font-size:14px;">${rp.senderName}</div>
      ${noteHtml}
      ${selfGrab ? `<div class="redpacket-amount">Â¥${myAmt.toFixed(2)}</div>` : ''}
      <div style="color:#666;font-size:14px;">æ€»é¢Â¥${rp.totalAmount.toFixed(2)} Â· å…±${rp.count}ä»½${rp.grabbedCount < rp.count ? ` Â· å‰©ä½™${rp.count - rp.grabbedCount}ä»½` : ''}</div>
      <div class="redpacket-records">
        ${rp.grabbedUsers.map(u => `<div class="record-item"><span>${u.nickname}</span><span>Â¥${u.amount.toFixed(2)}</span></div>`).join('')}
      </div>
    </div>`;
            $('#redpacketDetailModal').style.display = 'flex';
        }
        $('#closeDetail').onclick = () => $('#redpacketDetailModal').style.display = 'none';

        /* -------------------- ç¾¤å‹éšæœºè¡Œä¸º -------------------- */
        function randomMemberSpeak() {
            if (Math.random() < 0.3) {
                const m = state.members[rand(0, state.memberCount - 1)];
                if (Math.random() < CONFIG.emojiSendProb) {
                    const em = EMOJI_LIST[rand(0, EMOJI_LIST.length - 1)];
                    addMessage({ type: 'emoji', nickname: m.nickname, avatar: m.avatar, src: em.src, isSelf: false, timestamp: Date.now() });
                } else {
                    const txt = messagePool[rand(0, messagePool.length - 1)];
                    addMessage({ type: 'text', nickname: m.nickname, avatar: m.avatar, content: txt, isSelf: false, timestamp: Date.now() });
                }
            }
        }
        function randomMemberSendRedpacket() {
            if (Math.random() < 0.2) {
                const m = state.members[rand(0, state.memberCount - 1)];
                const type = Math.random() < 0.7 ? 'luck' : 'normal';
                const count = rand(1, Math.min(5, state.memberCount));
                let amount; if (type === 'luck') amount = randAmount(count * 0.01, count * 2); else amount = randAmount(0.01, 2);
                const rpId = Date.now().toString();
                const rp = { id: rpId, type, senderId: m.id, senderName: m.nickname, totalAmount: type === 'luck' ? amount : amount * count, count, grabbedCount: 0, grabbedUsers: [], createdAt: Date.now() };
                if (Math.random() < CONFIG.redpacketNoteProb) rp.note = redpacketNotePool[rand(0, redpacketNotePool.length - 1)];
                if (type === 'luck') {
                    let rema = rp.totalAmount, cnt = count; rp.amounts = [];
                    for (let i = 0; i < count - 1; i++) {
                        const maxAmt = rema - cnt * CONFIG.minRedpacketAmount + CONFIG.minRedpacketAmount;
                        const amt = randAmount(CONFIG.minRedpacketAmount, maxAmt);
                        rp.amounts.push(amt); rema -= amt; cnt--;
                    }
                    rp.amounts.push(rema);
                } else rp.amounts = new Array(count).fill(amount);
                state.redpackets[rpId] = rp;
                addMessage({ type: 'redpacket', nickname: m.nickname, avatar: m.avatar, redpacketId: rpId, isSelf: false, timestamp: Date.now() });
                scheduleRedpacketGrabs(rpId);
            }
        }
        function fluctuateMembers() {
            if (Math.random() < 0.3) {
                const change = (Math.random() < 0.5 ? -1 : 1) * rand(1, 5);
                state.memberCount = Math.max(50, Math.min(150, state.memberCount + change));
                updateHeader();
            }
        }

        /* -------------------- æ¸…ç©ºèŠå¤© -------------------- */
        $('#clearBtn').onclick = () => { if (confirm('ç¡®å®šæ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿ')) { state.messages = []; renderMessages(); } };

        /* -------------------- å¼¹çª—å¤–éƒ¨å…³é—­ -------------------- */
        $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.style.display = 'none'; });

        /* -------------------- åˆå§‹åŒ– & å®šæ—¶ä»»åŠ¡ -------------------- */
        initMembers(); updateHeader(); renderEmojiGrid();
        setInterval(randomMemberSpeak, CONFIG.messageFrequency);
        setInterval(randomMemberSendRedpacket, CONFIG.redpacketFrequency);
        setInterval(fluctuateMembers, 3000);
        setTimeout(() => {
            addMessage({ type: 'text', nickname: 'ç³»ç»Ÿ', avatar: 'ğŸ¤–', content: 'æ¬¢è¿æ¥åˆ°ç¾¤èŠæŠ¢çº¢åŒ…æ¸¸æˆï¼', isSelf: false, timestamp: Date.now() });
        }, 1000);
    </script>
</body>

</html>
