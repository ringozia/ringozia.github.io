<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>æŠ¢çº¢åŒ…æ¨¡æ‹Ÿå™¨</title>
	<style>
		/* =========================================
           å…¨å±€æ ·å¼é…ç½® (å¾®ä¿¡è§†è§‰é£æ ¼)
           ========================================= */
		:root {
			--primary-green: #07c160;
			--bg-color: #ededed;
			--panel-white: #ffffff;
			--text-dark: #191919;
			--text-light: #b2b2b2;
			--border-color: #dcdcdc;
			--rp-bg: #d95940;
			--rp-gold: #f3d997;
			--my-bubble: #95ec69;
			--bot-bubble: #ffffff;
			--link-blue: #576b95;
			--sys-msg-bg: rgba(0, 0, 0, 0.1);
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			outline: none;
			-webkit-tap-highlight-color: transparent;
		}

		/* 3. ç¦æ­¢åŒç«¯é¡µé¢é€‰å–å¤åˆ¶åŠŸèƒ½ */
		body {
			font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
			background-color: var(--bg-color);
			height: 100vh;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			color: var(--text-dark);
			-webkit-user-select: none;
			/* Safari */
			-moz-user-select: none;
			/* Firefox */
			-ms-user-select: none;
			/* IE10+/Edge */
			user-select: none;
			/* Standard */
		}

		::-webkit-scrollbar {
			width: 4px;
			height: 4px;
		}

		::-webkit-scrollbar-track {
			background: transparent;
		}

		::-webkit-scrollbar-thumb {
			background: rgba(0, 0, 0, 0.1);
			border-radius: 2px;
		}

		.at-text {
			color: var(--link-blue);
			font-weight: 500;
		}

		/* =========================================
           é¡¶éƒ¨æ ‡é¢˜æ 
           ========================================= */
		#top-header {
			height: 44px;
			background: var(--bg-color);
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			font-size: 17px;
			font-weight: 600;
			z-index: 20;
			border-bottom: 1px solid rgba(0, 0, 0, 0.1);
		}

		#settings-btn {
			position: absolute;
			right: 15px;
			font-size: 20px;
			cursor: pointer;
			padding: 5px;
		}

		/* æ‚¬æµ®èƒ¶å›Šä¿¡æ¯æ  */
		#stats-capsule {
			position: absolute;
			top: 54px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(255, 255, 255, 0.85);
			backdrop-filter: blur(10px);
			padding: 4px 6px 4px 16px;
			/* è°ƒæ•´paddingé€‚é…æŒ‰é’® */
			border-radius: 20px;
			font-size: 12px;
			color: #666;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			z-index: 15;
			display: flex;
			align-items: center;
			gap: 10px;
			pointer-events: auto;
			/* å…è®¸ç‚¹å‡»æŒ‰é’® */
			white-space: nowrap;
		}

		#stats-capsule span {
			font-weight: bold;
			color: #333;
		}

		#stats-capsule .money {
			color: var(--rp-bg);
			margin-right: 5px;
		}

		/* å†å²æŒ‰é’®æ ·å¼ */
		#history-btn {
			background: var(--link-blue);
			color: #fff;
			border: none;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 11px;
			cursor: pointer;
		}

		/* =========================================
           èŠå¤©æ¶ˆæ¯å±•ç¤ºåŒº
           ========================================= */
		#chat-area {
			flex: 1;
			overflow-y: auto;
			padding: 50px 15px 15px 15px;
			background-color: var(--bg-color);
			display: flex;
			flex-direction: column;
			gap: 15px;
		}

		.sys-msg-row {
			display: flex;
			justify-content: center;
			margin: 5px 0;
		}

		.sys-msg-text {
			background-color: #dadada;
			color: #fff;
			font-size: 12px;
			padding: 4px 10px;
			border-radius: 4px;
			max-width: 80%;
			text-align: center;
		}

		.message-row {
			display: flex;
			align-items: flex-start;
			margin-bottom: 5px;
			width: 100%;
		}

		.avatar {
			width: 40px;
			height: 40px;
			border-radius: 6px;
			background: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 24px;
			flex-shrink: 0;
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
			cursor: pointer;
		}

		.msg-content-wrapper {
			max-width: 70%;
			display: flex;
			flex-direction: column;
		}

		.nickname {
			font-size: 12px;
			color: var(--text-light);
			margin-bottom: 4px;
		}

		.msg-bubble {
			padding: 10px 14px;
			border-radius: 6px;
			position: relative;
			font-size: 16px;
			line-height: 1.5;
			word-wrap: break-word;
			word-break: break-all;
			display: inline-block;
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
			min-height: 40px;
		}

		/* ç¾¤å‹ï¼ˆå·¦ä¾§ï¼‰ */
		.message-row.left {
			flex-direction: row;
		}

		.message-row.left .avatar {
			margin-right: 10px;
		}

		.message-row.left .msg-content-wrapper {
			align-items: flex-start;
		}

		.message-row.left .msg-bubble {
			background-color: var(--bot-bubble);
			color: #000;
		}

		.message-row.left .msg-bubble::before {
			content: "";
			position: absolute;
			left: -6px;
			top: 14px;
			border: 6px solid transparent;
			border-right-color: var(--bot-bubble);
			border-left: 0;
			margin-top: -6px;
		}

		/* ç©å®¶ï¼ˆå³ä¾§ï¼‰ */
		.message-row.right {
			flex-direction: row-reverse;
		}

		.message-row.right .avatar {
			margin-left: 10px;
		}

		.message-row.right .msg-content-wrapper {
			align-items: flex-end;
		}

		.message-row.right .nickname {
			text-align: right;
		}

		.message-row.right .msg-bubble {
			background-color: var(--my-bubble);
			color: #000;
			text-align: left;
		}

		.message-row.right .msg-bubble::before {
			content: "";
			position: absolute;
			right: -6px;
			top: 14px;
			border: 6px solid transparent;
			border-left-color: var(--my-bubble);
			border-right: 0;
			margin-top: -6px;
		}

		.sticker-card {
			border-radius: 8px;
			overflow: hidden;
			display: block;
			margin-top: 5px;
		}

		.sticker-card img {
			display: block;
			max-width: 150px;
			height: auto;
			border-radius: 8px;
		}

		.message-row .msg-content-wrapper.sticker-wrapper .msg-bubble {
			background: transparent !important;
			padding: 0;
			box-shadow: none;
			min-height: auto;
		}

		.message-row .msg-content-wrapper.sticker-wrapper .msg-bubble::before {
			display: none;
		}

		/* çº¢åŒ…æ°”æ³¡ */
		.rp-bubble {
			width: 240px;
			background-color: var(--rp-bg) !important;
			border-radius: 8px !important;
			padding: 0 !important;
			overflow: hidden;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			text-align: left !important;
		}

		.message-row.left .rp-bubble::before {
			border-right-color: var(--rp-bg);
		}

		.message-row.right .rp-bubble::before {
			border-left-color: var(--rp-bg);
		}

		.rp-top {
			padding: 12px;
			display: flex;
			align-items: center;
			color: var(--rp-gold);
		}

		.rp-icon {
			width: 36px;
			height: 36px;
			background: #f8e7a8;
			border-radius: 4px;
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 20px;
			color: var(--rp-bg);
			margin-right: 12px;
		}

		.rp-info {
			flex: 1;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.rp-type {
			font-size: 15px;
			font-weight: bold;
		}

		.rp-note {
			font-size: 13px;
			margin-top: 2px;
			opacity: 0.9;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.rp-status {
			font-size: 11px;
			margin-top: 2px;
			color: rgba(255, 255, 255, 0.7);
		}

		.rp-bottom {
			background-color: rgba(255, 255, 255, 0.15);
			padding: 8px 12px;
			font-size: 12px;
			color: rgba(255, 255, 255, 0.8);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.rp-btn {
			background: #f8e7a8;
			color: var(--rp-bg);
			padding: 2px 8px;
			border-radius: 10px;
			font-weight: bold;
			font-size: 11px;
		}

		/* =========================================
           åº•éƒ¨åŠŸèƒ½åŒº
           ========================================= */
		#bottom-area {
			background: var(--panel-white);
			border-top: 1px solid var(--border-color);
			padding-bottom: env(safe-area-inset-bottom);
			display: flex;
			flex-direction: column;
		}

		.action-bar {
			padding: 10px 15px 5px 15px;
			display: flex;
			justify-content: center;
		}

		#open-rp-btn {
			background: var(--rp-bg);
			color: white;
			border: none;
			border-radius: 6px;
			width: 100%;
			height: 40px;
			font-size: 15px;
			font-weight: bold;
			cursor: pointer;
			box-shadow: 0 2px 5px rgba(217, 89, 64, 0.3);
		}

		#open-rp-btn:active {
			opacity: 0.9;
		}

		.input-bar {
			padding: 8px 15px 12px 15px;
			display: flex;
			align-items: flex-end;
			gap: 10px;
		}

		#emoji-btn {
			font-size: 28px;
			cursor: pointer;
			color: #7f7f7f;
			width: 36px;
			height: 36px;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
		}

		#msg-input {
			flex: 1;
			min-height: 38px;
			max-height: 100px;
			padding: 8px 10px;
			border: none;
			background: #f7f7f7;
			border-radius: 6px;
			font-size: 16px;
			overflow-y: auto;
			line-height: 1.4;
			color: #333;
		}

		#msg-input:empty:before {
			content: attr(placeholder);
			color: #b2b2b2;
			display: block;
		}

		#send-btn {
			background-color: var(--primary-green);
			color: white;
			border: none;
			padding: 0 16px;
			height: 38px;
			border-radius: 4px;
			font-size: 14px;
			font-weight: bold;
			cursor: pointer;
			flex-shrink: 0;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		#send-btn:disabled {
			background-color: #e0e0e0;
			color: #a0a0a0;
		}

		/* =========================================
           å¼¹çª—æ ·å¼
           ========================================= */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 100;
			display: none;
			justify-content: center;
			align-items: center;
		}

		.modal-overlay.active {
			display: flex;
		}

		.modal-content {
			background: var(--panel-white);
			width: 400px;
			max-width: 85%;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
			animation: fadeIn 0.2s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: scale(0.95);
			}

			to {
				opacity: 1;
				transform: scale(1);
			}
		}

		.modal-header {
			padding: 15px;
			background: #f9f9f9;
			border-bottom: 1px solid var(--border-color);
			text-align: center;
			font-weight: bold;
			position: relative;
		}

		.modal-body {
			padding: 20px;
		}

		.form-group {
			margin-bottom: 15px;
		}

		.form-group label {
			display: block;
			margin-bottom: 5px;
			font-size: 14px;
			color: #666;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 10px;
			border: 1px solid var(--border-color);
			border-radius: 6px;
			font-size: 16px;
			-webkit-appearance: none;
		}

		.radio-group {
			display: flex;
			gap: 20px;
			margin-bottom: 10px;
		}

		.radio-group label {
			display: flex;
			align-items: center;
			gap: 5px;
			cursor: pointer;
		}

		.modal-footer {
			padding: 15px;
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			border-top: 1px solid var(--border-color);
		}

		.btn-cancel {
			background: #f2f2f2;
			color: #333;
			padding: 10px 20px;
			border-radius: 6px;
			border: none;
			cursor: pointer;
			font-weight: bold;
		}

		.btn-confirm {
			background: var(--rp-bg);
			color: white;
			padding: 10px 20px;
			border-radius: 6px;
			border: none;
			cursor: pointer;
			font-weight: bold;
		}

		/* è®¾ç½®å¼¹çª—ä¼˜åŒ– */
		.settings-avatar-list {
			display: flex;
			gap: 10px;
			overflow-x: auto;
			padding-bottom: 5px;
			white-space: nowrap;
		}

		.settings-avatar {
			min-width: 50px;
			height: 50px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 28px;
			border: 1px solid #eee;
			border-radius: 6px;
			cursor: pointer;
			flex-shrink: 0;
		}

		.settings-avatar.selected {
			border-color: var(--primary-green);
			background: rgba(7, 193, 96, 0.1);
		}

		.danger-btn {
			width: 48%;
			background: #fff;
			border: 1px solid #fa5151;
			color: #fa5151;
			height: 44px;
			border-radius: 6px;
			font-weight: bold;
			cursor: pointer;
			font-size: 14px;
		}

		.settings-btn-row {
			display: flex;
			justify-content: space-between;
			margin-top: 15px;
		}

		/* è¡¨æƒ…å¼¹çª— */
		#emoji-popup {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			background: #fff;
			border-top: 1px solid var(--border-color);
			display: none;
			flex-direction: column;
			z-index: 50;
			box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
		}

		#emoji-popup.active {
			display: flex;
		}

		.emoji-header {
			padding: 10px 15px;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 14px;
			color: #666;
		}

		.close-emoji {
			font-size: 20px;
			cursor: pointer;
			padding: 5px;
		}

		.emoji-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 10px;
			padding: 15px;
			max-height: 250px;
			overflow-y: auto;
		}

		.emoji-item {
			text-align: center;
			cursor: pointer;
			padding: 5px;
			border-radius: 6px;
		}

		.emoji-item:active {
			background-color: #f0f0f0;
		}

		.emoji-item img {
			width: 60px;
			height: 60px;
			object-fit: cover;
			border-radius: 6px;
		}

		.emoji-name {
			font-size: 12px;
			color: #999;
			margin-top: 4px;
		}

		/* è¯¦æƒ…å¼¹çª— */
		#rp-detail-modal .modal-content {
			background: #f5f5f5;
			height: 60vh;
			display: flex;
			flex-direction: column;
		}

		.rp-detail-header {
			background: var(--rp-bg);
			color: var(--rp-gold);
			padding: 30px 20px;
			text-align: center;
			position: relative;
		}

		.rp-detail-close {
			position: absolute;
			top: 10px;
			left: 10px;
			color: rgba(255, 255, 255, 0.8);
			font-size: 24px;
			cursor: pointer;
			padding: 5px;
		}

		.rp-big-amount {
			font-size: 36px;
			font-weight: bold;
			margin: 10px 0;
		}

		.rp-list {
			flex: 1;
			overflow-y: auto;
			padding: 0;
			background: #fff;
		}

		.rp-list-item {
			display: flex;
			align-items: center;
			padding: 12px 20px;
			border-bottom: 1px solid #f0f0f0;
		}

		.rp-list-item .avatar {
			width: 36px;
			height: 36px;
			font-size: 20px;
			margin-right: 10px;
			cursor: default;
		}

		.rp-list-info {
			flex: 1;
		}

		.rp-list-money {
			font-size: 15px;
			font-weight: bold;
			color: #333;
		}

		/* å†å²æ•°æ®å¼¹çª—æ ·å¼ */
		.history-list {
			list-style: none;
			padding: 0;
		}

		.history-item {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			border-bottom: 1px solid #eee;
			font-size: 14px;
		}

		.history-item:last-child {
			border-bottom: none;
		}

		.history-label {
			color: #666;
		}

		.history-value {
			font-weight: bold;
			color: #333;
		}

		@media (max-width: 768px) {
			#top-header {
				font-size: 16px;
			}

			.sticker-card img {
				max-width: 100px;
			}

			.rp-bubble {
				width: 200px;
			}

			.modal-content {
				width: 90%;
			}

			#emoji-popup {
				position: fixed;
			}

			.emoji-grid {
				grid-template-columns: repeat(4, 1fr);
			}

			#settings-btn,
			.close-emoji {
				min-width: 44px;
				min-height: 44px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
		}
	</style>
	<!-- å¼•å…¥å¤–éƒ¨é…ç½® -->
	<script src="æŠ¢çº¢åŒ…é…ç½®.js" onerror="console.log('æœªåŠ è½½å¤–éƒ¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®')"></script>
</head>

<body>

	<!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
	<div id="top-header">
		<span id="header-title">æŠ¢çº¢åŒ…â‘ ç¾¤</span>
		<div id="settings-btn" onclick="openSettings()">âš™</div>
	</div>

	<!-- æ‚¬æµ®ä¿¡æ¯èƒ¶å›Š -->
	<div id="stats-capsule">
		<div>ä½™é¢ <span id="user-balance" class="money">Â¥50.00</span></div>
		<button id="history-btn" onclick="openHistoryModal()">å†å²</button>
	</div>

	<!-- èŠå¤©å†…å®¹åŒº -->
	<div id="chat-area"></div>

	<!-- åº•éƒ¨æ“ä½œåŒº -->
	<div id="bottom-area">
		<div class="action-bar">
			<button id="open-rp-btn" onclick="openRedPacketModal()">å‘çº¢åŒ…</button>
		</div>
		<div class="input-bar">
			<div id="emoji-btn">â˜º</div>
			<div id="msg-input" contenteditable="true" placeholder=""></div>
			<button id="send-btn" disabled>å‘é€</button>
		</div>
	</div>

	<!-- è¡¨æƒ…å¼¹çª— -->
	<div id="emoji-popup">
		<div class="emoji-header">
			<span>è¡¨æƒ…åŒ…</span>
			<span class="close-emoji">Ã—</span>
		</div>
		<div class="emoji-grid" id="emoji-grid-container"></div>
	</div>

	<!-- å‘çº¢åŒ…å¼¹çª— -->
	<div class="modal-overlay" id="send-rp-modal">
		<div class="modal-content">
			<div class="modal-header">å‘çº¢åŒ…</div>
			<div class="modal-body">
				<div class="radio-group">
					<label><input type="radio" name="rpType" value="lucky" checked> æ‹¼æ‰‹æ°”çº¢åŒ…</label>
					<label><input type="radio" name="rpType" value="normal"> æ™®é€šçº¢åŒ…</label>
				</div>
				<div class="form-group">
					<label id="amount-label">æ€»é‡‘é¢ (å…ƒ)</label>
					<input type="number" id="rp-amount" placeholder="0.00" step="0.01">
				</div>
				<div class="form-group">
					<label>çº¢åŒ…ä¸ªæ•° (ä¸ª)</label>
					<input type="number" id="rp-count" placeholder="å¡«å†™ä¸ªæ•°" pattern="\d*">
				</div>
				<div class="form-group">
					<label>å¤‡æ³¨</label>
					<input type="text" id="rp-note" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©" maxlength="10">
				</div>
				<div style="color:red; font-size:12px; height: 16px;" id="rp-error-msg"></div>
			</div>
			<div class="modal-footer">
				<button class="btn-cancel" onclick="closeRedPacketModal()">å–æ¶ˆ</button>
				<button class="btn-confirm" id="btn-send-rp" onclick="sendRedPacket()">å‘çº¢åŒ…ï¿¥0.00</button>
			</div>
		</div>
	</div>

	<!-- è¯¦æƒ…å¼¹çª— -->
	<div class="modal-overlay" id="rp-detail-modal">
		<div class="modal-content">
			<div class="rp-detail-header">
				<div class="rp-detail-close" onclick="closeDetailModal()">Ã—</div>
				<div class="avatar" style="margin: 0 auto; background: transparent; font-size: 40px; cursor: default;">
					ğŸ§§</div>
				<div style="margin-top: 10px;" id="detail-sender">å‘é€äºº</div>
				<div style="font-size: 12px; opacity: 0.8;" id="detail-note">å¤‡æ³¨ä¿¡æ¯</div>
				<div id="detail-result-area">
					<div class="rp-big-amount" id="detail-amount">Â¥0.00</div>
					<div style="font-size: 12px; color: #f3d997;" id="detail-status-text"></div>
				</div>
			</div>
			<div style="padding: 10px 20px; font-size: 12px; color: #999; border-bottom: 1px solid #eee;">
				é¢†å–è¯¦æƒ… (<span id="detail-grabbed-count">0</span>/<span id="detail-total-count">10</span>)
			</div>
			<div class="rp-list" id="detail-list"></div>
		</div>
	</div>

	<!-- å†å²æ•°æ®å¼¹çª— -->
	<div class="modal-overlay" id="history-modal">
		<div class="modal-content">
			<div class="modal-header" id="history-header-title">å†å²æ•°æ®</div>
			<div class="modal-body">
				<ul class="history-list">
					<li class="history-item"><span class="history-label">å·²å‘çº¢åŒ…æ•°</span><span class="history-value"
							id="hist-sent-count">0</span></li>
					<li class="history-item"><span class="history-label">å·²æŠ¢çº¢åŒ…æ•°</span><span class="history-value"
							id="hist-grab-count">0</span></li>
					<li class="history-item"><span class="history-label">å‘å•ä¸ªæœ€é«˜æ€»é‡‘é¢</span><span class="history-value"
							id="hist-max-sent">0.00</span></li>
					<li class="history-item"><span class="history-label">æŠ¢å•ä¸ªæœ€é«˜é‡‘é¢</span><span class="history-value"
							id="hist-max-grab">0.00</span></li>
					<li class="history-item"><span class="history-label">å‘çº¢åŒ…æ€»é‡‘é¢</span><span class="history-value"
							id="hist-total-sent">0.00</span></li>
					<li class="history-item"><span class="history-label">æŠ¢çº¢åŒ…æ€»é‡‘é¢</span><span class="history-value"
							id="hist-total-grab">0.00</span></li>
					<!-- ä¿¡ä»»å€¼ -->
					<li class="history-item"><span class="history-label">ä¿¡ä»»å€¼</span><span class="history-value"
							id="hist-trust-val">100%</span></li>
				</ul>
			</div>
			<div class="modal-footer">
				<button class="btn-cancel"
					onclick="document.getElementById('history-modal').classList.remove('active')">å…³é—­</button>
			</div>
		</div>
	</div>

	<!-- è®¾ç½®å¼¹çª— -->
	<div class="modal-overlay" id="settings-modal">
		<div class="modal-content">
			<div class="modal-header">è®¾ç½®</div>
			<div class="modal-body">
				<div class="form-group">
					<label>ç¾¤èŠåç§°</label>
					<input type="text" id="setting-group-name" maxlength="12">
				</div>
				<div class="form-group">
					<label>æˆ‘çš„æ˜µç§°</label>
					<input type="text" id="setting-name" maxlength="8">
				</div>
				<div class="form-group">
					<label>é€‰æ‹©å¤´åƒ</label>
					<div class="settings-avatar-list" id="avatar-grid">
						<!-- JSç”Ÿæˆå¤´åƒé€‰é¡¹ -->
					</div>
				</div>

				<div class="settings-btn-row">
					<button class="danger-btn" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button>
					<button class="danger-btn" id="clear-save-btn" onclick="resetData()">æ¸…ç©ºå­˜æ¡£</button>
				</div>

				<label style="
				  display: block;
				  text-align: center;
				  color: #999;
				  font-size: 12px;
				  margin-top: 24px;
				">ç‰ˆæœ¬V1.0.4&emsp;|&emsp;2025.12.23<br>@çŒç¡çŒ«</label>
			</div>
			<div class="modal-footer">
				<button class="btn-cancel" onclick="closeSettings()">å–æ¶ˆ</button>
				<button class="btn-confirm" onclick="saveSettings()">ä¿å­˜</button>
			</div>
		</div>
	</div>

	<script>
		/* ================= CONFIG é…ç½®ä¸­å¿ƒ ================= */
		const CONFIG = {
			// --- ç©å®¶åŸºç¡€é…ç½® ---
			USER: {
				name: "ç©å®¶4326",
				avatar: "ğŸƒ",
				initialBalance: 50.00
			},

			// --- ç¾¤èŠåŸºç¡€é…ç½® ---
			GROUP: {
				name: "æŠ¢çº¢åŒ…â‘ ç¾¤",
				initialCount: 208,
				fluctuationInterval: 8000,
				maxFluctuation: 2
			},

			// çº¢åŒ…å¤‡æ³¨
			RP_NOTES: ["æ­å–œå‘è´¢", "å¤§å‰å¤§åˆ©"],

			// --- é‡‘æ± ç³»ç»Ÿé…ç½® ---
			GOLD_POOL: {
				initial: 100, // åˆå§‹é‡‘æ± 
				multiplier: 10, // ç©å®¶å‘çº¢åŒ…ä¹˜æ•°
				urgeIntervalMin: 2000, // å‚¬ä¿ƒæœ€å°é—´éš”(ms)
				urgeIntervalMax: 8000, // å‚¬ä¿ƒæœ€å¤§é—´éš”(ms)
				urgeTexts: ["å¿«å‘çº¢åŒ…", "è½®åˆ°ä½ å‘çº¢åŒ…äº†", "è€æ¿å‘çº¢åŒ…å§", "å¿«ç‚¹å‘åŒ…", "ç­‰ä½ å¥½ä¹…äº†", "åˆ«è€æ˜¯æŠ¢åˆä¸å‘çº¢åŒ…",
					"å‘ä¸ªçº¢åŒ…å‘—", "ç­‰ä½ çš„çº¢åŒ…å“Ÿ~", " .", "å‘çº¢åŒ…æ±‚ä½ äº†", "å¤šå°‘ç»™ç‚¹å§~", "æˆ‘æ²¡é’±äº†ï¼Œä½ å‘å§", "ä½ ä¸å‘çº¢åŒ…æˆ‘ä¹Ÿä¸å‘",
					"æ¥ä¸ªçº¢åŒ…", "çœ‹æ¥å½»åº•æ²¡äººå‘çº¢åŒ…äº†", "ä½ èµ¶ç´§å‘ï¼Œç­‰ä¸‹æˆ‘å‘ä¸ªå¤§çš„", "å¤§å®¶éƒ½åœ¨ç­‰ä½ çš„çº¢åŒ…è¯¶", "å‘ä¸€åˆ†é’±ä¹Ÿè¡Œ"] // å‚¬ä¿ƒæ–‡æ¡ˆ
			},

			// --- æœºå™¨äººè¡Œä¸ºé…ç½® ---
			BOT: {
				msgIntervalMin: 200,// æœºå™¨äººæ¶ˆæ¯æœ€å°é—´éš”(ms)
				msgIntervalMax: 6000,// æœºå™¨äººæ¶ˆæ¯æœ€å¤§é—´éš”(ms)
				stickerProbability: 0.35,// æœºå™¨äººå‘é€è´´çº¸æ¦‚ç‡
				redPacketProbability: 0.3,// æœºå™¨äººå‘é€çº¢åŒ…æ¦‚ç‡

				rpCountMin: 1,// çº¢åŒ…ä¸ªæ•°æœ€å°å€¼
				rpCountMax: 20,// çº¢åŒ…ä¸ªæ•°æœ€å¤§å€¼
				rpTotalMin: 0.20,// çº¢åŒ…æ€»é‡‘é¢æœ€å°å€¼
				rpTotalMax: 100.00,// çº¢åŒ…æ€»é‡‘é¢æœ€å¤§å€¼

				grabDelayMin: 10,// çº¢åŒ…æŠ¢å®Œå»¶è¿Ÿæœ€å°å€¼(ms)
				grabDelayMax: 500,// çº¢åŒ…æŠ¢å®Œå»¶è¿Ÿæœ€å¤§å€¼(ms)

				// æœºå™¨äººæ„Ÿè°¢
				thanksTexts: ["å¤šè°¢è€æ¿", "è€æ¿å¤§æ°”", "è°¢è°¢è€æ¿çº¢åŒ…", "è€æ¿å¥½äºº"],
				thanksProb: 0.5,

				// æœºå™¨äººå›å¤@
				replyTexts: ["ç¡®å®", "ç¬‘æ­»", "èµåŒ", "å“ˆå“ˆå“ˆ"],
				replyProb: 0.15,

				// æœºå™¨äººå›å¤ç©å®¶
				randomInteractTexts: ["å“ˆå“ˆ", "æ€ä¹ˆäº†", "ç¬‘æ­»æˆ‘äº†", "å¹²å˜›å‘¢", "åŒæ„Ÿ"],
				randomInteractProb: 0.10
			},

			// --- èµ„æºåº“ ---
			NAMES_A: ["å”", "æ—", "å¶"],
			NAMES_B: ["æ˜", "å", "å¼º"],
			AVATARS: ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ¦†"],
			PLAYER_AVATARS: ["ğŸƒ", "ğŸ‘»", "ğŸ‘½", "ğŸ¤–", "ğŸ’©", "ğŸ¤¡", "ğŸ‘¹", "ğŸ‘¿", "ğŸ¤ ", "ğŸ˜"],
			TEXT_MSGS: ["ä»Šå¤©å¤©æ°”çœŸä¸é”™", "å“ˆå“ˆå“ˆå“ˆ", "ï¼Ÿ"],
			STICKERS: [
			
			],
		};

		if (window.EXTRA_CONFIG) {
			const mergeArray = (target, source) => source && Array.isArray(source) ? target.concat(source) : target;
			CONFIG.BOT.thanksTexts = mergeArray(CONFIG.BOT.thanksTexts, window.EXTRA_CONFIG.thanksTexts);
			CONFIG.BOT.replyTexts = mergeArray(CONFIG.BOT.replyTexts, window.EXTRA_CONFIG.replyTexts);
			CONFIG.BOT.randomInteractTexts = mergeArray(CONFIG.BOT.randomInteractTexts, window.EXTRA_CONFIG.randomInteractTexts);
			CONFIG.NAMES_A = mergeArray(CONFIG.NAMES_A, window.EXTRA_CONFIG.NAMES_A);
			CONFIG.NAMES_B = mergeArray(CONFIG.NAMES_B, window.EXTRA_CONFIG.NAMES_B);
			CONFIG.TEXT_MSGS = mergeArray(CONFIG.TEXT_MSGS, window.EXTRA_CONFIG.TEXT_MSGS);
			CONFIG.STICKERS = mergeArray(CONFIG.STICKERS, window.EXTRA_CONFIG.STICKERS);
			CONFIG.RP_NOTES = mergeArray(CONFIG.RP_NOTES, window.EXTRA_CONFIG.RP_NOTES);
			if (window.EXTRA_CONFIG.GOLD_POOL) Object.assign(CONFIG.GOLD_POOL, window.EXTRA_CONFIG.GOLD_POOL);
			console.log("å¤–éƒ¨é…ç½®å·²åŠ è½½å¹¶åˆå¹¶");
		}

		/* ================= STATE å…¨å±€çŠ¶æ€ ================= */
		const state = {
			balance: CONFIG.USER.initialBalance,
			groupCount: CONFIG.GROUP.initialCount,
			groupName: CONFIG.GROUP.name,
			grabbedCount: 0,
			messages: [],
			redPackets: {},
			rpIdCounter: 1,
			goldPool: CONFIG.GOLD_POOL.initial, // é‡‘æ± ä½™é¢
			history: {
				sentCount: 0,
				grabCount: 0,
				maxSent: 0,
				maxGrab: 0,
				totalSent: 0,
				totalGrab: 0
			}
		};

		/* ================= UTILS å·¥å…·å‡½æ•° ================= */
		const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
		const randArr = (arr) => arr[Math.floor(Math.random() * arr.length)];
		const formatMoney = (num) => parseFloat(num).toFixed(2);
		function createRandomUser() { return { name: randArr(CONFIG.NAMES_A) + randArr(CONFIG.NAMES_B), avatar: randArr(CONFIG.AVATARS) }; }
		function generateRandomName() { return randArr(CONFIG.NAMES_A) + randArr(CONFIG.NAMES_B); }

		/* ================= SAVE/LOAD å­˜æ¡£åŠŸèƒ½ ================= */
		const SAVE_KEY = 'rp_simulator_save_v1';

		function loadData() {
			const saved = localStorage.getItem(SAVE_KEY);
			if (saved) {
				try {
					const data = JSON.parse(saved);
					if (data.groupName) state.groupName = data.groupName;
					if (data.playerName) CONFIG.USER.name = data.playerName;
					if (data.playerAvatar) CONFIG.USER.avatar = data.playerAvatar;
					if (data.balance !== undefined) state.balance = parseFloat(data.balance);
					if (data.grabbedCount !== undefined) state.grabbedCount = parseInt(data.grabbedCount);
					if (data.goldPool !== undefined) state.goldPool = parseFloat(data.goldPool);
					if (data.history) state.history = { ...state.history, ...data.history };
					console.log("å­˜æ¡£å·²åŠ è½½");
				} catch (e) {
					console.error("å­˜æ¡£åŠ è½½å¤±è´¥", e);
				}
			}
		}

		function saveData() {
			const data = {
				groupName: state.groupName,
				playerName: CONFIG.USER.name,
				playerAvatar: CONFIG.USER.avatar,
				balance: state.balance,
				grabbedCount: state.grabbedCount,
				goldPool: state.goldPool,
				history: state.history
			};
			localStorage.setItem(SAVE_KEY, JSON.stringify(data));
		}

		function resetData() {
			if (confirm("ç¡®å®šè¦æ¸…ç©ºå­˜æ¡£å¹¶æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ")) {
				localStorage.removeItem(SAVE_KEY);
				location.reload();
			}
		}

		/* ================= UI RENDER æ¸²æŸ“é€»è¾‘ ================= */
		function updateStats() {
			document.getElementById('header-title').innerText = `${state.groupName}(${state.groupCount})`;
			document.getElementById('user-balance').innerText = "Â¥" + formatMoney(state.balance);
			saveData();
		}

		function scrollToBottom() {
			const chatArea = document.getElementById('chat-area');
			chatArea.scrollTop = chatArea.scrollHeight;
		}

		function formatMsgContent(text) {
			let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
			return safeText.replace(/@([\u4e00-\u9fa5a-zA-Z0-9]+)\s/g, '<span class="at-text">@$1 </span>');
		}

		function appendMessage(msgData) {
			const chatArea = document.getElementById('chat-area');

			// 1. æ»šåŠ¨çŠ¶æ€æ£€æµ‹
			const threshold = 50;
			const isAtBottom = chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight <= threshold;

			if (chatArea.children.length >= 100) chatArea.removeChild(chatArea.firstElementChild);

			const row = document.createElement('div');
			row.className = `message-row ${msgData.isUser ? 'right' : 'left'}`;

			const avatarHtml = `<div class="avatar" onclick="insertAt('${msgData.user.name}')">${msgData.user.avatar}</div>`;
			const nameHtml = `<div class="nickname">${msgData.user.name}</div>`;
			let contentHtml = '', wrapperClass = '';

			if (msgData.type === 'text') contentHtml = `<div class="msg-bubble">${formatMsgContent(msgData.content)}</div>`;
			else if (msgData.type === 'sticker') {
				wrapperClass = 'sticker-wrapper';
				contentHtml = `<div class="msg-bubble"><div class="sticker-card"><img src="${msgData.content.url}"></div></div>`;
			} else if (msgData.type === 'redpacket') {
				const rpId = msgData.content.id;
				const rpInfo = state.redPackets[rpId];
				const isGrabbedByUser = rpInfo.grabbers.some(g => g.isUser);
				const isFinished = rpInfo.remainingCount === 0;
				let btnText = isGrabbedByUser ? `æŠ¢åˆ°${formatMoney(rpInfo.grabbers.find(g => g.isUser).amount)}å…ƒ` : (isFinished ? "å·²æŠ¢å®Œ" : "æŠ¢çº¢åŒ…");
				contentHtml = `
                <div class="msg-bubble rp-bubble" onclick="handleRedPacketClick('${rpId}')" id="rp-bubble-${rpId}">
                    <div class="rp-top">
                        <div class="rp-icon">ğŸ§§</div>
                        <div class="rp-info">
                            <div class="rp-type">${rpInfo.type === 'lucky' ? 'æ‹¼æ‰‹æ°”çº¢åŒ…' : 'æ™®é€šçº¢åŒ…'}<span style="font-size:12px;font-weight:normal;margin-left:5px;">${rpInfo.totalCount}ä»½</span></div>
                            <div class="rp-note">${rpInfo.note}</div>
                            <div class="rp-status" id="rp-status-${rpId}">${isFinished ? "å·²æŠ¢å®Œ" : `å‰©ä½™${rpInfo.remainingCount}ä¸ª`}</div>
                        </div>
                    </div>
                    <div class="rp-bottom"><span>ç°é‡‘çº¢åŒ…</span><span class="rp-btn" id="rp-btn-${rpId}">${btnText}</span></div>
                </div>`;
			}

			row.innerHTML = `
            ${avatarHtml}
            <div class="msg-content-wrapper ${wrapperClass}">
                ${nameHtml}
                ${contentHtml}
            </div>
        `;

			chatArea.appendChild(row);

			if (isAtBottom) {
				scrollToBottom();
			}
		}

		function appendSystemMessage(text) {
			const chatArea = document.getElementById('chat-area');
			const row = document.createElement('div');
			row.className = 'sys-msg-row';
			row.innerHTML = `<div class="sys-msg-text">${text}</div>`;
			chatArea.appendChild(row);
			scrollToBottom();
		}

		/* ================= RED PACKET LOGIC çº¢åŒ…é€»è¾‘ ================= */
		function createRedPacketData(sender, type, inputAmount, count, note) {
			const id = 'rp_' + (state.rpIdCounter++);
			let totalAmount = inputAmount, distribution = [];

			if (type === 'normal') {
				totalAmount = inputAmount * count;
				for (let i = 0; i < count; i++) distribution.push(inputAmount);
			} else {
				let remain = totalAmount, rCount = count;
				for (let i = 0; i < count - 1; i++) {
					const max = remain - (rCount - 1) * 0.01;
					let money = Math.floor((Math.random() * (remain / rCount * 2)) * 100) / 100;
					money = Math.max(0.01, Math.min(money, max));
					distribution.push(money); remain -= money; rCount--;
				}
				distribution.push(Math.round(remain * 100) / 100);
			}

			const rpData = { id, sender, type, totalAmount, totalCount: count, remainingCount: count, remainingAmount: totalAmount, note: note || "æ­å–œå‘è´¢", grabbers: [], distribution };
			state.redPackets[id] = rpData;
			initBotGrabScheduler(id);
			return rpData;
		}

		function initBotGrabScheduler(rpId) {
			const schedule = () => {
				if (state.redPackets[rpId].remainingCount <= 0) return;
				setTimeout(() => {
					if (state.redPackets[rpId].remainingCount > 0) {
						performGrab(rpId, createRandomUser(), false);
						schedule();
					}
				}, randInt(CONFIG.BOT.grabDelayMin, CONFIG.BOT.grabDelayMax));
			};
			schedule();
		}

		function performGrab(rpId, user, isUser) {
			const rp = state.redPackets[rpId];
			if (rp.remainingCount <= 0) return 0;
			const money = rp.distribution.pop();
			rp.remainingCount--; rp.remainingAmount -= money;
			rp.grabbers.push({ name: user.name, avatar: user.avatar, amount: money, isUser, time: new Date().toLocaleTimeString() });

			if (isUser) {
				state.balance += money;
				state.grabbedCount++;

				// ç©å®¶æŠ¢çº¢åŒ…æ¶ˆè€—é‡‘æ± 
				state.goldPool -= money;

				// å†å²è®°å½•ç»Ÿè®¡
				state.history.grabCount++;
				state.history.totalGrab += money;
				if (money > state.history.maxGrab) state.history.maxGrab = money;

				updateStats();
			}
			updateRpBubbleUI(rpId);
			return money;
		}

		function updateRpBubbleUI(rpId) {
			const rp = state.redPackets[rpId];
			const statusEl = document.getElementById(`rp-status-${rpId}`);
			const btnEl = document.getElementById(`rp-btn-${rpId}`);
			if (statusEl && btnEl) {
				statusEl.innerText = rp.remainingCount === 0 ? "å·²æŠ¢å®Œ" : `å‰©ä½™${rp.remainingCount}ä¸ª`;
				if (rp.remainingCount === 0 && btnEl.innerText === "æŠ¢çº¢åŒ…") btnEl.innerText = "å·²æŠ¢å®Œ";
				const myGrab = rp.grabbers.find(g => g.isUser);
				if (myGrab) btnEl.innerText = `æŠ¢åˆ°${formatMoney(myGrab.amount)}å…ƒ`;
			}
		}

		function handleRedPacketClick(rpId) {
			const rp = state.redPackets[rpId];
			if (!rp.grabbers.find(g => g.isUser) && rp.remainingCount > 0) performGrab(rpId, CONFIG.USER, true);
			showDetailModal(rpId);
		}

		/* ================= INTERACTION äº’åŠ¨äº‹ä»¶ ================= */
		function triggerRedPacketReaction(rpData) {
			if (rpData.sender !== CONFIG.USER || rpData.totalCount < 3) return;
			if (Math.random() < CONFIG.BOT.thanksProb) {
				const count = randInt(1, 3);
				for (let i = 0; i < count; i++) setTimeout(() => appendMessage({ type: 'text', isUser: false, user: createRandomUser(), content: `@${CONFIG.USER.name} ${randArr(CONFIG.BOT.thanksTexts)}` }), randInt(1000, 4000) + i * 1000);
			}
		}

		function triggerMsgReaction() {
			if (Math.random() < CONFIG.BOT.replyProb) setTimeout(() => appendMessage({ type: 'text', isUser: false, user: createRandomUser(), content: `@${CONFIG.USER.name} ${randArr(CONFIG.BOT.replyTexts)}` }), randInt(1000, 3000));
		}

		function triggerRandomInteraction() {
			if (Math.random() < CONFIG.BOT.randomInteractProb) appendMessage({ type: 'text', isUser: false, user: createRandomUser(), content: `@${generateRandomName()} ${randArr(CONFIG.BOT.randomInteractTexts)}` });
		}

		function triggerMentionReply(targetName) {
			setTimeout(() => {
				const bot = { name: targetName, avatar: randArr(CONFIG.AVATARS) };
				const replyText = randArr(CONFIG.BOT.replyTexts);
				appendMessage({
					type: 'text',
					isUser: false,
					user: bot,
					content: `@${CONFIG.USER.name} ${replyText}`
				});
			}, randInt(1000, 2000));
		}

		/* ================= SYSTEM EVENTS ================= */
		function triggerGroupFluctuationEvents(change) {
			if (Math.random() > 0.3) return;
			const count = randInt(1, 3);
			for (let i = 0; i < count; i++) {
				setTimeout(() => {
					let text = "";
					const name1 = generateRandomName();
					if (change > 0) {
						if (Math.random() < 0.5) text = `"${name1}"åŠ å…¥äº†ç¾¤èŠ`;
						else text = `"${generateRandomName()}"é‚€è¯·"${name1}"åŠ å…¥äº†ç¾¤èŠ`;
					} else {
						text = `"${name1}"é€€å‡ºäº†ç¾¤èŠ`;
					}
					appendSystemMessage(text);
				}, i * 800);
			}
		}

		/* ================= INPUT & SEND è¾“å…¥å‘é€é€»è¾‘ ================= */
		const msgInput = document.getElementById('msg-input');
		const sendBtn = document.getElementById('send-btn');

		// 4. è¾“å…¥æ å­—æ•°é™åˆ¶ (100å­—)
		msgInput.addEventListener('keydown', (e) => {
			const allowedKeys = [8, 13, 37, 38, 39, 40, 46];
			if (msgInput.innerText.length >= 100 && !allowedKeys.includes(e.keyCode) && !e.ctrlKey && !e.metaKey) {
				e.preventDefault();
			}
		});
		msgInput.addEventListener('paste', (e) => {
			e.preventDefault();
			const text = (e.originalEvent || e).clipboardData.getData('text/plain');
			const remaining = 100 - msgInput.innerText.length;
			if (remaining > 0) {
				document.execCommand('insertText', false, text.substring(0, remaining));
			}
		});

		window.insertAt = (name) => {
			msgInput.focus();
			document.execCommand('insertHTML', false, `<span class="at-text">@${name} </span>&nbsp;`);
			checkInput();
		};

		function checkInput() { sendBtn.disabled = msgInput.innerText.trim().length === 0; }
		msgInput.addEventListener('input', checkInput);
		msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (!sendBtn.disabled) sendMsg(); } });
		sendBtn.onclick = sendMsg;

		function sendMsg() {
			const text = msgInput.innerText.trim();
			if (text) {
				appendMessage({ type: 'text', isUser: true, user: CONFIG.USER, content: text });
				msgInput.innerHTML = ''; sendBtn.disabled = true;

				const mentionMatch = text.match(/@([\u4e00-\u9fa5a-zA-Z0-9]+)/);
				if (mentionMatch) {
					triggerMentionReply(mentionMatch[1]);
				} else {
					triggerMsgReaction();
				}
			}
		}

		/* ================= MODALS å¼¹çª—é€»è¾‘ ================= */
		const sendRpModal = document.getElementById('send-rp-modal');
		const rpAmountInput = document.getElementById('rp-amount');
		const rpCountInput = document.getElementById('rp-count');
		const btnSendRp = document.getElementById('btn-send-rp');

		function openRedPacketModal() {
			sendRpModal.classList.add('active');
			document.getElementById('rp-error-msg').innerText = '';
			const max = state.balance * 0.5;
			const type = document.querySelector('input[name="rpType"]:checked').value;
			const count = randInt(3, 10);
			let total = Math.max(0.01, Math.floor(Math.random() * max * 100) / 100);
			rpCountInput.value = count;
			rpAmountInput.value = type === 'lucky' ? total : Math.max(0.01, Math.floor(total / count * 100) / 100);
			updateTotalBtn();
			updateAmountLabel();
		}
		function closeRedPacketModal() { sendRpModal.classList.remove('active'); }
		function updateAmountLabel() {
			document.getElementById('amount-label').innerText = document.querySelector('input[name="rpType"]:checked').value === 'lucky' ? 'æ€»é‡‘é¢ (å…ƒ)' : 'å•ä¸ªé‡‘é¢ (å…ƒ)';
		}
		function updateTotalBtn() {
			const type = document.querySelector('input[name="rpType"]:checked').value;
			const amt = parseFloat(rpAmountInput.value) || 0, cnt = parseInt(rpCountInput.value) || 0;
			btnSendRp.innerText = `å‘çº¢åŒ…ï¿¥${formatMoney(type === 'lucky' ? amt : amt * cnt)}`;
		}
		[rpAmountInput, rpCountInput].forEach(i => i.addEventListener('input', updateTotalBtn));
		document.querySelectorAll('input[name="rpType"]').forEach(r => r.addEventListener('change', () => { updateAmountLabel(); updateTotalBtn(); }));

		function sendRedPacket() {
			const type = document.querySelector('input[name="rpType"]:checked').value;
			const amt = parseFloat(rpAmountInput.value), cnt = parseInt(rpCountInput.value), note = document.getElementById('rp-note').value.trim();
			const err = document.getElementById('rp-error-msg');
			if (isNaN(amt) || amt < 0.01) return err.innerText = "é‡‘é¢æ— æ•ˆ";
			if (isNaN(cnt) || cnt < 1 || cnt > state.groupCount) return err.innerText = "ä¸ªæ•°æ— æ•ˆ";
			let total = type === 'normal' ? amt * cnt : amt;
			if (type === 'lucky' && amt / cnt < 0.01) return err.innerText = "å•åŒ…è¿‡å°";
			if (state.balance < total) return err.innerText = "ä½™é¢ä¸è¶³";

			state.balance -= total;

			// 2. é‡‘æ± å¢å€¼ (æ€»é‡‘é¢ * ä¹˜æ•°)
			state.goldPool += total * CONFIG.GOLD_POOL.multiplier;

			// 6. è®°å½•å†å²æ•°æ®
			state.history.sentCount++;
			state.history.totalSent += total;
			if (total > state.history.maxSent) state.history.maxSent = total;

			updateStats();
			const rpData = createRedPacketData(CONFIG.USER, type, amt, cnt, note);
			appendMessage({ type: 'redpacket', isUser: true, user: CONFIG.USER, content: { id: rpData.id } });
			closeRedPacketModal(); triggerRedPacketReaction(rpData);
		}

		/* è¯¦æƒ…å¼¹çª—é€»è¾‘ */
		const detailModal = document.getElementById('rp-detail-modal');
		function showDetailModal(rpId) {
			const rp = state.redPackets[rpId], myGrab = rp.grabbers.find(g => g.isUser);
			document.getElementById('detail-sender').innerText = `${rp.sender.name}çš„çº¢åŒ…`;
			document.getElementById('detail-note').innerText = rp.note;
			document.getElementById('detail-amount').innerText = myGrab ? `Â¥${formatMoney(myGrab.amount)}` : (rp.remainingCount === 0 ? "æ‰‹æ…¢äº†" : "å¾…é¢†å–");
			document.getElementById('detail-status-text').innerText = myGrab ? "å·²å­˜å…¥ä½™é¢" : (rp.remainingCount === 0 ? "çº¢åŒ…å·²æ´¾å®Œ" : "");
			if (rp.remainingCount === 0 && !myGrab) document.getElementById('detail-amount').style.fontSize = "24px";
			else document.getElementById('detail-amount').style.fontSize = "36px";

			document.getElementById('detail-grabbed-count').innerText = rp.totalCount - rp.remainingCount;
			document.getElementById('detail-total-count').innerText = rp.totalCount;
			const listEl = document.getElementById('detail-list'); listEl.innerHTML = '';
			const best = [...rp.grabbers].sort((a, b) => b.amount - a.amount)[0]?.amount || 0;

			[...rp.grabbers].reverse().forEach(g => {
				const isBest = rp.type === 'lucky' && rp.remainingCount === 0 && g.amount === best;
				listEl.innerHTML += `<div class="rp-list-item"><div class="avatar">${g.avatar}</div><div class="rp-list-info"><div class="rp-list-name">${g.name} ${g.isUser ? '(æˆ‘)' : ''}</div><div class="rp-list-time">${g.time}</div></div><div style="text-align:right;"><div class="rp-list-money">${formatMoney(g.amount)}å…ƒ</div>${isBest ? '<div style="color:#f3d997;font-size:12px;">ğŸ‘‘ æ‰‹æ°”æœ€ä½³</div>' : ''}</div></div>`;
			});
			detailModal.classList.add('active');
		}
		function closeDetailModal() { detailModal.classList.remove('active'); }

		/* å†å²å¼¹çª—é€»è¾‘ */
		const historyModal = document.getElementById('history-modal');
		function openHistoryModal() {
			document.getElementById('history-header-title').innerText = `${CONFIG.USER.name}çš„å†å²æ•°æ®`;
			document.getElementById('hist-sent-count').innerText = state.history.sentCount;
			document.getElementById('hist-grab-count').innerText = state.history.grabCount;
			document.getElementById('hist-max-sent').innerText = formatMoney(state.history.maxSent);
			document.getElementById('hist-max-grab').innerText = formatMoney(state.history.maxGrab);
			document.getElementById('hist-total-sent').innerText = formatMoney(state.history.totalSent);
			document.getElementById('hist-total-grab').innerText = formatMoney(state.history.totalGrab);
			// ä¿¡ä»»å€¼
			document.getElementById('hist-trust-val').innerText = formatMoney(state.goldPool) + '%';
			historyModal.classList.add('active');
		}

		/* ================= SETTINGS è®¾ç½®é€»è¾‘ ================= */
		const settingsModal = document.getElementById('settings-modal');
		let tempAvatar = CONFIG.USER.avatar;
		function openSettings() {
			settingsModal.classList.add('active');
			document.getElementById('setting-group-name').value = state.groupName;
			document.getElementById('setting-name').value = CONFIG.USER.name;
			renderAvatarGrid();
		}
		function closeSettings() { settingsModal.classList.remove('active'); }
		function renderAvatarGrid() {
			const grid = document.getElementById('avatar-grid'); grid.innerHTML = '';
			CONFIG.PLAYER_AVATARS.forEach(ava => {
				const el = document.createElement('div'); el.className = `settings-avatar ${ava === tempAvatar ? 'selected' : ''}`;
				el.innerText = ava; el.onclick = () => { tempAvatar = ava; renderAvatarGrid(); };
				grid.appendChild(el);
			});
		}
		function saveSettings() {
			const gName = document.getElementById('setting-group-name').value.trim();
			const uName = document.getElementById('setting-name').value.trim();
			if (gName) state.groupName = gName;
			if (uName) CONFIG.USER.name = uName;
			CONFIG.USER.avatar = tempAvatar;
			updateStats(); closeSettings();
		}
		document.getElementById('clear-chat-btn').onclick = function () {
			if (confirm("ç¡®å®šæ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿ")) {
				document.getElementById('chat-area').innerHTML = '';
				state.messages = [];
				closeSettings();
			}
		};

		/* ================= MAIN LOOP ä¸»å¾ªç¯ ================= */
		const emojiBtn = document.getElementById('emoji-btn');
		const emojiPopup = document.getElementById('emoji-popup');
		CONFIG.STICKERS.forEach(s => {
			const div = document.createElement('div'); div.className = 'emoji-item'; div.innerHTML = `<img src="${s.url}"><div class="emoji-name">${s.name}</div>`;
			div.onclick = () => { appendMessage({ type: 'sticker', isUser: true, user: CONFIG.USER, content: s }); emojiPopup.classList.remove('active'); };
			document.getElementById('emoji-grid-container').appendChild(div);
		});
		emojiBtn.onclick = () => emojiPopup.classList.add('active');
		document.querySelector('.close-emoji').onclick = () => emojiPopup.classList.remove('active');

		// ç‹¬ç«‹çš„å‚¬ä¿ƒå¾ªç¯
		function urgeLoop() {
			const delay = randInt(CONFIG.GOLD_POOL.urgeIntervalMin, CONFIG.GOLD_POOL.urgeIntervalMax);
			setTimeout(() => {
				if (state.goldPool <= 0) {
					const bot = createRandomUser();
					appendMessage({
						type: 'text',
						isUser: false,
						user: bot,
						content: `@${CONFIG.USER.name} ${randArr(CONFIG.GOLD_POOL.urgeTexts)}`
					});
				}
				urgeLoop();
			}, delay);
		}

		// å¸¸è§„èŠå¤©å¾ªç¯
		function botLoop() {
			setTimeout(() => {
				const bot = createRandomUser();
				const roll = Math.random();

				// åªæœ‰å½“é‡‘æ±  > 0 æ—¶æ‰å¯èƒ½è§¦å‘å‘çº¢åŒ…é€»è¾‘
				if (roll < CONFIG.BOT.redPacketProbability) {
					if (state.goldPool > 0) {
						// æ­£å¸¸å‘çº¢åŒ…
						const type = Math.random() < 0.5 ? 'lucky' : 'normal';
						const count = randInt(CONFIG.BOT.rpCountMin, CONFIG.BOT.rpCountMax);

						const minFen = Math.round(CONFIG.BOT.rpTotalMin * 100);
						const maxFen = Math.round(CONFIG.BOT.rpTotalMax * 100);

						let amt;
						if (type === 'normal') {
							const maxSingleFen = Math.floor(maxFen / count);
							const safeMaxFen = Math.max(minFen, maxSingleFen);
							amt = randInt(minFen, safeMaxFen) / 100;
						} else {
							amt = randInt(minFen, maxFen) / 100;
						};

						const rp = createRedPacketData(bot, type, amt, count, Math.random() < 0.25 ? randArr(CONFIG.RP_NOTES) : "");
						appendMessage({ type: 'redpacket', isUser: false, user: bot, content: { id: rp.id } });
					} else {
						// é‡‘æ± ä¸è¶³ï¼Œçº¢åŒ…è¢«æŠ‘åˆ¶ï¼Œè½¬æ¢ä¸ºæ™®é€šèŠå¤©æˆ–è¡¨æƒ…ä»¥ä¿æŒæ´»è·ƒ
						if (Math.random() < 0.5) {
							appendMessage({ type: 'sticker', isUser: false, user: bot, content: randArr(CONFIG.STICKERS) });
						} else {
							triggerRandomInteraction();
							appendMessage({ type: 'text', isUser: false, user: bot, content: randArr(CONFIG.TEXT_MSGS) });
						}
					}
				} else if (roll < CONFIG.BOT.redPacketProbability + CONFIG.BOT.stickerProbability) {
					// å‘è¡¨æƒ…
					appendMessage({ type: 'sticker', isUser: false, user: bot, content: randArr(CONFIG.STICKERS) });
				} else {
					// å‘æ–‡æœ¬
					triggerRandomInteraction();
					if (Math.random() > 0.3) appendMessage({ type: 'text', isUser: false, user: bot, content: randArr(CONFIG.TEXT_MSGS) });
				}

				botLoop();
			}, randInt(CONFIG.BOT.msgIntervalMin, CONFIG.BOT.msgIntervalMax));
		}

		setInterval(() => {
			const change = randInt(-CONFIG.GROUP.maxFluctuation, CONFIG.GROUP.maxFluctuation);
			if (change !== 0) {
				state.groupCount += change;
				if (state.groupCount < 50) state.groupCount = 50;
				updateStats();
				triggerGroupFluctuationEvents(change);
			}
		}, CONFIG.GROUP.fluctuationInterval);

		window.onload = function () {
			loadData(); // åŠ è½½å­˜æ¡£
			updateStats();

			// 5. å…¥ç¾¤æ¬¢è¿ï¼šçŒç¡çŒ«
			setTimeout(() => {
				const welcomeBot = { name: "çŒç¡çŒ«", avatar: "ğŸ±" };
				appendMessage({
					type: 'text',
					isUser: false,
					user: welcomeBot,
					content: `@${CONFIG.USER.name} æ¬¢è¿æ¥åˆ°${state.groupName}ï¼`
				});
			}, 500);

			botLoop();  // å¯åŠ¨å¸¸è§„èŠå¤©
			urgeLoop(); // å¯åŠ¨å‚¬ä¿ƒæ£€æµ‹
		};

		window.onclick = function (e) {
			if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active');
			if (!emojiPopup.contains(e.target) && e.target !== emojiBtn) emojiPopup.classList.remove('active');
		};
	</script>
</body>

</html>
