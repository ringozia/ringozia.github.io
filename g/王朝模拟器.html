<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‹æœæ¨¡æ‹Ÿå™¨</title>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent: #c0392b;
            /* æ·±çº¢/å±æœº */
            --success: #27ae60;
            /* ç»¿è‰²/å®‰å…¨ */
            --gold: #f1c40f;
            /* é‡‘è‰²/ç››ä¸– */
            --purple: #8e44ad;
            /* ä¸­å…´/ç‰¹æ®Š */
            --score-color: #2980b9;
            /* åˆ†å€¼é¢œè‰² */
            --border: #e0e0e0;
            --btn-bg: #2980b9;
            --btn-text: #fff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header {
            height: 50px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
            font-weight: bold;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-title {
            font-size: 16px;
        }

        .btn-help {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--text-main);
            background: none;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .btn-history {
            padding: 4px 10px;
            background: none;
            border: 1px solid var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* æ ¸å¿ƒä¿¡æ¯åŒº */
        main {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .dynasty-name {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .dynasty-info {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .monarch-section {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            position: relative;
        }

        .era-name {
            font-size: 18px;
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 4px;
        }

        .monarch-name-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .monarch-name {
            font-size: 18px;
            font-weight: bold;
        }

        .btn-lineage {
            font-size: 11px;
            padding: 2px 6px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            color: var(--text-main);
            cursor: pointer;
            white-space: nowrap;
        }

        .monarch-stats {
            font-size: 13px;
            color: var(--text-sub);
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* æ•°å€¼é¢æ¿ */
        .stats-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats-grid-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* çŠ¶æ€è¡Œ (å››åˆ—) */
        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
        }

        .stat-box {
            background: var(--card-bg);
            padding: 10px 2px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
        }

        /* çŠ¶æ€é¢œè‰²ç±» */
        .status-excellent {
            color: var(--success);
        }

        /* ä¼˜ */
        .status-good {
            color: var(--btn-bg);
        }

        /* è‰¯ */
        .status-poor {
            color: #e67e22;
        }

        /* å·® */
        .status-critical {
            color: var(--accent);
        }

        /* å± */

        /* å†å²åç‰Œå¡ç‰‡ */
        .history-badge-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: #888;
            border: 1px dashed #ddd;
        }

        .history-badge-card.active {
            border: 2px solid var(--text-main);
            color: var(--text-main);
            background: #fff;
        }

        .badge-shengshi {
            border-color: var(--gold) !important;
            color: #d4ac0d !important;
            background: #fef9e7 !important;
        }

        .badge-zhongxing {
            border-color: var(--purple) !important;
            color: var(--purple) !important;
            background: #f4ecf7 !important;
        }

        .badge-danger {
            border-color: var(--accent) !important;
            color: var(--accent) !important;
            background: #fdedec !important;
        }

        .badge-good {
            border-color: var(--success) !important;
            color: var(--success) !important;
            background: #eafaf1 !important;
        }

        /* åº•éƒ¨ */
        footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 10px 16px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        /* åº•éƒ¨äº‹ä»¶æ  */
        .event-bar {
            height: 52px;
            background: #f0f2f5;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            overflow: hidden;
            color: var(--text-main);
            position: relative;
        }

        .event-line {
            width: 100%;
            height: 20px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æ‰“å­—æœºåŠ¨ç”» (2s) */
        .typing-anim {
            display: inline;
            vertical-align: top;
            white-space: nowrap;
            animation: typeReveal 2s cubic-bezier(0.1, 0.7, 0.1, 1) forwards;
            clip-path: inset(0 100% 0 0);
        }

        @keyframes typeReveal {
            from {
                clip-path: inset(0 100% 0 0);
            }

            to {
                clip-path: inset(0 0 0 0);
            }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 10px;
        }

        .speed-btn,
        .card-btn-trigger {
            background: var(--btn-bg);
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .speed-btn.active-5x {
            background: var(--accent);
        }

        .card-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            display: none;
        }

        /* èƒ¶å›Šæ¶ˆæ¯ (Toast) */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: rgba(44, 62, 80, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInDown 0.3s ease-out, fadeOut 0.3s ease-in 1.7s forwards;
            white-space: nowrap;
        }

        .toast-sticky {
            background: rgba(39, 174, 96, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* å†å²å¼¹çª—å±‚çº§æœ€é«˜ */
        #historyModal {
            z-index: 200;
        }

        #cardDetailModal {
            z-index: 210;
        }

        /* è¯¦æƒ…æ›´é«˜ */

        .modal {
            background: var(--card-bg);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: popIn 0.2s ease-out;
            z-index: 101;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .modal-footer.game-over-footer {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-secondary {
            padding: 12px;
            background: transparent;
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100px;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-details {
            display: none;
            margin-top: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-more {
            color: var(--btn-bg);
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            text-decoration: underline;
        }

        .lineage-row {
            font-size: 13px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            color: #2c3e50;
        }

        .tag-shengshi {
            color: #d4ac0d;
            font-weight: bold;
            margin-left: 5px;
        }

        .tag-zhongxing {
            color: #8e44ad;
            font-weight: bold;
            margin-left: 5px;
        }

        .tag-feichu {
            color: #7f8c8d;
            font-weight: bold;
            margin-left: 5px;
            text-decoration: line-through;
        }

        /* å¡ç‰Œç³»ç»Ÿæ ·å¼ */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .card-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 90px;
            text-align: left;
            position: relative;
            color: #2c3e50;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-name {
            font-weight: bold;
            font-size: 14px;
        }

        .btn-card-info {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-timer {
            font-size: 11px;
            color: #e67e22;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .card-actions {
            display: flex;
            gap: 5px;
        }

        .btn-card-use {
            flex: 1;
            padding: 4px;
            background: var(--btn-bg);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-card-discard {
            flex: 1;
            padding: 4px;
            background: #95a5a6;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .creation-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .creation-label {
            font-size: 14px;
            color: #666;
            width: 40px;
            text-align: left;
        }

        .dice-btn {
            font-size: 20px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 4px;
        }

        .generated-name {
            font-size: 22px;
            font-weight: bold;
            color: var(--accent);
            flex: 1;
            text-align: center;
        }

        .main-btn {
            width: 100%;
            padding: 12px;
            background: var(--btn-bg);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        .log-list p {
            margin-bottom: 6px;
            font-size: 13px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .log-year {
            font-weight: bold;
            color: var(--text-sub);
            margin-right: 6px;
        }

        .help-text p {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #444;
        }

        .help-text h3 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 16px;
            color: var(--text-main);
        }

        .watermark {
            position: fixed;
            pointer-events: none;
            color: rgba(0, 0, 0, 0.15);
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
            white-space: nowrap;
            user-select: none;
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <header>
        <div class="header-left">
            <div class="header-title">ç‹æœæ¨¡æ‹Ÿå™¨</div>
            <button class="btn-help" onclick="openModal('helpModal')">?</button>
        </div>
        <div class="header-info">
            <span id="currentYearDisplay">å…¬å…ƒ 126 å¹´</span>
            <button class="btn-history" onclick="openHistory()">å†å²</button>
        </div>
    </header>

    <main id="gameUI" style="display:none;">
        <div class="card">
            <div class="dynasty-name" id="uiDynastyName">--</div>
            <div class="dynasty-info">
                <span>å»ºå›½ <span id="uiFoundYear">--</span></span>
                <span>Â·</span>
                <span>å›½ç¥š <span id="uiDuration">0</span> å¹´</span>
                <button class="btn-lineage" id="btnLineage" onclick="openLiveLineage()">è°±ç³»0</button>
            </div>

            <div class="monarch-section">
                <div class="era-name" id="uiEraName">--</div>
                <div class="monarch-name-row">
                    <div class="monarch-name" id="uiMonarchName">--</div>
                </div>
                <div class="monarch-stats">
                    <span><span id="uiMonarchAge">--</span> å²</span>
                    <span>åœ¨ä½ <span id="uiReignDuration">0</span> å¹´</span>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stats-grid-top">
                <div class="stat-box">
                    <div class="stat-label">å›½åŠ›å€¼</div>
                    <div class="stat-value" id="uiPower">--%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æˆ˜å½¹/èƒœæˆ˜</div>
                    <div class="stat-value" id="uiBattleStats">0 / 0</div>
                </div>
            </div>

            <div class="status-row">
                <div class="stat-box">
                    <div class="stat-label">å›ä¸»</div>
                    <div class="stat-value" id="uiMonarchState">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æœå»·</div>
                    <div class="stat-value" id="uiCourt">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">å†›å¿ƒ</div>
                    <div class="stat-value" id="uiMilitary">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æ°‘å¿ƒ</div>
                    <div class="stat-value" id="uiPublic">--</div>
                </div>
            </div>

            <div id="uiHistoryBadge" class="history-badge-card">
                å¾…è§£é” (å›½ç¥š>50å¹´)
            </div>
        </div>
    </main>

    <footer id="gameFooter" style="display:none;">
        <div class="event-bar" id="uiEventBar" onclick="openEventLog()">
            <div class="event-line" style="color:#999; text-align:center;">æš‚æ— å¤§äº‹ä»¶...</div>
        </div>
        <div class="controls">
            <div></div>
            <div class="controls-right">
                <button class="card-btn-trigger" onclick="openCardModal()">
                    å¡ç‰Œ
                    <div class="card-badge" id="uiCardBadge">0</div>
                </button>
                <button class="speed-btn" id="speedBtn" onclick="toggleSpeed()">1x é€Ÿ</button>
            </div>
        </div>
    </footer>

    <div id="createModal" class="modal-overlay active">
        <div class="modal">
            <div class="modal-header">å»ºç«‹æ–°æœä»£</div>
            <div class="modal-body" style="text-align: center;">
                <p style="color:#666; margin-bottom:20px;">ç‚¹å‡»éª°å­éšæœºç”Ÿæˆä¿¡æ¯</p>
                <div class="creation-group">
                    <span class="creation-label">å›½å·</span>
                    <span class="generated-name" id="previewDynasty">? ?</span>
                    <button class="dice-btn" onclick="rollDynastyName()">ğŸ²</button>
                </div>
                <div class="creation-group">
                    <span class="creation-label">å›½å§“</span>
                    <span class="generated-name" id="previewSurname">?</span>
                    <button class="dice-btn" onclick="rollSurname()">ğŸ²</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="main-btn" id="btnStartGame" onclick="startGame()">ç™»åŸºå»ºå›½ (60s)</button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>å†å²å¤§äº‹ä»¶</span>
                <span onclick="closeModal('eventModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body log-list" id="fullEventLog"></div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>å†æœå†ä»£</span>
                <span onclick="closeModal('historyModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body">
                <ul class="history-list" id="historyList"></ul>
            </div>
        </div>
    </div>

    <div id="lineageModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æœ¬æœå¸ç‹è°±ç³»</span>
                <span onclick="closeModal('lineageModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body">
                <div
                    style="font-size:12px; color:#555; text-align:center; padding-bottom:10px; border-bottom:1px solid #eee;">
                    æœä»£æ€»åˆ†å€¼ï¼š<span id="uiTotalScore">0</span> &nbsp;&nbsp; å¹³å‡åˆ†å€¼ï¼š<span id="uiAvgScore">0</span>
                </div>
                <div id="lineageList" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" style="color:var(--accent);">æœä»£ç­äº¡</div>
            <div class="modal-body" style="text-align: center;">
                <h2 id="goDynastyName" style="margin-bottom: 10px;"></h2>
                <p>äº«å›½ <span id="goDuration"></span> å¹´</p>
                <p>å†ç» <span id="goMonarchCount"></span> ä½å¸ç‹</p>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    å›½åŠ›è€—å°½ï¼Œç¤¾ç¨·å´©å¡Œã€‚<br>åäººåªèƒ½åœ¨å²ä¹¦ä¸­çª¥è§å¾€æ—¥è£å…‰ã€‚
                </p>
            </div>
            <div class="modal-footer game-over-footer">
                <button class="btn-secondary" onclick="openHistory()">å†å²</button>
                <button class="main-btn" style="flex:1;" onclick="resetToCreation()">æ–°å»ºæœä»£</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æ¸¸æˆç©æ³•</span>
                <span onclick="closeModal('helpModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body help-text">
                <p><strong>æ ¸å¿ƒç›®æ ‡ï¼š</strong> å°½å¯èƒ½å»¶ç»­ç‹æœå¯¿å‘½ï¼Œé¿å…å›½åŠ›å½’é›¶ã€‚</p>
                <h3>âš–ï¸ çŠ¶æ€ä¸å›½åŠ›</h3>
                <p>Â· <strong>å›½åŠ›å€¼</strong>ï¼šå½’é›¶å³äº¡å›½ã€‚æ¯å¹´è‡ªåŠ¨-1ã€‚</p>
                <p>Â· <strong>å››å¤§çŠ¶æ€</strong>ï¼šå›ä¸»ã€æœå»·ã€å†›å¿ƒã€æ°‘å¿ƒã€‚çŠ¶æ€ä¼˜åŠ£å†³å®šæ¯å¹´å›½åŠ›çš„å¢å‡ã€‚</p>
                <h3>âš”ï¸ æˆ˜å½¹ç³»ç»Ÿ</h3>
                <p>Â· <strong>æˆ‘æ–¹å‘èµ·</strong>ï¼šå›½åŠ›â‰¥70%æ—¶æ¦‚ç‡æå‡ã€‚èƒœåˆ©å¯å¤§å¹…å¢åŠ å›½åŠ›ã€‚</p>
                <p>Â· <strong>æ•Œæ–¹å…¥ä¾µ</strong>ï¼šå›½åŠ›â‰¤30%æ—¶æ¦‚ç‡æå‡ã€‚å¤±è´¥å°†æ‰£é™¤å›½åŠ›ã€‚</p>
                <h3>ğŸƒ å¡ç‰Œç³»ç»Ÿ</h3>
                <p>Â· æ¯10å¹´è·å¾—å¡ç‰Œï¼Œå¯ç”¨äºå¢ç›ŠçŠ¶æ€æˆ–èµŒå›½è¿ã€‚</p>
            </div>
        </div>
    </div>

    <div id="cardModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æ²»å›½ç­–ç•¥</span>
                <span onclick="closeModal('cardModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body">
                <div id="cardList" class="card-grid"></div>
                <div id="noCardMsg" style="text-align:center; color:#999; padding:20px; display:none;">æš‚æ— å¯ç”¨å¡ç‰Œ</div>
            </div>
        </div>
    </div>

    <!-- å¡ç‰Œè¯¦æƒ…å¼¹çª— -->
    <div id="cardDetailModal" class="modal-overlay">
        <div class="modal" style="max-width:300px;">
            <div class="modal-header">
                <span id="detailCardName">å¡ç‰Œè¯¦æƒ…</span>
                <span onclick="closeModal('cardDetailModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p id="detailCardDesc" style="line-height:1.6; color:#444;"></p>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            baseYear: 126,
            speeds: { normal: 2000, fast: 1000 },
            maxAge: 90,
            givenNameFirst: "ç…œæ™¯å¼˜ä¹¾æ³°æ˜Šæ˜Œæ˜­æ˜¾æ‰¿æ’æ¸Šæœ—ç¿ç†™å“²å…ƒå…å¯åœ£è´¤è‰¯è‹±æ°ä¿Šä¼Ÿåšé›…å‡¯é£ç‘éœ–æ³½é“­èµ«å‹‹æƒç­–å´‡å¾·éš†å…´å˜‰é“æ·³å…‰",
            givenNameSecond: "ç¥¯ç°æ¡“æªç‘œçªç‘›éºŸç’‹ä½‘ä½ä½‘çºªçº²ç»´çº¬ç»çº¶ç»ªç»Ÿç»§å—£å»¶ç»µè£•ç¦ç¦„å¯¿ç¦§ç¥¥ç‘åº†å®‰å®åº·æ³°æ­£å¹³æ²»åŒ–",
            surnames: [
                "èµµ", "é’±", "å­™", "æ", "å‘¨", "å´", "éƒ‘", "ç‹", "å†¯", "é™ˆ", "è¤š", "å«", "è’‹", "æ²ˆ", "éŸ©", "æ¨", "æœ±", "ç§¦", "å°¤", "è®¸", "ä½•", "å•", "æ–½", "å¼ ", "å­”", "æ›¹", "ä¸¥", "å", "é‡‘", "é­", "é™¶", "å§œ", "æˆš", "è°¢", "é‚¹", "å–»", "æŸ", "æ°´", "çª¦", "ç« ", "äº‘", "è‹", "æ½˜", "è‘›", "å¥š", "èŒƒ", "å½­", "éƒ", "é²", "éŸ¦", "æ˜Œ", "é©¬", "è‹—", "å‡¤", "èŠ±", "æ–¹", "ä¿", "ä»»", "è¢", "æŸ³", "é…†", "é²", "å²", "å”", "è´¹", "å»‰", "å²‘", "è–›", "é›·", "è´º", "å€ª", "æ±¤", "æ»•", "æ®·", "ç½—", "æ¯•", "éƒ", "å®‰", "å¸¸", "ä¹", "äº", "æ—¶", "å‚…", "çš®", "å", "é½", "åº·", "ä¼", "ä½™", "å…ƒ", "åœ", "é¡¾", "å­Ÿ", "å¹³", "é»„", "å’Œ", "ç©†", "è§", "å°¹", "å§š", "é‚µ", "æ¹›", "æ±ª", "ç¥", "æ¯›", "ç¦¹", "ç‹„", "ç±³", "è´", "æ˜", "è‡§", "è®¡", "ä¼", "æˆ", "æˆ´", "è°ˆ", "å®‹", "èŒ…", "åº", "ç†Š", "çºª", "èˆ’", "å±ˆ", "é¡¹", "ç¥", "è‘£", "æ¢", "æœ", "é˜®", "è“", "é—µ", "å¸­", "å­£", "éº»", "å¼º", "è´¾", "è·¯", "å¨„", "å±", "æ±Ÿ", "ç«¥", "é¢œ", "éƒ­", "æ¢…", "ç››", "æ—", "åˆ", "é’Ÿ", "å¾", "é‚±", "éª†", "é«˜", "å¤", "è”¡", "ç”°", "æ¨Š", "èƒ¡", "å‡Œ", "éœ", "ä¸‡", "æŸ¯", "å¢", "è«", "æˆ¿", "ç¼ª", "å¹²", "è§£", "åº”", "å®—", "ä¸", "å®£", "é‚“", "éƒ", "å•", "æ­", "æ´ª", "åŒ…", "è¯¸", "å·¦", "çŸ³", "å´”", "å‰", "é’®", "é¾š", "ç¨‹", "åµ‡", "é‚¢", "æ»‘", "è£´", "é™†", "è£", "ç¿", "è€", "ç¾Š", "æ–¼", "æƒ ", "å®¶", "å°", "èŠ®", "ç¾¿", "å‚¨", "æ™‹", "æ±²", "é‚´", "ç³œ", "æ¾", "äº•", "æ®µ", "å¯Œ", "å·«", "ä¹Œ", "ç„¦", "å·´", "å¼“", "ç‰§", "éš—", "å±±", "è°·", "è½¦", "ä¾¯", "å®“", "è“¬", "å…¨", "éƒ—", "ç­", "ä»°", "ç§‹", "ä»²", "ä¼Š", "å®«", "å®", "ä»‡", "æ ¾", "æš´", "ç”˜", "é’­", "å‰", "æˆ", "ç¥–", "æ­¦", "ç¬¦", "åˆ˜", "æ™¯", "è©¹", "æŸ", "é¾™", "å¶", "å¹¸", "å¸", "éŸ¶", "éƒœ", "é»", "è“Ÿ", "è–„", "å°", "å®¿", "ç™½", "æ€€", "è’²", "å°", "ä»", "é„‚", "ç´¢", "å’¸", "ç±", "èµ–", "å“", "è”º", "å± ", "è’™", "æ± ", "ä¹”", "é˜´", "éƒ", "èƒ¥", "èƒ½", "è‹", "åŒ", "é—»", "è˜", "å…š", "ç¿Ÿ", "è°­", "è´¡", "åŠ³", "é€„", "å§¬", "ç”³", "æ‰¶", "å µ", "å†‰", "å®°", "éƒ¦", "é›", "å´", "ç’©", "æ¡‘", "æ¡‚", "æ¿®", "ç‰›", "å¯¿", "é€š", "è¾¹", "æ‰ˆ", "ç‡•", "å†€", "éƒŸ", "æµ¦", "å°š", "å†œ", "æ¸©", "åˆ«", "åº„", "æ™", "æŸ´", "ç¿", "é˜", "å……", "æ…•", "è¿", "èŒ¹", "ä¹ ", "å®¦", "è‰¾", "é±¼", "å®¹", "å‘", "å¤", "æ˜“", "æ…", "æˆˆ", "å»–", "åº¾", "ç»ˆ", "æš¨", "å±…", "è¡¡", "æ­¥", "éƒ½", "è€¿", "æ»¡", "å¼˜", "åŒ¡", "å›½", "æ–‡", "å¯‡", "å¹¿", "ç¦„", "é˜™", "ä¸œ", "æ¬§", "æ²ƒ", "åˆ©", "è”š", "è¶Š", "å¤”", "éš†", "å¸ˆ", "å·©", "å", "è‚", "æ™", "å‹¾", "æ•–", "è", "å†·", "è¨¾", "è¾›", "é˜š", "é‚£", "ç®€", "é¥¶", "ç©º", "æ›¾", "æ²™", "æ²™", "ä¹œ", "å…»", "é ", "é¡»", "ä¸°", "å·¢", "å…³", "è’¯", "ç›¸", "æŸ¥", "å", "è†", "çº¢", "æ¸¸", "ç«º", "æƒ", "é€¯", "ç›–", "ç›Š", "æ¡“", "å…¬",
                "æ¬§é˜³", "ä¸Šå®˜", "å®æœ¨", "å¸é©¬", "å·«é©¬", "ä¸œæ–¹", "å®å°", "ä¸Šæœ¬", "æ²™æ±•", "æ±•æœ¬"
            ],
            eraPrefix: "çš‡å¤§å¤©å…ƒæ°¸å»ºå¼€å…‰å’¸æ˜­æ™¯ç»æ´ªæ­£å®æ­¦å˜‰ä¸‡åŒé“å’¸å…‰å®£ä¹¾å¤ä¸­å…´å¤ªå®è‡³å»¶ç†™éš†æ·³å¾·æ–‡ç¥åœ£åº”ä¿åº†",
            eraSuffix: "å¹³å®‰å®šæ²»å¾·åº†å®å’Œå…´ä¸°ç†™æ³°é¡ºä½‘æ˜Œå†å¯åº·ç†™ç»ªç»Ÿæ­£å®åŒ–ç¦ç¥¯ç¥¥æˆä¸šæˆæ­¦çŒ®è®©å®—å¥‰å…ƒæœ”åˆ",
            templeTiers: {
                t1: "æ–‡æ­¦åœ£é«˜æ˜æˆè‹±å®£ç¥æ˜­ç¿å¾·ç« å®šå…‰çœŸè‚ƒç¿¼å®ªæ¡“æ™¯åº„çƒˆæ‡¿",
                t2: "ä»ä¸­å­åº·å®‰æ•¬æ­å…ƒç®€ç©†æ•¬é¡ºæƒ å’Œæ¸©è‰¯æ­ä¿­è®©",
                t3: "å¹³å®šé–åº·å®åƒ–é¡·æ€€æ•å¨çµ",
                t4: "æ€æ®‡æ„å“€æ‚¼å¹½å‰ç‚€æƒ‘" // äº¡å›½å›ä¸“ç”¨
            }
        };

        const usedData = {
            dynasties: new Set(),
            eraNames: new Set(),
            templeNames: new Set(),
            templeFullNames: new Set()
        };

        const historyArchive = [];

        let gameState = {
            timerId: null,
            speed: 'normal',
            year: 126,
            dynasty: {
                name: '',
                baseName: '',
                surname: '',
                foundYear: 0,
                monarchs: [],
                events: []
            },
            currentMonarch: {
                name: '',
                temple: null,
                age: 0,
                reignTime: 0,
                maxAge: 0,
                startYear: 0,
                goldenAge: null,
                eraName: '',
                totalPowerChange: 0,
                score: 0,
                minScore: 4,
                minPower: 100,
                tags: []
            },
            politics: { public: 70, court: 70, monarch: 70, military: 70 },
            era: { name: '', year: 1 },
            stats: { power: 0, battles: 0, wins: 0 },
            cards: [],
            nextCardId: 1,
            tempCreation: {},
            activeBadge: null,
            shengshiLogged: false,
            statFreeze: { active: false, yearsLeft: 0 },
            countdownTimer: null,
            countdownVal: 60
        };

        // --- è¾…åŠ©å‡½æ•° ---
        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function randomCharFrom(str) { return str.charAt(randomInt(0, str.length - 1)); }

        function generateUnique(set, generatorFn) {
            let attempt;
            let safety = 0;
            do {
                attempt = generatorFn();
                safety++;
                if (safety > 500) break;
            } while (set.has(attempt));
            set.add(attempt);
            return attempt;
        }

        function getDynastyNameObj() {
            return generateUnique(usedData.dynasties, () => {
                const char = randomCharFrom("èµµé’±å­™æå‘¨å´éƒ‘ç‹å†¯é™ˆè¤šå«è’‹æ²ˆéŸ©æ¨æœ±ç§¦å°¤è®¸ä½•å•æ–½å¼ å­”æ›¹ä¸¥åé‡‘é­é™¶å§œæˆšè°¢é‚¹å–»æŸæ°´çª¦ç« äº‘è‹æ½˜è‘›å¥šèŒƒå½­éƒé²éŸ¦æ˜Œé©¬è‹—å‡¤èŠ±æ–¹ä¿ä»»è¢æŸ³é…†é²å²å”è´¹å»‰å²‘è–›é›·è´ºå€ªæ±¤æ»•æ®·ç½—æ¯•éƒå®‰å¸¸ä¹äºæ—¶å‚…çš®åé½åº·ä¼ä½™å…ƒåœé¡¾å­Ÿå¹³é»„å’Œç©†è§å°¹å§šé‚µæ¹›æ±ªç¥æ¯›ç¦¹ç‹„ç±³è´æ˜è‡§è®¡ä¼æˆæˆ´è°ˆå®‹èŒ…åºç†Šçºªèˆ’å±ˆé¡¹ç¥è‘£æ¢æœé˜®è“é—µå¸­å­£éº»å¼ºè´¾è·¯å¨„å±æ±Ÿç«¥é¢œéƒ­æ¢…ç››æ—åˆé’Ÿå¾é‚±éª†é«˜å¤è”¡ç”°æ¨Šèƒ¡å‡Œéœä¸‡æŸ¯å¢è«æˆ¿ç¼ªå¹²è§£åº”å®—ä¸å®£é‚“éƒå•æ­æ´ªåŒ…è¯¸å·¦çŸ³å´”å‰é’®é¾šç¨‹åµ‡é‚¢æ»‘è£´é™†è£ç¿è€ç¾Šæ–¼æƒ å®¶å°èŠ®ç¾¿å‚¨æ™‹æ±²é‚´ç³œæ¾äº•æ®µå¯Œå·«ä¹Œç„¦å·´å¼“ç‰§éš—å±±è°·è½¦ä¾¯å®“è“¬å…¨éƒ—ç­ä»°ç§‹ä»²ä¼Šå®«å®ä»‡æ ¾æš´ç”˜é’­å‰æˆç¥–æ­¦ç¬¦åˆ˜æ™¯è©¹æŸé¾™å¶å¹¸å¸éŸ¶éƒœé»è“Ÿè–„å°å®¿ç™½æ€€è’²å°ä»é„‚ç´¢å’¸ç±èµ–å“è”ºå± è’™æ± ä¹”é˜´éƒèƒ¥èƒ½è‹åŒé—»è˜å…šç¿Ÿè°­è´¡åŠ³é€„å§¬ç”³æ‰¶å µå†‰å®°éƒ¦é›å´ç’©æ¡‘æ¡‚æ¿®ç‰›å¯¿é€šè¾¹æ‰ˆç‡•å†€éƒŸæµ¦å°šå†œæ¸©åˆ«åº„æ™æŸ´ç¿é˜å……æ…•è¿èŒ¹ä¹ å®¦è‰¾é±¼å®¹å‘å¤æ˜“æ…æˆˆå»–åº¾ç»ˆæš¨å±…è¡¡æ­¥éƒ½è€¿æ»¡å¼˜åŒ¡å›½æ–‡å¯‡å¹¿ç¦„é˜™ä¸œæ¬§æ²ƒåˆ©è”šè¶Šå¤”éš†å¸ˆå·©åè‚æ™å‹¾æ•–èå†·è¨¾è¾›é˜šé‚£ç®€é¥¶ç©ºæ›¾æ²™æ²™ä¹œå…»é é¡»ä¸°å·¢å…³è’¯ç›¸æŸ¥åè†çº¢æ¸¸ç«ºæƒé€¯ç›–ç›Šæ¡“å…¬");
                return { fullName: char + 'æœ', baseName: char };
            });
        }

        function getSurname() {
            return CONFIG.surnames[randomInt(0, CONFIG.surnames.length - 1)];
        }

        function getGivenName() {
            const first = randomCharFrom(CONFIG.givenNameFirst);
            if (Math.random() < 0.5) {
                return first + randomCharFrom(CONFIG.givenNameSecond);
            }
            return first;
        }

        function getEraName() {
            return generateUnique(usedData.eraNames, () => {
                const p = randomCharFrom(CONFIG.eraPrefix);
                let s;
                do {
                    s = randomCharFrom(CONFIG.eraSuffix);
                } while (s === p);
                return p + s;
            });
        }

        function generateTempleName(score, isFounder, isLastEmperor) {
            const prefix = gameState.dynasty.baseName;
            if (isFounder) return { full: prefix + 'å¤ªç¥–', char: 'å¤ªç¥–' };

            let pool = "";
            if (isLastEmperor) {
                pool = CONFIG.templeTiers.t4;
            } else {
                if (score >= 8) pool = CONFIG.templeTiers.t1;
                else if (score >= 4) pool = CONFIG.templeTiers.t2;
                else pool = CONFIG.templeTiers.t3;
            }

            let middleChar;
            let safety = 0;
            do {
                if (safety > 50) pool += CONFIG.templeTiers.t2;
                middleChar = randomCharFrom(pool);
                safety++;
            } while (usedData.templeNames.has(middleChar) && safety < 100);

            usedData.templeNames.add(middleChar);
            return { full: prefix + middleChar + 'å®—', char: middleChar + 'å®—' };
        }

        function getStatusLevel(value) {
            if (value >= 75) return { label: 'ä¼˜', class: 'status-excellent', score: 75, tier: 1 };
            if (value >= 50) return { label: 'è‰¯', class: 'status-good', score: 50, tier: 2 };
            if (value >= 25) return { label: 'å·®', class: 'status-poor', score: -50, tier: 3 };
            return { label: 'å±', class: 'status-critical', score: -75, tier: 4 };
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 2000);
        }

        function showStickyToast(id, message) {
            const container = document.getElementById('toast-container');
            let toast = document.getElementById(id);
            if (!toast) {
                toast = document.createElement('div');
                toast.id = id;
                toast.className = 'toast-sticky';
                container.appendChild(toast);
            }
            toast.innerText = message;
        }
        function removeStickyToast(id) {
            const t = document.getElementById(id);
            if (t) t.remove();
        }

        // --- å¡ç‰Œç³»ç»Ÿ ---
        function tryDrawCard() {
            const types = [
                { type: 'monarch', name: 'å›ä¸»åŠ æŒ', desc: 'å›ä¸»çŠ¶æ€+20%', color: '#effaf6' },
                { type: 'court', name: 'æ•´é¡¿æœçº²', desc: 'æœå»·çŠ¶æ€+20%', color: '#fdfbfd' },
                { type: 'military', name: 'å¼ºå†›è®¡åˆ’', desc: 'å†›å¿ƒçŠ¶æ€+20%', color: '#fff9e6' },
                { type: 'public', name: 'å¤§èµ¦å¤©ä¸‹', desc: 'æ°‘å¿ƒçŠ¶æ€+20%', color: '#f0fff4' },
                { type: 'gamble', name: 'èµŒå›½è¿', desc: 'å…¨çŠ¶æ€ Â±30%', color: '#fff0f0' },
                { type: 'exchange', name: 'å–é•¿è¡¥çŸ­', desc: 'æœ€é«˜-20% æœ€ä½+20%', color: '#eef6fc' },
                { type: 'power', name: 'ä¸¾å›½ä¹‹åŠ›', desc: 'å›½åŠ›-10% æœ€ä½+20%', color: '#f0fdf4' },
                { type: 'freeze', name: 'å¤©ä¸‹å¤§å®š', desc: 'çŠ¶æ€é”å®š10å¹´', color: '#f8f9fa' },
                { type: 'depose', name: 'åºŸç«‹å¤©å­', desc: 'åºŸé»œçš‡å¸ éšæœºæ–°å›', color: '#eaecee' }
            ];

            const picked = types[randomInt(0, types.length - 1)];
            const newCard = {
                id: gameState.nextCardId++,
                ...picked,
                yearsLeft: randomInt(30, 60)
            };

            gameState.cards.push(newCard);
            updateCardBadge();
            showToast(`è·å¾—å¡ç‰Œï¼š${newCard.name}`);
        }

        function useCard(id) {
            const idx = gameState.cards.findIndex(c => c.id === id);
            if (idx === -1) return;
            const card = gameState.cards[idx];
            let msg = '';
            let used = true;

            const modifyStat = (key, val) => {
                gameState.politics[key] = Math.min(100, Math.max(0, gameState.politics[key] + val));
            };

            const getMinMaxStat = () => {
                const keys = ['monarch', 'court', 'military', 'public'];
                let minK = keys[0], maxK = keys[0];
                keys.forEach(k => {
                    if (gameState.politics[k] < gameState.politics[minK]) minK = k;
                    if (gameState.politics[k] > gameState.politics[maxK]) maxK = k;
                });
                return { minK, maxK };
            };

            if (card.type === 'freeze') {
                gameState.statFreeze = { active: true, yearsLeft: 10 };
                msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼çŠ¶æ€é”å®š10å¹´';
                logEvent('å¡ç‰Œ', 'ä½¿ç”¨ å¤©ä¸‹å¤§å®šï¼Œå››æµ·å‡å¹³ï¼Œå›½ç­–æš‚ç¼“ã€‚', '#2980b9');
            } else if (card.type === 'depose') {
                msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼çš‡å¸è¢«åºŸ';
                logEvent('å¡ç‰Œ', `${gameState.currentMonarch.eraName}å¸ è¢«åºŸï¼Œæ–°å›ç»§ä½ã€‚`, '#c0392b');
                gameState.currentMonarch.tags.push('åºŸé»œ');
                finalizeMonarchData();
                newMonarch(false, null, false); // false implies standard accession log
                gameState.politics.monarch = randomInt(50, 80);
            } else if (card.type === 'exchange') {
                const { minK, maxK } = getMinMaxStat();
                modifyStat(maxK, -20);
                modifyStat(minK, 20);
                msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼å–é•¿è¡¥çŸ­';
                logEvent('å¡ç‰Œ', 'ä½¿ç”¨ å–é•¿è¡¥çŸ­ï¼ŒæŸæœ‰ä½™è€Œè¡¥ä¸è¶³ã€‚', '#2980b9');
            } else if (card.type === 'power') {
                if (gameState.stats.power < 10) {
                    showToast('å›½åŠ›ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨');
                    return;
                }
                gameState.stats.power -= 10;
                const { minK } = getMinMaxStat();
                modifyStat(minK, 20);
                msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼ä¸¾å›½ä¹‹åŠ›';
                logEvent('å¡ç‰Œ', 'ä½¿ç”¨ ä¸¾å›½ä¹‹åŠ›ï¼Œç‰ºç‰²å›½åŠ›ä»¥è¡¥çŸ­æ¿ã€‚', '#2980b9');
            } else if (card.type === 'gamble') {
                if (Math.random() < 0.5) {
                    ['monarch', 'court', 'military', 'public'].forEach(k => modifyStat(k, 30));
                    msg = 'å›½è¿æ˜Œéš†ï¼æ‰€æœ‰çŠ¶æ€ +30%';
                    logEvent('å¡ç‰Œ', 'ä½¿ç”¨ èµŒå›½è¿ï¼Œå¤©ä½‘å¤§ç»Ÿï¼Œå›½åŠ¿å¤§å¢ï¼', '#27ae60');
                } else {
                    ['monarch', 'court', 'military', 'public'].forEach(k => modifyStat(k, -30));
                    msg = 'å›½è¿è¡°é€€ï¼æ‰€æœ‰çŠ¶æ€ -30%';
                    logEvent('å¡ç‰Œ', 'ä½¿ç”¨ èµŒå›½è¿ï¼Œæ—¶è¿ä¸æµï¼Œå›½åŠ¿è¡°å¾®ã€‚', '#c0392b');
                }
            } else {
                const map = { monarch: 'å›ä¸»', court: 'æœå»·', military: 'å†›å¿ƒ', public: 'æ°‘å¿ƒ' };
                if (map[card.type]) {
                    modifyStat(card.type, 20);
                    msg = `å¡ç‰Œä½¿ç”¨æˆåŠŸï¼${map[card.type]}å¢ç›Š20%`;
                    logEvent('å¡ç‰Œ', `ä½¿ç”¨ ${card.name}ï¼Œ${map[card.type]} æ˜¾è‘—æå‡ã€‚`, '#2980b9');
                }
            }

            if (used) {
                showToast(msg);
                gameState.cards.splice(idx, 1);
                updateCardBadge();
                renderCards();
                updateUI();
            }
        }

        function discardCard(id) {
            const idx = gameState.cards.findIndex(c => c.id === id);
            if (idx !== -1) {
                gameState.cards.splice(idx, 1);
                updateCardBadge();
                renderCards();
            }
        }

        function updateCardBadge() {
            const el = document.getElementById('uiCardBadge');
            const count = gameState.cards.length;
            if (count > 0) {
                el.style.display = 'flex';
                el.innerText = count;
            } else {
                el.style.display = 'none';
            }
        }

        function openCardModal() {
            renderCards();
            openModal('cardModal');
        }

        function showCardDetail(id) {
            const card = gameState.cards.find(c => c.id === id);
            if (card) {
                document.getElementById('detailCardName').innerText = card.name;
                document.getElementById('detailCardDesc').innerText = card.desc;
                openModal('cardDetailModal');
            }
        }

        function renderCards() {
            const list = document.getElementById('cardList');
            const emptyMsg = document.getElementById('noCardMsg');

            if (gameState.cards.length === 0) {
                list.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';

            list.innerHTML = gameState.cards.map(c => `
                <div class="card-item" style="background-color:${c.color};">
                    <div class="card-header">
                        <div class="card-name">${c.name}</div>
                        <button class="btn-card-info" onclick="showCardDetail(${c.id})">?</button>
                    </div>
                    <div>
                        <div class="card-timer">${c.yearsLeft}å¹´åå¤±æ•ˆ</div>
                        <div class="card-actions">
                            <button class="btn-card-use" onclick="useCard(${c.id})">ä½¿ç”¨</button>
                            <button class="btn-card-discard" onclick="discardCard(${c.id})">ä¸¢å¼ƒ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- æ¸¸æˆé€»è¾‘ ---

        function initCreation() {
            openModal('createModal');
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('gameFooter').style.display = 'none';

            usedData.eraNames.clear();
            usedData.templeNames.clear();
            usedData.templeFullNames.clear();

            gameState.tempCreation = { dynastyInfo: null, surname: null };
            rollDynastyName();
            rollSurname();

            gameState.countdownVal = 60;
            const btn = document.getElementById('btnStartGame');
            btn.innerText = `ç™»åŸºå»ºå›½ (${gameState.countdownVal}s)`;

            if (gameState.countdownTimer) clearInterval(gameState.countdownTimer);
            gameState.countdownTimer = setInterval(() => {
                gameState.countdownVal--;
                btn.innerText = `ç™»åŸºå»ºå›½ (${gameState.countdownVal}s)`;
                if (gameState.countdownVal <= 0) {
                    clearInterval(gameState.countdownTimer);
                    startGame();
                }
            }, 1000);
        }

        function rollDynastyName() {
            const dInfo = getDynastyNameObj();
            gameState.tempCreation.dynastyInfo = dInfo;
            document.getElementById('previewDynasty').innerText = dInfo.fullName;
        }

        function rollSurname() {
            const sName = getSurname();
            gameState.tempCreation.surname = sName;
            document.getElementById('previewSurname').innerText = sName;
        }

        function startGame() {
            if (gameState.countdownTimer) clearInterval(gameState.countdownTimer);
            closeModal('createModal');
            document.getElementById('gameUI').style.display = 'flex';
            document.getElementById('gameFooter').style.display = 'flex';

            const dInfo = gameState.tempCreation.dynastyInfo;
            const sName = gameState.tempCreation.surname;

            gameState.dynasty = {
                name: dInfo.fullName,
                baseName: dInfo.baseName,
                surname: sName,
                foundYear: gameState.year,
                monarchs: [],
                events: []
            };
            const startPower = randomInt(50, 80);
            gameState.stats = { power: startPower, battles: 0, wins: 0 };
            gameState.politics = {
                public: randomInt(50, 80),
                court: randomInt(50, 80),
                monarch: randomInt(50, 80),
                military: randomInt(50, 80)
            };

            // Cards persist
            updateCardBadge();

            usedData.eraNames.clear();
            usedData.templeNames.clear();

            gameState.activeBadge = null;
            gameState.shengshiLogged = false;
            gameState.statFreeze = { active: false, yearsLeft: 0 };
            removeStickyToast('freezeToast');

            document.getElementById('uiEventBar').innerHTML = '<div class="event-line" style="color:#999; text-align:center;">æš‚æ— å¤§äº‹ä»¶...</div>';

            newMonarch(true);

            updateUI();
            startTimer();
        }

        function newMonarch(isFounder, forcedEraName = null, isDeposed = false) {
            gameState.shengshiLogged = false;
            gameState.activeBadge = null;

            const surname = gameState.dynasty.surname;
            const givenName = getGivenName();
            const age = isFounder ? randomInt(25, 50) : randomInt(10, 50);
            const eraStr = forcedEraName || getEraName();

            // Name without space
            const fullName = surname + givenName;

            gameState.currentMonarch = {
                name: fullName,
                temple: null,
                age: age,
                reignTime: 0,
                maxAge: Math.min(90, age + randomInt(10, 50)),
                startYear: gameState.year,
                goldenAge: null,
                eraName: eraStr,
                totalPowerChange: 0,
                score: 0,
                tags: [],
                minScore: 4,
                minPower: gameState.stats.power
            };
            if (gameState.currentMonarch.maxAge > 90) gameState.currentMonarch.maxAge = 90;

            gameState.era = {
                name: eraStr,
                year: 1
            };

            gameState.dynasty.monarchs.push({
                ...gameState.currentMonarch,
                endYear: null
            });

            updateLineageBtn();

            if (isFounder) {
                logEvent('å»ºå›½', `${gameState.currentMonarch.name} äºå…¬å…ƒ ${gameState.year} å¹´ç§°å¸ï¼Œå›½å· ${gameState.dynasty.baseName}ï¼Œå²ç§° ${eraStr}å¸ã€‚`);
            } else {
                // Deposed or Normal succession uses same format
                logEvent('ç™»åŸº', `${gameState.currentMonarch.name} ç»§ä½ï¼Œæ”¹å…ƒ ${gameState.era.name}ï¼Œå²ç§° ${gameState.era.name}å¸ï¼Œæ—¶å¹´ ${age} å²ã€‚`);
            }
        }

        function updateLineageBtn() {
            const count = Math.max(0, gameState.dynasty.monarchs.length - 1);
            document.getElementById('btnLineage').innerText = `è°±ç³»${count}`;
        }

        function startTimer() {
            if (gameState.timerId) clearInterval(gameState.timerId);
            const interval = gameState.speed === 'normal' ? CONFIG.speeds.normal : CONFIG.speeds.fast;
            gameState.timerId = setInterval(tick, interval);
            updateSpeedBtn();
        }

        function toggleSpeed() {
            gameState.speed = gameState.speed === 'normal' ? 'fast' : 'normal';
            startTimer();
        }
        function updateSpeedBtn() {
            const btn = document.getElementById('speedBtn');
            if (gameState.speed === 'fast') {
                btn.innerText = '2x é€Ÿ'; btn.classList.add('active-5x');
            } else {
                btn.innerText = '1x é€Ÿ'; btn.classList.remove('active-5x');
            }
        }

        function tick() {
            gameState.year++;
            gameState.era.year++;
            gameState.currentMonarch.reignTime++;
            gameState.currentMonarch.age++;

            gameState.stats.power -= 1;

            let isFrozen = false;
            if (gameState.statFreeze.active) {
                isFrozen = true;
                gameState.statFreeze.yearsLeft--;
                showStickyToast('freezeToast', `å¡ç‰Œ:å¤©ä¸‹å¤§å®š * å‰©ä½™ ${gameState.statFreeze.yearsLeft} å¹´`);
                if (gameState.statFreeze.yearsLeft <= 0) {
                    gameState.statFreeze.active = false;
                    removeStickyToast('freezeToast');
                }
            }

            if (!isFrozen && gameState.year % 5 === 0) {
                applyStatusFluctuation();
            }

            // Cards every 10 years (100%)
            if (gameState.year % 10 === 0) {
                tryDrawCard();
            }

            for (let i = gameState.cards.length - 1; i >= 0; i--) {
                gameState.cards[i].yearsLeft--;
                if (gameState.cards[i].yearsLeft <= 0) gameState.cards.splice(i, 1);
            }
            updateCardBadge();
            if (document.getElementById('cardModal').classList.contains('active')) renderCards();

            let polyProb = 0.1;
            if (gameState.stats.power >= 90) polyProb = 0.2;
            if (!isFrozen && Math.random() < polyProb) {
                handlePoliticalEvent();
            }

            const pScore = getStatusLevel(gameState.politics.public).score;
            const cScore = getStatusLevel(gameState.politics.court).score;
            const mScore = getStatusLevel(gameState.politics.monarch).score;
            const milScore = getStatusLevel(gameState.politics.military).score;

            const currentMinTier = Math.max(
                getStatusLevel(gameState.politics.public).tier,
                getStatusLevel(gameState.politics.court).tier,
                getStatusLevel(gameState.politics.monarch).tier,
                getStatusLevel(gameState.politics.military).tier
            );
            if (gameState.currentMonarch.reignTime === 1) gameState.currentMonarch.minScore = currentMinTier;
            else if (currentMinTier > gameState.currentMonarch.minScore) gameState.currentMonarch.minScore = currentMinTier;

            let powerChange = 0;
            if (!isFrozen) {
                powerChange = Math.floor((pScore + cScore + mScore + milScore) / 30);
                gameState.currentMonarch.totalPowerChange += powerChange;
                gameState.stats.power += powerChange;
            }

            if (gameState.stats.power > 100) gameState.stats.power = 100;
            if (gameState.stats.power < 0) gameState.stats.power = 0;

            if (gameState.stats.power < gameState.currentMonarch.minPower) {
                gameState.currentMonarch.minPower = gameState.stats.power;
            }

            checkHistoryBadge();

            let probPlayer = 0.1; if (gameState.stats.power >= 70) probPlayer = 0.2;
            let probEnemy = 0.1; if (gameState.stats.power <= 30) probEnemy = 0.2;
            const roll = Math.random();
            if (roll < probPlayer) handleWar(true);
            else if (roll < (probPlayer + probEnemy)) handleWar(false);

            checkDeath();
            checkCollapse();
            updateUI();
        }

        function applyStatusFluctuation() {
            ['public', 'court', 'monarch', 'military'].forEach(key => {
                const change = randomInt(2, 5);
                const sign = Math.random() < 0.5 ? 1 : -1;
                gameState.politics[key] += (change * sign);
                gameState.politics[key] = Math.min(100, Math.max(0, gameState.politics[key]));
            });
        }

        function handlePoliticalEvent() {
            const rChar1 = randomCharFrom(CONFIG.givenNameFirst);
            const rChar2 = randomCharFrom(CONFIG.givenNameFirst); // ä¸¤ä¸ªéšæœºå­—
            const types = ["æ”¿å˜", "äº‹å˜", "ä¹‹å˜", "å˜æ³•"];
            const type = types[randomInt(0, 3)];
            const name = rChar1 + rChar2 + type;

            let maxChangeVal = 0;
            let maxChangeKey = '';
            let maxChangeSign = 1;

            ['public', 'court', 'monarch', 'military'].forEach(key => {
                const change = randomInt(10, 20);
                const sign = Math.random() < 0.5 ? 1 : -1;
                if (change > maxChangeVal) { maxChangeVal = change; maxChangeKey = key; maxChangeSign = sign; }
                gameState.politics[key] += (change * sign);
                gameState.politics[key] = Math.min(100, Math.max(0, gameState.politics[key]));
            });

            let desc = "";
            if (maxChangeKey === 'public') desc = maxChangeSign > 0 ? "æ°‘å¿ƒå¤§å¢" : "æ°‘æ€¨æ²¸è…¾";
            else if (maxChangeKey === 'court') desc = maxChangeSign > 0 ? "æœçº²è‚ƒæ¸…" : "æƒè‡£å½“é“";
            else if (maxChangeKey === 'military') desc = maxChangeSign > 0 ? "å†›å¨å¤§æŒ¯" : "å†›å¿ƒæ¶£æ•£";
            else desc = maxChangeSign > 0 ? "å¸å¨å¤§æŒ¯" : "å¨ä¸¥æ‰«åœ°";

            logEvent('æ”¿æ²»', `çˆ†å‘ ${name}ï¼Œ${desc}ã€‚`, '#8e44ad');
        }

        function checkHistoryBadge() {
            const duration = gameState.year - gameState.dynasty.foundYear;
            if (duration <= 50) {
                gameState.activeBadge = null;
                return;
            }

            const p = gameState.politics.public;
            const c = gameState.politics.court;
            const m = gameState.politics.monarch;
            const mil = gameState.politics.military;

            let newBadge = null;
            let badgeClass = '';

            if (p >= 80 && c >= 80 && m >= 80 && mil >= 80) {
                newBadge = `${gameState.era.name}ç››ä¸–`;
                badgeClass = "badge-shengshi";
                if (!gameState.shengshiLogged) {
                    logEvent('ç››ä¸–', `å¤©ä¸‹å¤§æ²»ï¼Œå²ç§°ã€Œ${newBadge}ã€ã€‚`, '#f1c40f');
                    gameState.shengshiLogged = true;
                    if (!gameState.currentMonarch.tags.includes(newBadge)) gameState.currentMonarch.tags.push(newBadge);
                }
            } else {
                const currentTier = Math.max(
                    getStatusLevel(p).tier, getStatusLevel(c).tier, getStatusLevel(m).tier, getStatusLevel(mil).tier
                );

                if (gameState.currentMonarch.reignTime >= 10 &&
                    gameState.currentMonarch.minScore >= 3 &&
                    currentTier === 1) {

                    newBadge = `${gameState.era.name}ä¸­å…´`;
                    badgeClass = "badge-zhongxing";
                    if (!gameState.currentMonarch.tags.includes(newBadge)) {
                        gameState.currentMonarch.tags.push(newBadge);
                        logEvent('ä¸­å…´', `åŠ›æŒ½ç‹‚æ¾œï¼Œå²ç§°ã€Œ${newBadge}ã€ã€‚`, '#8e44ad');
                    }
                }
            }

            if (!newBadge) {
                if (p < 30 && c < 30 && m < 30 && mil < 30) { newBadge = "å±åœ¨æ—¦å¤•"; badgeClass = "badge-danger"; }
                else if (m < 30) { newBadge = "æ˜å›å½“æœ"; badgeClass = "badge-danger"; }
                else if (c < 30) { newBadge = "æœå±€åŠ¨è¡"; badgeClass = "badge-danger"; }
                else if (mil < 30) { newBadge = "å†›å¿ƒæ¶£æ•£"; badgeClass = "badge-danger"; }
                else if (p < 30) { newBadge = "æ°‘ä¸èŠç”Ÿ"; badgeClass = "badge-danger"; }
                else if (m >= 90 && p > 30 && c > 30 && mil > 30) { newBadge = "è‰¯å›æ²»å›½"; badgeClass = "badge-good"; }
                else if (p >= 90 && m > 30 && c > 30 && mil > 30) { newBadge = "æ°‘å¿ƒæ‰€å‘"; badgeClass = "badge-good"; }
            }

            gameState.activeBadge = newBadge ? { text: newBadge, css: badgeClass } : null;
        }

        function handleWar(isPlayerInitiator) {
            const initiator = isPlayerInitiator ? "æˆ‘æ–¹" : "æ•Œæ–¹";
            const monarchVal = gameState.politics.monarch;
            const powerScore = gameState.stats.power;
            const winChance = (monarchVal * 0.4) + (powerScore * 0.6);
            const isWin = Math.random() * 100 < winChance;

            gameState.stats.battles++;

            if (isWin) {
                gameState.stats.wins++;
                const gain = randomInt(2, 5);
                gameState.stats.power = Math.min(100, gameState.stats.power + gain);
                const winDescList = ["ç¼´è·å¤§é‡ç‰©èµ„", "è·å¾—å‰æœé—ç•™æŠ€æœ¯", "æ•Œå›½èµ”æ¬¾æ±‚å’Œ", "æ”¶å¤åŒ—æ–¹å¤±åœ°", "æ‹“åœŸå¼€ç–†", "å¨éœ‡å››æ–¹"];
                const desc = winDescList[randomInt(0, winDescList.length - 1)];
                logEvent('å¤§æ·', `${initiator} å‘èµ·æˆ˜å½¹ï¼Œ${desc}ï¼å›½åŠ› +${gain}%`);
            } else {
                const loss = randomInt(2, 5);
                gameState.stats.power = Math.max(0, gameState.stats.power - loss);
                const loseDescList = ["è¢«è¿«å‰²è®©è¾¹éƒ¡", "å›½åº“èµ”æ¬¾", "è¾¹é˜²å†›æ­»ä¼¤æƒ¨é‡", "é˜²çº¿æºƒè´¥", "ä¸§å¸ˆè¾±å›½", "ä¸¢å¤±é‡é•‡"];
                const desc = loseDescList[randomInt(0, loseDescList.length - 1)];
                logEvent('æˆ˜è´¥', `${initiator} å‘èµ·æˆ˜å½¹ï¼Œ${desc}ã€‚å›½åŠ› -${loss}%`);
            }
        }

        function finalizeMonarchData(isDynastyEnd = false) {
            const m = gameState.currentMonarch;
            if (m.reignTime >= 10) m.score = Math.floor(m.totalPowerChange / m.reignTime);
            else m.score = 0;

            const isFounder = (gameState.dynasty.monarchs.length === 1);
            const templeObj = generateTempleName(m.score, isFounder, isDynastyEnd);
            m.temple = templeObj.full;

            const idx = gameState.dynasty.monarchs.length - 1;
            if (idx >= 0) {
                const finalData = { ...m };
                finalData.endYear = gameState.year;
                gameState.dynasty.monarchs[idx] = finalData;
            }
            return m.temple;
        }

        function checkDeath() {
            const m = gameState.currentMonarch;
            if (m.age >= m.maxAge || m.age >= 90) {
                const finalTemple = finalizeMonarchData(false);
                logEvent('é©¾å´©', `${m.eraName}å¸ é©¾å´©ï¼Œç¾¤è‡£ä¸Šè°¥ï¼Œåº™å· ${finalTemple}ï¼Œäº«å¹´ ${m.age} å²ã€‚`);
                newMonarch(false);
            }
        }

        function checkCollapse() {
            if (gameState.stats.power <= 0) {
                finalizeMonarchData(true);
                gameOver();
            }
        }

        function logEvent(type, content, color) {
            let yearDisplay = `${gameState.era.name}${gameState.era.year}å¹´`;
            if (gameState.era.year === 1) yearDisplay = `${gameState.era.name}å…ƒå¹´`;
            const typeColor = color || ((type === 'äº¡å›½' || type === 'æˆ˜è´¥' || type === 'é©¾å´©') ? '#c0392b' : '#2c3e50');
            const logEntry = { year: yearDisplay, type, content, fullYear: gameState.year, color: typeColor };
            gameState.dynasty.events.unshift(logEntry);

            const bar = document.getElementById('uiEventBar');
            const e1 = gameState.dynasty.events[0];
            const e2 = gameState.dynasty.events[1];
            let html = '';
            if (e1) html += `<div class="event-line"><span class="typing-anim"><span style="font-weight:bold; color:${e1.color}; margin-right:4px;">[${e1.type}]</span>${e1.year}: ${e1.content}</span></div>`;
            if (e2) html += `<div class="event-line"><span style="font-weight:bold; color:${e2.color}; margin-right:4px;">[${e2.type}]</span>${e2.year}: ${e2.content}</div>`;
            bar.innerHTML = html;
        }

        function updateUI() {
            document.getElementById('currentYearDisplay').innerText = `å…¬å…ƒ ${gameState.year} å¹´`;
            document.getElementById('uiDynastyName').innerText = gameState.dynasty.name;
            document.getElementById('uiFoundYear').innerText = `å…¬å…ƒ ${gameState.dynasty.foundYear} å¹´`;
            document.getElementById('uiDuration').innerText = gameState.year - gameState.dynasty.foundYear;

            const m = gameState.currentMonarch;
            let eraText = gameState.era.year === 1 ? `${gameState.era.name}å…ƒå¹´` : `${gameState.era.name}${gameState.era.year}å¹´`;
            document.getElementById('uiEraName').innerText = eraText;
            document.getElementById('uiMonarchName').innerText = `${m.eraName}å¸ ${m.name}`;
            document.getElementById('uiMonarchAge').innerText = m.age;
            document.getElementById('uiReignDuration').innerText = m.reignTime;

            const powerEl = document.getElementById('uiPower');
            powerEl.innerText = gameState.stats.power + '%';
            powerEl.className = 'stat-value' + (gameState.stats.power < 30 ? ' status-critical' : '');

            document.getElementById('uiBattleStats').innerText = `${gameState.stats.battles} / ${gameState.stats.wins}`;

            updateStatusBox('uiMonarchState', gameState.politics.monarch);
            updateStatusBox('uiCourt', gameState.politics.court);
            updateStatusBox('uiPublic', gameState.politics.public);
            updateStatusBox('uiMilitary', gameState.politics.military);

            const badgeEl = document.getElementById('uiHistoryBadge');
            const duration = gameState.year - gameState.dynasty.foundYear;

            if (duration <= 50) {
                badgeEl.className = 'history-badge-card';
                badgeEl.innerText = 'å¾…è§£é” (å›½ç¥š>50å¹´)';
                badgeEl.style.color = '#ccc';
                badgeEl.style.border = '1px dashed #ddd';
                badgeEl.style.background = 'var(--card-bg)';
            } else if (gameState.activeBadge) {
                badgeEl.className = `history-badge-card active ${gameState.activeBadge.css}`;
                badgeEl.innerText = gameState.activeBadge.text;
                badgeEl.style = '';
            } else {
                badgeEl.className = 'history-badge-card active';
                badgeEl.innerText = 'å¹³ç¨³å‘å±•';
                badgeEl.style.color = '#7f8c8d';
                badgeEl.style.border = '1px solid #bdc3c7';
                badgeEl.style.background = '#fff';
            }
        }

        function updateStatusBox(id, value) {
            const el = document.getElementById(id);
            const status = getStatusLevel(value);
            el.innerHTML = `<span class="${status.class}">${status.label} <small style="font-size:12px; opacity:0.7">(${Math.round(value)}%)</small></span>`;
        }

        // --- å¼¹çª—é€»è¾‘ ---

        function openLiveLineage() {
            const list = document.getElementById('lineageList');
            const pastMonarchs = gameState.dynasty.monarchs.slice(0, gameState.dynasty.monarchs.length - 1);

            let totalScore = 0;
            pastMonarchs.forEach(m => totalScore += m.score);
            let avg = pastMonarchs.length > 0 ? (totalScore / pastMonarchs.length).toFixed(1) : 0;
            document.getElementById('uiTotalScore').innerText = totalScore;
            document.getElementById('uiAvgScore').innerText = avg;

            if (pastMonarchs.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— å…ˆå¸è°±ç³»</p>';
            } else {
                list.innerHTML = pastMonarchs.map(m => {
                    let tagsHtml = '';
                    if (m.tags && m.tags.length > 0) {
                        m.tags.forEach(t => {
                            if (t.includes('ç››ä¸–')) tagsHtml += `<span class="tag-shengshi">${t}</span>`;
                            else if (t.includes('ä¸­å…´')) tagsHtml += `<span class="tag-zhongxing">${t}</span>`;
                            else if (t.includes('åºŸé»œ')) tagsHtml += `<span class="tag-feichu">${t}</span>`;
                            else tagsHtml += `<span>${t}</span>`;
                        });
                    }
                    return `
                    <div class="lineage-row">
                        <div style="font-size:13px; font-weight:bold; color:#2c3e50; display:flex; justify-content:space-between;">
                            <span>${m.temple || m.eraName + 'å¸'} ${m.name}</span>
                            <span style="font-weight:normal; color:#7f8c8d; font-size:12px;">[${m.eraName}] äº«å¹´ ${m.age}</span>
                        </div>
                        <div style="font-size:12px; color:#555; display:flex; justify-content:space-between; margin-top:2px;">
                            <span>åœ¨ä½ ${m.reignTime} å¹´ (${m.startYear}-${m.endYear}) <small style="color:var(--score-color)">åˆ†å€¼ï¼š${m.score}</small></span>
                            <div>${tagsHtml}</div>
                        </div>
                    </div>
                `}).join('');
            }
            openModal('lineageModal');
        }

        function gameOver() {
            clearInterval(gameState.timerId);
            gameState.timerId = null;

            const duration = gameState.year - gameState.dynasty.foundYear;
            logEvent('äº¡å›½', `å›½åŠ›è€—å°½ï¼Œ${gameState.dynasty.name} ç­äº¡ã€‚`);

            let totalScore = 0;
            gameState.dynasty.monarchs.forEach(m => totalScore += m.score);
            let avg = gameState.dynasty.monarchs.length > 0 ? (totalScore / gameState.dynasty.monarchs.length).toFixed(1) : 0;

            const archiveEntry = {
                dynastyName: gameState.dynasty.name,
                foundYear: gameState.dynasty.foundYear,
                endYear: gameState.year,
                duration: duration,
                monarchCount: gameState.dynasty.monarchs.length,
                battles: gameState.stats.battles,
                wins: gameState.stats.wins,
                monarchs: [...gameState.dynasty.monarchs],
                events: [...gameState.dynasty.events],
                totalScore: totalScore,
                avgScore: avg
            };
            historyArchive.unshift(archiveEntry);

            document.getElementById('goDynastyName').innerText = gameState.dynasty.name;
            document.getElementById('goDuration').innerText = duration;
            document.getElementById('goMonarchCount').innerText = archiveEntry.monarchCount;

            openModal('gameOverModal');
        }

        function resetToCreation() {
            closeModal('gameOverModal');
            initCreation();
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'gameOverModal') return;
                    overlay.classList.remove('active');
                    if (overlay.id === 'createModal' && document.getElementById('gameUI').style.display === 'none') {
                        overlay.classList.add('active');
                    }
                }
            });
        });

        function openEventLog() {
            const list = document.getElementById('fullEventLog');
            list.innerHTML = gameState.dynasty.events.map(e => `
                <p>
                    <span class="log-year">${e.year}</span>
                    <span style="color:${e.color}">[${e.type}]</span> 
                    ${e.content}
                </p>
            `).join('');
            openModal('eventModal');
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            if (historyArchive.length === 0) {
                list.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">æš‚æ— å†å²æœä»£</li>';
            } else {
                list.innerHTML = historyArchive.map((h, index) => `
                    <li class="history-item-wrap">
                        <div class="history-item">
                            <div>
                                <span style="font-weight:bold; font-size:16px;">${h.dynastyName}</span>
                                <span style="font-size:12px; color:#666; margin-left:8px;">(${h.foundYear} - ${h.endYear})</span>
                            </div>
                            <div>
                                <span style="font-size:12px;">${h.duration}å¹´</span>
                                <span class="btn-more" onclick="toggleHistoryDetail(${index})">æ›´å¤š</span>
                            </div>
                        </div>
                        <div class="history-details" id="hist-detail-${index}">
                            <div style="font-size:12px; color:#555; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:4px;">
                                å†ç» ${h.monarchCount} ä½å¸ç‹ &nbsp;|&nbsp; æˆ˜å½¹/æˆ˜èƒœï¼š${h.battles}/${h.wins} &nbsp;|&nbsp; 
                                æ€»åˆ†ï¼š${h.totalScore} (å‡ ${h.avgScore})
                            </div>
                            <div style="margin-top:8px; max-height:150px; overflow-y:auto;">
                                ${h.monarchs.map(m => {
                    let tagsHtml = '';
                    if (m.tags) m.tags.forEach(t => {
                        if (t.includes('ç››ä¸–')) tagsHtml += `<span class="tag-shengshi">${t}</span>`;
                        else if (t.includes('ä¸­å…´')) tagsHtml += `<span class="tag-zhongxing">${t}</span>`;
                        else if (t.includes('åºŸé»œ')) tagsHtml += `<span class="tag-feichu">${t}</span>`;
                        else tagsHtml += `<span>${t}</span>`;
                    });
                    return `
                                    <div style="font-size:12px; margin-bottom:6px; border-bottom:1px dashed #eee; padding-bottom:4px;">
                                        <div><strong>${m.temple || m.eraName + 'å¸'}</strong> ${m.name} <span style="color:#7f8c8d; font-size:11px;">(äº«å¹´${m.age})</span></div>
                                        <div style="color:#555;">[${m.eraName}] åœ¨ä½${m.reignTime}å¹´ <small style="color:var(--score-color)">åˆ†å€¼ï¼š${m.score}</small></div>
                                        <div>${tagsHtml}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </li>
                `).join('');
            }
            openModal('historyModal');
        }

        function toggleHistoryDetail(index) {
            const el = document.getElementById(`hist-detail-${index}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function createWatermark() {
            const div = document.createElement('div');
            div.className = 'watermark';
            div.innerText = '@çŒç¡çŒ«';
            const w = window.innerWidth;
            const h = window.innerHeight;
            const x = Math.random() * (w - 60);
            const y = Math.random() * (h - 20);
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            document.body.appendChild(div);
            setTimeout(() => { if (div.parentNode) div.remove(); }, 10000);
        }

        setInterval(createWatermark, 60000);
        setTimeout(createWatermark, 1000);

        initCreation();

    </script>
</body>

</html>
