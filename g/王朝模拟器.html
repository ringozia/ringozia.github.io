<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‹æœæ¨¡æ‹Ÿå™¨</title>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent: #c0392b;
            /* æ·±çº¢/å±æœº */
            --success: #27ae60;
            /* ç»¿è‰²/å®‰å…¨ */
            --gold: #f1c40f;
            /* é‡‘è‰²/ç››ä¸– */
            --score-color: #2980b9;
            /* åˆ†å€¼é¢œè‰² */
            --border: #e0e0e0;
            --btn-bg: #2980b9;
            --btn-text: #fff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        header {
            height: 50px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
            font-weight: bold;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-title {
            font-size: 16px;
        }

        .btn-help {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--text-main);
            background: none;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .btn-history {
            padding: 4px 10px;
            background: none;
            border: 1px solid var(--text-main);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* æ ¸å¿ƒä¿¡æ¯åŒº */
        main {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .dynasty-name {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .dynasty-info {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .monarch-section {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            position: relative;
        }

        .era-name {
            font-size: 18px;
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 4px;
        }

        .monarch-name-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .monarch-name {
            font-size: 18px;
            font-weight: bold;
        }

        .btn-lineage {
            font-size: 11px;
            padding: 2px 6px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            color: var(--text-main);
            cursor: pointer;
            white-space: nowrap;
        }

        .monarch-stats {
            font-size: 13px;
            color: var(--text-sub);
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* æ•°å€¼é¢æ¿ */
        .stats-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stats-grid-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* çŠ¶æ€è¡Œ (å››åˆ—) */
        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
        }

        .stat-box {
            background: var(--card-bg);
            padding: 10px 2px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
        }

        /* çŠ¶æ€é¢œè‰²ç±» */
        .status-excellent {
            color: var(--success);
        }

        /* ä¼˜ */
        .status-good {
            color: var(--btn-bg);
        }

        /* è‰¯ */
        .status-poor {
            color: #e67e22;
        }

        /* å·® */
        .status-critical {
            color: var(--accent);
        }

        /* å± */

        /* å†å²åç‰Œå¡ç‰‡ */
        .history-badge-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: #888;
            border: 1px dashed #ddd;
        }

        .history-badge-card.active {
            border: 2px solid var(--text-main);
            color: var(--text-main);
            background: #fff;
        }

        .badge-shengshi {
            border-color: var(--gold) !important;
            color: #d4ac0d !important;
            background: #fef9e7 !important;
        }

        .badge-danger {
            border-color: var(--accent) !important;
            color: var(--accent) !important;
            background: #fdedec !important;
        }

        .badge-good {
            border-color: var(--success) !important;
            color: var(--success) !important;
            background: #eafaf1 !important;
        }

        /* åº•éƒ¨ */
        footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 10px 16px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        /* åº•éƒ¨äº‹ä»¶æ  */
        .event-bar {
            height: 52px;
            background: #f0f2f5;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            overflow: hidden;
            color: var(--text-main);
            position: relative;
        }

        .event-line {
            width: 100%;
            height: 20px;
            line-height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æ‰“å­—æœºåŠ¨ç”» (2s) */
        .typing-anim {
            display: inline;
            vertical-align: top;
            white-space: nowrap;
            animation: typeReveal 2s cubic-bezier(0.1, 0.7, 0.1, 1) forwards;
            clip-path: inset(0 100% 0 0);
        }

        @keyframes typeReveal {
            from {
                clip-path: inset(0 100% 0 0);
            }

            to {
                clip-path: inset(0 0 0 0);
            }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            /* Adjusted for card button */
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 10px;
        }

        .speed-btn,
        .card-btn-trigger {
            background: var(--btn-bg);
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .speed-btn.active-5x {
            background: var(--accent);
        }

        /* å¡ç‰ŒæŒ‰é’®çº¢è‰²æ³¡æ³¡ */
        .card-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            display: none;
            /* é»˜è®¤éšè— */
        }

        /* èƒ¶å›Šæ¶ˆæ¯ (Toast) */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: rgba(44, 62, 80, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInDown 0.3s ease-out, fadeOut 0.3s ease-in 1.7s forwards;
            white-space: nowrap;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* å¼¹çª—é€šç”¨ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* å†å²å¼¹çª—å±‚çº§æœ€é«˜ */
        #historyModal {
            z-index: 200;
        }

        .modal {
            background: var(--card-bg);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        /* äº¡å›½å¼¹çª— æŒ‰é’®ç»„ */
        .modal-footer.game-over-footer {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-secondary {
            padding: 12px;
            background: transparent;
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100px;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-details {
            display: none;
            margin-top: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-more {
            color: var(--btn-bg);
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            text-decoration: underline;
        }

        /* è°±ç³»è¡Œæ ·å¼ */
        .lineage-row {
            font-size: 13px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            color: #2c3e50;
        }

        /* å¡ç‰Œç³»ç»Ÿæ ·å¼ */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .card-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
            text-align: left;
            position: relative;
        }

        .card-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 12px;
            color: #555;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .card-timer {
            font-size: 11px;
            color: #e67e22;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .card-actions {
            display: flex;
            gap: 5px;
        }

        .btn-card-use {
            flex: 1;
            padding: 4px;
            background: var(--btn-bg);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-card-discard {
            flex: 1;
            padding: 4px;
            background: #95a5a6;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* æ–°å»ºæœä»£å¼¹çª— - ç‹¬ç«‹æŒ‰é’®æ ·å¼ */
        .creation-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .creation-label {
            font-size: 14px;
            color: #666;
            width: 40px;
            text-align: left;
        }

        .dice-btn {
            font-size: 20px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 4px;
        }

        .generated-name {
            font-size: 22px;
            font-weight: bold;
            color: var(--accent);
            flex: 1;
            text-align: center;
        }

        .main-btn {
            width: 100%;
            padding: 12px;
            background: var(--btn-bg);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        /* äº‹ä»¶æ—¥å¿—åˆ—è¡¨ */
        .log-list p {
            margin-bottom: 6px;
            font-size: 13px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .log-year {
            font-weight: bold;
            color: var(--text-sub);
            margin-right: 6px;
        }

        /* ç©æ³•è¯´æ˜æ–‡æœ¬ */
        .help-text p {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #444;
        }

        .help-text h3 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 16px;
            color: var(--text-main);
        }

        /* æ°´å°æ ·å¼ */
        .watermark {
            position: fixed;
            pointer-events: none;
            color: rgba(0, 0, 0, 0.15);
            /* åŠé€æ˜ */
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
            /* æœ€é¡¶å±‚ */
            white-space: nowrap;
            user-select: none;
        }
    </style>
</head>

<body>

    <!-- é¡¶éƒ¨æ¶ˆæ¯å®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- æ ‡é¢˜æ  -->
    <header>
        <div class="header-left">
            <div class="header-title">ç‹æœæ¨¡æ‹Ÿå™¨</div>
            <button class="btn-help" onclick="openModal('helpModal')">?</button>
        </div>
        <div class="header-info">
            <span id="currentYearDisplay">å…¬å…ƒ 523 å¹´</span>
            <button class="btn-history" onclick="openHistory()">å†å²</button>
        </div>
    </header>

    <!-- ä¸»ç•Œé¢ -->
    <main id="gameUI" style="display:none;">
        <div class="card">
            <div class="dynasty-name" id="uiDynastyName">--</div>
            <div class="dynasty-info">
                <span>å»ºå›½ <span id="uiFoundYear">--</span></span>
                <span>Â·</span>
                <span>å›½ç¥š <span id="uiDuration">0</span> å¹´</span>
                <button class="btn-lineage" id="btnLineage" onclick="openLiveLineage()">è°±ç³»0</button>
            </div>

            <div class="monarch-section">
                <div class="era-name" id="uiEraName">--</div>
                <div class="monarch-name-row">
                    <div class="monarch-name" id="uiMonarchName">--</div>
                </div>
                <div class="monarch-stats">
                    <span><span id="uiMonarchAge">--</span> å²</span>
                    <span>åœ¨ä½ <span id="uiReignDuration">0</span> å¹´</span>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <!-- é¡¶éƒ¨ï¼šå›½åŠ›ä¸æˆ˜å½¹ -->
            <div class="stats-grid-top">
                <div class="stat-box">
                    <div class="stat-label">å›½åŠ›å€¼</div>
                    <div class="stat-value" id="uiPower">--%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æˆ˜å½¹/èƒœæˆ˜</div>
                    <div class="stat-value" id="uiBattleStats">0 / 0</div>
                </div>
            </div>

            <!-- çŠ¶æ€è¡Œï¼šå›ä¸»ã€æœå»·ã€å†›å¿ƒã€æ°‘å¿ƒ -->
            <div class="status-row">
                <div class="stat-box">
                    <div class="stat-label">å›ä¸»</div>
                    <div class="stat-value" id="uiMonarchState">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æœå»·</div>
                    <div class="stat-value" id="uiCourt">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">å†›å¿ƒ</div>
                    <div class="stat-value" id="uiMilitary">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æ°‘å¿ƒ</div>
                    <div class="stat-value" id="uiPublic">--</div>
                </div>
            </div>

            <!-- å†å²åç‰Œ -->
            <div id="uiHistoryBadge" class="history-badge-card">
                å¾…è§£é” (å›½ç¥š>50å¹´)
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <footer id="gameFooter" style="display:none;">
        <div class="event-bar" id="uiEventBar" onclick="openEventLog()">
            <div class="event-line" style="color:#999; text-align:center;">æš‚æ— å¤§äº‹ä»¶...</div>
        </div>
        <div class="controls">
            <div><!-- Spacer --></div>
            <div class="controls-right">
                <button class="card-btn-trigger" onclick="openCardModal()">
                    å¡ç‰Œ
                    <div class="card-badge" id="uiCardBadge">0</div>
                </button>
                <button class="speed-btn" id="speedBtn" onclick="toggleSpeed()">1x é€Ÿ</button>
            </div>
        </div>
    </footer>

    <!-- 1. æ–°å»ºæœä»£å¼¹çª— -->
    <div id="createModal" class="modal-overlay active">
        <div class="modal">
            <div class="modal-header">å»ºç«‹æ–°æœä»£</div>
            <div class="modal-body" style="text-align: center;">
                <p style="color:#666; margin-bottom:20px;">ç‚¹å‡»éª°å­éšæœºç”Ÿæˆä¿¡æ¯</p>

                <div class="creation-group">
                    <span class="creation-label">å›½å·</span>
                    <span class="generated-name" id="previewDynasty">? ?</span>
                    <button class="dice-btn" onclick="rollDynastyName()">ğŸ²</button>
                </div>

                <div class="creation-group">
                    <span class="creation-label">å›½å§“</span>
                    <span class="generated-name" id="previewSurname">?</span>
                    <button class="dice-btn" onclick="rollSurname()">ğŸ²</button>
                </div>

            </div>
            <div class="modal-footer">
                <button class="main-btn" onclick="startGame()">ç™»åŸºå»ºå›½</button>
            </div>
        </div>
    </div>

    <!-- 2. äº‹ä»¶æ—¥å¿—å¼¹çª— -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>å†å²å¤§äº‹ä»¶</span>
                <span onclick="closeModal('eventModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body log-list" id="fullEventLog">
                <!-- JS å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- 3. å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>å†æœå†ä»£</span>
                <span onclick="closeModal('historyModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body">
                <ul class="history-list" id="historyList">
                    <!-- JS å¡«å…… -->
                </ul>
            </div>
        </div>
    </div>

    <!-- 4. å½“å‰è°±ç³»å¼¹çª— -->
    <div id="lineageModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æœ¬æœå¸ç‹è°±ç³»</span>
                <span onclick="closeModal('lineageModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body" id="lineageList">
                <!-- JS å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- 5. äº¡å›½å¼¹çª— -->
    <div id="gameOverModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header" style="color:var(--accent);">æœä»£ç­äº¡</div>
            <div class="modal-body" style="text-align: center;">
                <h2 id="goDynastyName" style="margin-bottom: 10px;"></h2>
                <p>äº«å›½ <span id="goDuration"></span> å¹´</p>
                <p>å†ç» <span id="goMonarchCount"></span> ä½å¸ç‹</p>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    å›½åŠ›è€—å°½ï¼Œç¤¾ç¨·å´©å¡Œã€‚<br>åäººåªèƒ½åœ¨å²ä¹¦ä¸­çª¥è§å¾€æ—¥è£å…‰ã€‚
                </p>
            </div>
            <div class="modal-footer game-over-footer">
                <button class="btn-secondary" onclick="openHistory()">å†å²</button>
                <button class="main-btn" style="flex:1;" onclick="resetToCreation()">æ–°å»ºæœä»£</button>
            </div>
        </div>
    </div>

    <!-- 6. ç©æ³•è¯´æ˜å¼¹çª— -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æ¸¸æˆç©æ³•</span>
                <span onclick="closeModal('helpModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body help-text">
                <p><strong>æ ¸å¿ƒç›®æ ‡ï¼š</strong> å°½å¯èƒ½å»¶ç»­ç‹æœå¯¿å‘½ï¼Œé¿å…å›½åŠ›å½’é›¶ã€‚</p>
                <h3>âš–ï¸ çŠ¶æ€ä¸å›½åŠ›</h3>
                <p>Â· <strong>å›½åŠ›å€¼</strong>ï¼šå½’é›¶å³äº¡å›½ã€‚æ¯å¹´è‡ªåŠ¨-1ã€‚</p>
                <p>Â· <strong>å››å¤§çŠ¶æ€</strong>ï¼šå›ä¸»ã€æœå»·ã€å†›å¿ƒã€æ°‘å¿ƒã€‚çŠ¶æ€ä¼˜åŠ£å†³å®šæ¯å¹´å›½åŠ›çš„å¢å‡ã€‚</p>
                <h3>âš”ï¸ æˆ˜å½¹ç³»ç»Ÿ</h3>
                <p>Â· <strong>æˆ‘æ–¹å‘èµ·</strong>ï¼šå›½åŠ›â‰¥70%æ—¶æ¦‚ç‡æå‡ã€‚èƒœåˆ©å¯å¤§å¹…å¢åŠ å›½åŠ›ã€‚</p>
                <p>Â· <strong>æ•Œæ–¹å…¥ä¾µ</strong>ï¼šå›½åŠ›â‰¤30%æ—¶æ¦‚ç‡æå‡ã€‚å¤±è´¥å°†æ‰£é™¤å›½åŠ›ã€‚</p>
                <h3>ğŸƒ å¡ç‰Œç³»ç»Ÿ</h3>
                <p>Â· æ¯10å¹´æœ‰å‡ ç‡è·å¾—å¡ç‰Œï¼Œå¯ç”¨äºå¢ç›ŠçŠ¶æ€æˆ–èµŒå›½è¿ã€‚</p>
            </div>
        </div>
    </div>

    <!-- 7. å¡ç‰Œå¼¹çª— -->
    <div id="cardModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <span>æ²»å›½ç­–ç•¥</span>
                <span onclick="closeModal('cardModal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body">
                <div id="cardList" class="card-grid">
                    <!-- JS å¡«å…… -->
                </div>
                <div id="noCardMsg" style="text-align:center; color:#999; padding:20px; display:none;">æš‚æ— å¯ç”¨å¡ç‰Œ</div>
            </div>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½®ä¸æ•°æ® ---
        const CONFIG = {
            baseYear: 523,
            speeds: { normal: 10000, fast: 2000 },
            maxAge: 90,
            givenNames: "èµµé’±å­™æå‘¨å´éƒ‘ç‹å†¯é™ˆè¤šå«è’‹æ²ˆéŸ©æ¨æœ±ç§¦å°¤è®¸ä½•å•æ–½å¼ å­”æ›¹ä¸¥åé‡‘é­é™¶å§œæˆšè°¢é‚¹å–»æŸæ°´çª¦ç« äº‘è‹æ½˜è‘›å¥šèŒƒå½­éƒé²éŸ¦æ˜Œé©¬è‹—å‡¤èŠ±æ–¹ä¿ä»»è¢æŸ³é…†é²å²å”è´¹å»‰å²‘è–›é›·è´ºå€ªæ±¤æ»•æ®·ç½—æ¯•éƒå®‰å¸¸ä¹äºæ—¶å‚…çš®åé½åº·ä¼ä½™å…ƒåœé¡¾å­Ÿå¹³é»„å’Œç©†è§å°¹å§šé‚µæ¹›æ±ªç¥æ¯›ç¦¹ç‹„ç±³è´æ˜è‡§è®¡ä¼æˆæˆ´è°ˆå®‹èŒ…åºç†Šçºªèˆ’å±ˆé¡¹ç¥è‘£æ¢æœé˜®è“é—µå¸­å­£éº»å¼ºè´¾è·¯å¨„å±æ±Ÿç«¥é¢œéƒ­æ¢…ç››æ—åˆé’Ÿå¾é‚±éª†é«˜å¤è”¡ç”°æ¨Šèƒ¡å‡Œéœä¸‡æŸ¯å¢è«æˆ¿ç¼ªå¹²è§£åº”å®—ä¸å®£é‚“éƒå•æ­æ´ªåŒ…è¯¸å·¦çŸ³å´”å‰é’®é¾šç¨‹åµ‡é‚¢æ»‘è£´é™†è£ç¿è€ç¾Šæ–¼æƒ å®¶å°èŠ®ç¾¿å‚¨æ™‹æ±²é‚´ç³œæ¾äº•æ®µå¯Œå·«ä¹Œç„¦å·´å¼“ç‰§éš—å±±è°·è½¦ä¾¯å®“è“¬å…¨éƒ—ç­ä»°ç§‹ä»²ä¼Šå®«å®ä»‡æ ¾æš´ç”˜é’­å‰æˆç¥–æ­¦ç¬¦åˆ˜æ™¯è©¹æŸé¾™å¶å¹¸å¸éŸ¶éƒœé»è“Ÿè–„å°å®¿ç™½æ€€è’²å°ä»é„‚ç´¢å’¸ç±èµ–å“è”ºå± è’™æ± ä¹”é˜´éƒèƒ¥èƒ½è‹åŒé—»è˜å…šç¿Ÿè°­è´¡åŠ³é€„å§¬ç”³æ‰¶å µå†‰å®°éƒ¦é›å´ç’©æ¡‘æ¡‚æ¿®ç‰›å¯¿é€šè¾¹æ‰ˆç‡•å†€éƒŸæµ¦å°šå†œæ¸©åˆ«åº„æ™æŸ´ç¿é˜å……æ…•è¿èŒ¹ä¹ å®¦è‰¾é±¼å®¹å‘å¤æ˜“æ…æˆˆå»–åº¾ç»ˆæš¨å±…è¡¡æ­¥éƒ½è€¿æ»¡å¼˜åŒ¡å›½æ–‡å¯‡å¹¿ç¦„é˜™ä¸œæ¬§æ²ƒåˆ©è”šè¶Šå¤”éš†å¸ˆå·©åè‚æ™å‹¾æ•–èå†·è¨¾è¾›é˜šé‚£ç®€é¥¶ç©ºæ›¾æ²™æ²™ä¹œå…»é é¡»ä¸°å·¢å…³è’¯ç›¸æŸ¥åè†çº¢æ¸¸ç«ºæƒé€¯ç›–ç›Šæ¡“å…¬",
            surnames: "èµµé’±å­™æå‘¨å´éƒ‘ç‹å†¯é™ˆè¤šå«è’‹æ²ˆéŸ©æ¨æœ±ç§¦å°¤è®¸ä½•å•æ–½å¼ å­”æ›¹ä¸¥åé‡‘é­é™¶å§œæˆšè°¢é‚¹å–»æŸæ°´çª¦ç« äº‘è‹æ½˜è‘›å¥šèŒƒå½­éƒé²éŸ¦æ˜Œé©¬è‹—å‡¤èŠ±æ–¹ä¿ä»»è¢æŸ³é…†é²å²å”è´¹å»‰å²‘è–›é›·è´ºå€ªæ±¤æ»•æ®·ç½—æ¯•éƒå®‰å¸¸ä¹äºæ—¶å‚…çš®åé½åº·ä¼ä½™å…ƒåœé¡¾å­Ÿå¹³é»„å’Œç©†è§å°¹å§šé‚µæ¹›æ±ªç¥æ¯›ç¦¹ç‹„ç±³è´æ˜è‡§è®¡ä¼æˆæˆ´è°ˆå®‹èŒ…åºç†Šçºªèˆ’å±ˆé¡¹ç¥è‘£æ¢æœé˜®è“é—µå¸­å­£éº»å¼ºè´¾è·¯å¨„å±æ±Ÿç«¥é¢œéƒ­æ¢…ç››æ—åˆé’Ÿå¾é‚±éª†é«˜å¤è”¡ç”°æ¨Šèƒ¡å‡Œéœä¸‡æŸ¯å¢è«æˆ¿ç¼ªå¹²è§£åº”å®—ä¸å®£é‚“éƒå•æ­æ´ªåŒ…è¯¸å·¦çŸ³å´”å‰é’®é¾šç¨‹åµ‡é‚¢æ»‘è£´é™†è£ç¿è€ç¾Šæ–¼æƒ å®¶å°èŠ®ç¾¿å‚¨æ™‹æ±²é‚´ç³œæ¾äº•æ®µå¯Œå·«ä¹Œç„¦å·´å¼“ç‰§éš—å±±è°·è½¦ä¾¯å®“è“¬å…¨éƒ—ç­ä»°ç§‹ä»²ä¼Šå®«å®ä»‡æ ¾æš´ç”˜é’­å‰æˆç¥–æ­¦ç¬¦åˆ˜æ™¯è©¹æŸé¾™å¶å¹¸å¸éŸ¶éƒœé»è“Ÿè–„å°å®¿ç™½æ€€è’²å°ä»é„‚ç´¢å’¸ç±èµ–å“è”ºå± è’™æ± ä¹”é˜´éƒèƒ¥èƒ½è‹åŒé—»è˜å…šç¿Ÿè°­è´¡åŠ³é€„å§¬ç”³æ‰¶å µå†‰å®°éƒ¦é›å´ç’©æ¡‘æ¡‚æ¿®ç‰›å¯¿é€šè¾¹æ‰ˆç‡•å†€éƒŸæµ¦å°šå†œæ¸©åˆ«åº„æ™æŸ´ç¿é˜å……æ…•è¿èŒ¹ä¹ å®¦è‰¾é±¼å®¹å‘å¤æ˜“æ…æˆˆå»–åº¾ç»ˆæš¨å±…è¡¡æ­¥éƒ½è€¿æ»¡å¼˜åŒ¡å›½æ–‡å¯‡å¹¿ç¦„é˜™ä¸œæ¬§æ²ƒåˆ©è”šè¶Šå¤”éš†å¸ˆå·©åè‚æ™å‹¾æ•–èå†·è¨¾è¾›é˜šé‚£ç®€é¥¶ç©ºæ›¾æ²™æ²™ä¹œå…»é é¡»ä¸°å·¢å…³è’¯ç›¸æŸ¥åè†çº¢æ¸¸ç«ºæƒé€¯ç›–ç›Šæ¡“å…¬",
            compoundSurnames: ["æ¬§é˜³", "ä¸Šå®˜", "å®æœ¨", "å¸é©¬", "å·«é©¬", "ä¸œæ–¹", "å®å°", "ä¸Šæœ¬", "æ²™æ±•", "æ±•æœ¬", "ç«¯æœ¨", "ç‹¬å­¤", "å—å®«", "ä¸‡ä¿Ÿ", "é—»äºº", "å¤ä¾¯", "è¯¸è‘›", "å°‰è¿Ÿ", "å…¬ç¾Š", "èµ«è¿", "æ¾¹å°", "çš‡ç”«", "å®—æ”¿", "æ¿®é˜³", "å…¬æ·³", "æ·³äº", "å•äº", "å¤ªå”", "ç”³å± ", "å…¬å­™", "ä»²å­™", "è½©è¾•", "ä»¤ç‹", "é’Ÿç¦»", "å®‡æ–‡", "é•¿å­™", "æ…•å®¹", "é²œäº", "é—¾ä¸˜", "å¸å¾’", "å¸ç©º", "äº“å®˜", "å¸å¯‡", "ä»‰ç£", "å­è½¦", "é¢›å­™", "ç«¯æœ¨", "å·«é©¬", "å…¬è¥¿", "æ¼†é›•", "ä¹æ­£", "å£¤é©·", "å…¬è‰¯", "æ‹“è·‹", "å¤¹è°·", "å®°çˆ¶", "è°·æ¢", "æ™‹æ¥š", "é—«æ³•", "æ±é„¢", "æ¶‚é’¦", "æ®µå¹²", "ç™¾é‡Œ", "ä¸œéƒ­", "å—é—¨", "å‘¼å»¶", "å½’æµ·", "ç¾ŠèˆŒ", "å¾®ç”Ÿ", "å²³å¸…", "ç¼‘äº¢", "å†µå", "æœ‰ç´", "æ¢ä¸˜", "å·¦ä¸˜", "ä¸œé—¨", "è¥¿é—¨", "å•†ç‰Ÿ", "ä½˜ä½´", "ä¼¯èµ", "å—ä¼¯", "è¡Œä¸»", "è¨€ç¦", "ç™¾å®¶", "ä¸œå®«"],
            eraPrefix: "çš‡å¤§å¤©å…ƒæ°¸å»ºå¼€å…‰å’¸æ˜­æ™¯ç»æ´ªæ­£å®æ­¦å˜‰ä¸‡åŒé“å’¸å…‰å®£ä¹¾å¤ä¸­å…´å¤ªå®è‡³å»¶ç†™éš†æ·³å¾·æ–‡ç¥åœ£åº”ä¿åº†",
            eraSuffix: "å¹³å®‰å®šæ²»å¾·åº†å®å’Œå…´ä¸°ç†™æ³°é¡ºä½‘æ˜Œå†å¯åº·ç†™ç»ªç»Ÿæ­£å®åŒ–ç¦ç¥¯ç¥¥æˆä¸šæˆæ­¦çŒ®è®©å®—å¥‰å…ƒæœ”åˆ",
            templeTiers: {
                t1: "æ–‡æ­¦åœ£é«˜æ˜æˆè‹±å®£ç¥æ˜­ç¿å¾·",
                t2: "ä»ä¸­å®ªå­æ™¯åº„è‚ƒç¿¼æ‡¿åº·",
                t3: "å¹³é¡ºå®‰å®šæ•¬æ­å…ƒç®€ç©†",
                t4: "çµç‚€å“€æ‚¼æ€æ®‡æƒ æ€€æ•æ„"
            }
        };

        const usedData = {
            dynasties: new Set(),
            eraNames: new Set(),
            templeNames: new Set(),
            templeFullNames: new Set()
        };

        const historyArchive = [];

        let gameState = {
            timerId: null,
            speed: 'normal',
            year: 523,
            dynasty: {
                name: '',
                baseName: '',
                surname: '',
                foundYear: 0,
                monarchs: [],
                events: []
            },
            currentMonarch: {
                name: '',
                temple: '',
                age: 0,
                reignTime: 0,
                maxAge: 0,
                startYear: 0,
                goldenAge: null,
                eraName: '',
                totalPowerChange: 0,
                score: 0
            },
            politics: {
                public: 70,
                court: 70,
                monarch: 70,
                military: 70
            },
            era: {
                name: '',
                year: 1
            },
            stats: {
                power: 0,
                battles: 0,
                wins: 0
            },
            cards: [], // { id, type, name, desc, color, yearsLeft }
            nextCardId: 1,
            tempCreation: {},
            activeBadge: null,
            shengshiLogged: false
        };

        // --- è¾…åŠ©å‡½æ•° ---
        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function randomCharFrom(str) { return str.charAt(randomInt(0, str.length - 1)); }

        function generateUnique(set, generatorFn) {
            let attempt;
            let safety = 0;
            do {
                attempt = generatorFn();
                safety++;
                if (safety > 500) break;
            } while (set.has(attempt));
            set.add(attempt);
            return attempt;
        }

        function getDynastyNameObj() {
            return generateUnique(usedData.dynasties, () => {
                const char = randomCharFrom(CONFIG.givenNames);
                const suffix = 'æœ';
                return { fullName: char + suffix, baseName: char };
            });
        }

        function getSurname() {
            if (Math.random() < 0.1) {
                const idx = randomInt(0, CONFIG.compoundSurnames.length - 1);
                return CONFIG.compoundSurnames[idx];
            } else {
                return randomCharFrom(CONFIG.surnames);
            }
        }

        function getEraName() {
            return generateUnique(usedData.eraNames, () => {
                const p = randomCharFrom(CONFIG.eraPrefix);
                let s;
                do {
                    s = randomCharFrom(CONFIG.eraSuffix);
                } while (s === p);
                return p + s;
            });
        }

        function generateTempleName(score, isFounder) {
            const prefix = gameState.dynasty.baseName;

            if (isFounder) {
                return { full: prefix + 'å¤ªç¥–', char: 'å¤ªç¥–' };
            }

            let pool = "";
            if (score >= 8) pool = CONFIG.templeTiers.t1;
            else if (score >= 4) pool = CONFIG.templeTiers.t2;
            else if (score >= -4) pool = CONFIG.templeTiers.t3;
            else pool = CONFIG.templeTiers.t4;

            let middleChar;
            let safety = 0;
            do {
                if (safety > 50) pool = CONFIG.templeTiers.t2 + CONFIG.templeTiers.t3;
                middleChar = randomCharFrom(pool);
                safety++;
            } while (usedData.templeNames.has(middleChar) && safety < 100);

            usedData.templeNames.add(middleChar);

            const suffix = 'å®—';
            return { full: prefix + middleChar + suffix, char: middleChar + suffix };
        }

        function getStatusLevel(value) {
            if (value >= 75) return { label: 'ä¼˜', class: 'status-excellent', score: 75 };
            if (value >= 50) return { label: 'è‰¯', class: 'status-good', score: 50 };
            if (value >= 25) return { label: 'å·®', class: 'status-poor', score: -50 };
            return { label: 'å±', class: 'status-critical', score: -75 };
        }

        // --- èƒ¶å›Šæ¶ˆæ¯ç³»ç»Ÿ ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 2000); // 2ç§’åæ¶ˆå¤±
        }

        // --- å¡ç‰Œç³»ç»Ÿé€»è¾‘ ---
        function tryDrawCard() {
            if (Math.random() < 0.5) {
                // è·å¾—å¡ç‰Œ
                const types = [
                    { type: 'monarch', name: 'å›ä¸»åŠ æŒ', desc: 'å›ä¸»çŠ¶æ€+10%', color: '#e8f8f5' },
                    { type: 'court', name: 'æ•´é¡¿æœçº²', desc: 'æœå»·çŠ¶æ€+10%', color: '#f4ecf7' },
                    { type: 'military', name: 'å¼ºå†›è®¡åˆ’', desc: 'å†›å¿ƒçŠ¶æ€+10%', color: '#fdebd0' },
                    { type: 'public', name: 'å¤§èµ¦å¤©ä¸‹', desc: 'æ°‘å¿ƒçŠ¶æ€+10%', color: '#eafaf1' },
                    { type: 'gamble', name: 'èµŒå›½è¿', desc: 'å…¨çŠ¶æ€ Â±30%', color: '#fadbd8' }
                ];

                const picked = types[randomInt(0, types.length - 1)];
                const newCard = {
                    id: gameState.nextCardId++,
                    ...picked,
                    yearsLeft: randomInt(30, 60)
                };

                gameState.cards.push(newCard);
                updateCardBadge();
                // è·å¾—æç¤ºå¯é€‰ï¼Ÿé¢˜ç›®æœªè¦æ±‚ï¼Œä½†ä¸ºäº†ä½“éªŒå¯ä»¥åŠ 
                showToast(`è·å¾—å¡ç‰Œï¼š${newCard.name}`);
            }
        }

        function useCard(id) {
            const idx = gameState.cards.findIndex(c => c.id === id);
            if (idx === -1) return;
            const card = gameState.cards[idx];

            let msg = '';
            if (card.type === 'gamble') {
                if (Math.random() < 0.5) {
                    // +30%
                    gameState.politics.monarch = Math.min(100, gameState.politics.monarch + 30);
                    gameState.politics.court = Math.min(100, gameState.politics.court + 30);
                    gameState.politics.military = Math.min(100, gameState.politics.military + 30);
                    gameState.politics.public = Math.min(100, gameState.politics.public + 30);
                    msg = 'å›½è¿æ˜Œéš†ï¼æ‰€æœ‰çŠ¶æ€ +30%';
                    logEvent('å›½è¿', 'ä½¿ç”¨èµŒå›½è¿å¡ç‰Œï¼Œå¤©ä½‘å¤§ç»Ÿï¼Œå›½åŠ¿å¤§å¢ï¼', '#27ae60');
                } else {
                    // -30%
                    gameState.politics.monarch = Math.max(0, gameState.politics.monarch - 30);
                    gameState.politics.court = Math.max(0, gameState.politics.court - 30);
                    gameState.politics.military = Math.max(0, gameState.politics.military - 30);
                    gameState.politics.public = Math.max(0, gameState.politics.public - 30);
                    msg = 'å›½è¿è¡°é€€ï¼æ‰€æœ‰çŠ¶æ€ -30%';
                    logEvent('å›½è¿', 'ä½¿ç”¨èµŒå›½è¿å¡ç‰Œï¼Œæ—¶è¿ä¸æµï¼Œå›½åŠ¿è¡°å¾®ã€‚', '#c0392b');
                }
            } else {
                // Buffs
                if (card.type === 'monarch') { gameState.politics.monarch = Math.min(100, gameState.politics.monarch + 10); msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼å›ä¸»å¢ç›Š10%'; }
                else if (card.type === 'court') { gameState.politics.court = Math.min(100, gameState.politics.court + 10); msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼æœå»·å¢ç›Š10%'; }
                else if (card.type === 'military') { gameState.politics.military = Math.min(100, gameState.politics.military + 10); msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼å†›å¿ƒå¢ç›Š10%'; }
                else if (card.type === 'public') { gameState.politics.public = Math.min(100, gameState.politics.public + 10); msg = 'å¡ç‰Œä½¿ç”¨æˆåŠŸï¼æ°‘å¿ƒå¢ç›Š10%'; }
            }

            showToast(msg);
            gameState.cards.splice(idx, 1);
            updateCardBadge();
            renderCards(); // Re-render modal
            updateUI(); // Update stats immediately
        }

        function discardCard(id) {
            const idx = gameState.cards.findIndex(c => c.id === id);
            if (idx !== -1) {
                gameState.cards.splice(idx, 1);
                updateCardBadge();
                renderCards();
            }
        }

        function updateCardBadge() {
            const el = document.getElementById('uiCardBadge');
            const count = gameState.cards.length;
            if (count > 0) {
                el.style.display = 'flex';
                el.innerText = count;
            } else {
                el.style.display = 'none';
            }
        }

        function openCardModal() {
            renderCards();
            openModal('cardModal');
        }

        function renderCards() {
            const list = document.getElementById('cardList');
            const emptyMsg = document.getElementById('noCardMsg');

            if (gameState.cards.length === 0) {
                list.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';

            list.innerHTML = gameState.cards.map(c => `
                <div class="card-item" style="background-color:${c.color}">
                    <div>
                        <div class="card-name">${c.name}</div>
                        <div class="card-desc">${c.desc}</div>
                    </div>
                    <div>
                        <div class="card-timer">${c.yearsLeft}å¹´åå¤±æ•ˆ</div>
                        <div class="card-actions">
                            <button class="btn-card-use" onclick="useCard(${c.id})">ä½¿ç”¨</button>
                            <button class="btn-card-discard" onclick="discardCard(${c.id})">ä¸¢å¼ƒ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- æ¸¸æˆé€»è¾‘ ---

        function initCreation() {
            openModal('createModal');
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('gameFooter').style.display = 'none';

            usedData.eraNames.clear();
            usedData.templeNames.clear();
            usedData.templeFullNames.clear();

            gameState.tempCreation = { dynastyInfo: null, surname: null };
            rollDynastyName();
            rollSurname();
        }

        function rollDynastyName() {
            const dInfo = getDynastyNameObj();
            gameState.tempCreation.dynastyInfo = dInfo;
            document.getElementById('previewDynasty').innerText = dInfo.fullName;
        }

        function rollSurname() {
            const sName = getSurname();
            gameState.tempCreation.surname = sName;
            document.getElementById('previewSurname').innerText = sName;
        }

        function startGame() {
            closeModal('createModal');
            document.getElementById('gameUI').style.display = 'flex';
            document.getElementById('gameFooter').style.display = 'flex';

            const dInfo = gameState.tempCreation.dynastyInfo;
            const sName = gameState.tempCreation.surname;

            gameState.dynasty = {
                name: dInfo.fullName,
                baseName: dInfo.baseName,
                surname: sName,
                foundYear: gameState.year,
                monarchs: [],
                events: []
            };
            const startPower = randomInt(50, 80);
            gameState.stats = {
                power: startPower,
                battles: 0,
                wins: 0
            };
            gameState.politics = {
                public: randomInt(50, 80),
                court: randomInt(50, 80),
                monarch: randomInt(50, 80),
                military: randomInt(50, 80)
            };

            gameState.cards = [];
            updateCardBadge();

            usedData.eraNames.clear();
            usedData.templeNames.clear();

            gameState.activeBadge = null;
            gameState.shengshiLogged = false;

            document.getElementById('uiEventBar').innerHTML = '<div class="event-line" style="color:#999; text-align:center;">æš‚æ— å¤§äº‹ä»¶...</div>';

            newMonarch(true);

            updateUI();
            startTimer();
        }

        function newMonarch(isFounder, forcedEraName = null) {
            gameState.shengshiLogged = false;
            gameState.activeBadge = null;

            const surname = gameState.dynasty.surname;
            let givenName = randomCharFrom(CONFIG.givenNames);
            if (Math.random() < 0.5) givenName += randomCharFrom(CONFIG.givenNames);

            const age = isFounder ? randomInt(25, 50) : randomInt(10, 50);
            const eraStr = forcedEraName || getEraName();

            gameState.currentMonarch = {
                name: surname + givenName,
                temple: null,
                age: age,
                reignTime: 0,
                maxAge: Math.min(90, age + randomInt(10, 50)),
                startYear: gameState.year,
                goldenAge: null,
                eraName: eraStr,
                totalPowerChange: 0,
                score: 0
            };
            if (gameState.currentMonarch.maxAge > 90) gameState.currentMonarch.maxAge = 90;

            gameState.era = {
                name: eraStr,
                year: 1
            };

            gameState.dynasty.monarchs.push({
                ...gameState.currentMonarch,
                endYear: null
            });

            updateLineageBtn();

            if (isFounder) {
                logEvent('å»ºå›½', `${gameState.currentMonarch.name}äºå…¬å…ƒ${gameState.year}å¹´ç§°å¸ï¼Œå›½å· ${gameState.dynasty.baseName}ï¼Œå²ç§°${eraStr}å¸ã€‚`);
            } else {
                logEvent('ç™»åŸº', `${gameState.currentMonarch.name} ç»§ä½ï¼Œæ”¹å…ƒ ${gameState.era.name}ï¼Œå²ç§° ${gameState.era.name}å¸ï¼Œæ—¶å¹´ ${age} å²ã€‚`);
            }
        }

        function updateLineageBtn() {
            const count = Math.max(0, gameState.dynasty.monarchs.length - 1);
            document.getElementById('btnLineage').innerText = `è°±ç³»${count}`;
        }

        function startTimer() {
            if (gameState.timerId) clearInterval(gameState.timerId);
            const interval = gameState.speed === 'normal' ? CONFIG.speeds.normal : CONFIG.speeds.fast;
            gameState.timerId = setInterval(tick, interval);
            updateSpeedBtn();
        }

        function toggleSpeed() {
            gameState.speed = gameState.speed === 'normal' ? 'fast' : 'normal';
            startTimer();
        }
        function updateSpeedBtn() {
            const btn = document.getElementById('speedBtn');
            if (gameState.speed === 'fast') {
                btn.innerText = '5x é€Ÿ'; btn.classList.add('active-5x');
            } else {
                btn.innerText = '1x é€Ÿ'; btn.classList.remove('active-5x');
            }
        }

        function tick() {
            gameState.year++;
            gameState.era.year++;
            gameState.currentMonarch.reignTime++;
            gameState.currentMonarch.age++;

            // å›½åŠ›è‡ªåŠ¨ -1
            gameState.stats.power -= 1;

            if (gameState.year % 5 === 0) {
                applyStatusFluctuation();
            }

            // å¡ç‰Œè·å– (æ¯10å¹´)
            if (gameState.year % 10 === 0) {
                tryDrawCard();
            }

            // å¡ç‰Œè¿‡æœŸå¤„ç†
            for (let i = gameState.cards.length - 1; i >= 0; i--) {
                gameState.cards[i].yearsLeft--;
                if (gameState.cards[i].yearsLeft <= 0) {
                    gameState.cards.splice(i, 1); // ç§»é™¤è¿‡æœŸå¡
                }
            }
            updateCardBadge();
            // å¦‚æœå¡ç‰Œå¼¹çª—å¼€ç€ï¼Œåˆ·æ–°ä¸€ä¸‹
            if (document.getElementById('cardModal').classList.contains('active')) {
                renderCards();
            }

            let polyProb = 0.1;
            if (gameState.stats.power >= 90) polyProb = 0.2;
            if (Math.random() < polyProb) {
                handlePoliticalEvent();
            }

            const pScore = getStatusLevel(gameState.politics.public).score;
            const cScore = getStatusLevel(gameState.politics.court).score;
            const mScore = getStatusLevel(gameState.politics.monarch).score;
            const milScore = getStatusLevel(gameState.politics.military).score;

            const powerChange = Math.floor((pScore + cScore + mScore + milScore) / 30);

            gameState.currentMonarch.totalPowerChange += powerChange;

            gameState.stats.power += powerChange;
            if (gameState.stats.power > 100) gameState.stats.power = 100;
            if (gameState.stats.power < 0) gameState.stats.power = 0;

            checkHistoryBadge();

            let probPlayer = 0.1;
            if (gameState.stats.power >= 70) probPlayer = 0.2;

            let probEnemy = 0.1;
            if (gameState.stats.power <= 30) probEnemy = 0.2;

            const roll = Math.random();
            if (roll < probPlayer) {
                handleWar(true);
            } else if (roll < (probPlayer + probEnemy)) {
                handleWar(false);
            }

            checkDeath();
            checkCollapse();
            updateUI();
        }

        function applyStatusFluctuation() {
            ['public', 'court', 'monarch', 'military'].forEach(key => {
                const change = randomInt(2, 5);
                const sign = Math.random() < 0.5 ? 1 : -1;
                gameState.politics[key] += (change * sign);
                gameState.politics[key] = Math.min(100, Math.max(0, gameState.politics[key]));
            });
        }

        function handlePoliticalEvent() {
            const name = randomCharFrom(CONFIG.givenNames) + randomCharFrom(CONFIG.givenNames) + (Math.random() < 0.5 ? "æ”¿å˜" : "äº‹å˜");

            let maxChangeVal = 0;
            let maxChangeKey = '';
            let maxChangeSign = 1;

            ['public', 'court', 'monarch', 'military'].forEach(key => {
                const change = randomInt(10, 20);
                const sign = Math.random() < 0.5 ? 1 : -1;

                if (change > maxChangeVal) {
                    maxChangeVal = change;
                    maxChangeKey = key;
                    maxChangeSign = sign;
                }

                gameState.politics[key] += (change * sign);
                gameState.politics[key] = Math.min(100, Math.max(0, gameState.politics[key]));
            });

            let desc = "";
            if (maxChangeKey === 'public') {
                desc = maxChangeSign > 0 ? "æ°‘å¿ƒå¤§å¢" : "æ°‘æ€¨æ²¸è…¾";
            } else if (maxChangeKey === 'court') {
                desc = maxChangeSign > 0 ? "æœçº²è‚ƒæ¸…" : "æƒè‡£å½“é“";
            } else if (maxChangeKey === 'military') {
                desc = maxChangeSign > 0 ? "å†›å¨å¤§æŒ¯" : "å†›å¿ƒæ¶£æ•£";
            } else {
                desc = maxChangeSign > 0 ? "å¸å¨å¤§æŒ¯" : "å¨ä¸¥æ‰«åœ°";
            }

            logEvent('æ”¿æ²»', `çˆ†å‘${name}ï¼Œ${desc}ã€‚`, '#8e44ad');
        }

        function checkHistoryBadge() {
            const duration = gameState.year - gameState.dynasty.foundYear;
            if (duration <= 50) {
                gameState.activeBadge = null;
                return;
            }

            const p = gameState.politics.public;
            const c = gameState.politics.court;
            const m = gameState.politics.monarch;
            const mil = gameState.politics.military;

            let newBadge = null;
            let badgeClass = '';

            if (p < 30 && c < 30 && m < 30 && mil < 30) {
                newBadge = "å±åœ¨æ—¦å¤•";
                badgeClass = "badge-danger";
            }
            else if (p >= 80 && c >= 80 && m >= 80 && mil >= 80) {
                newBadge = `${gameState.era.name}ç››ä¸–`;
                badgeClass = "badge-shengshi";
                if (!gameState.shengshiLogged) {
                    logEvent('ç››ä¸–', `å¤©ä¸‹å¤§æ²»ï¼Œå²ç§°ã€Œ${newBadge}ã€ã€‚`, '#f1c40f');
                    gameState.shengshiLogged = true;
                    gameState.currentMonarch.goldenAge = newBadge;
                }
            }
            else if (m < 30) {
                newBadge = "æ˜å›å½“æœ";
                badgeClass = "badge-danger";
            }
            else if (c < 30) {
                newBadge = "æœå±€åŠ¨è¡";
                badgeClass = "badge-danger";
            }
            else if (mil < 30) {
                newBadge = "å†›å¿ƒæ¶£æ•£";
                badgeClass = "badge-danger";
            }
            else if (p < 30) {
                newBadge = "æ°‘ä¸èŠç”Ÿ";
                badgeClass = "badge-danger";
            }
            else if (m >= 90 && p > 30 && c > 30 && mil > 30) {
                newBadge = "è‰¯å›æ²»å›½";
                badgeClass = "badge-good";
            }
            else if (p >= 90 && m > 30 && c > 30 && mil > 30) {
                newBadge = "æ°‘å¿ƒæ‰€å‘";
                badgeClass = "badge-good";
            }

            gameState.activeBadge = newBadge ? { text: newBadge, css: badgeClass } : null;

            if (newBadge && !newBadge.includes('ç››ä¸–')) {
                gameState.shengshiLogged = false;
            }
        }

        function handleWar(isPlayerInitiator) {
            const initiator = isPlayerInitiator ? "æˆ‘æ–¹" : "æ•Œæ–¹";

            const monarchVal = gameState.politics.monarch;
            const powerScore = gameState.stats.power;

            const winChance = (monarchVal * 0.4) + (powerScore * 0.6);
            const roll = Math.random() * 100;
            const isWin = roll < winChance;

            gameState.stats.battles++;

            if (isWin) {
                gameState.stats.wins++;
                const gain = randomInt(2, 5);
                gameState.stats.power = Math.min(100, gameState.stats.power + gain);

                const winDescList = ["ç¼´è·å¤§é‡ç‰©èµ„", "è·å¾—å‰æœé—ç•™æŠ€æœ¯", "æ•Œå›½èµ”æ¬¾æ±‚å’Œ", "æ”¶å¤åŒ—æ–¹å¤±åœ°", "æ‹“åœŸå¼€ç–†", "å¨éœ‡å››æ–¹"];
                const desc = winDescList[randomInt(0, winDescList.length - 1)];

                logEvent('å¤§æ·', `${initiator}å‘èµ·æˆ˜å½¹ï¼Œ${desc}ï¼å›½åŠ› +${gain}%`);
            } else {
                const loss = randomInt(2, 5);
                gameState.stats.power = Math.max(0, gameState.stats.power - loss);

                const loseDescList = ["è¢«è¿«å‰²è®©è¾¹éƒ¡", "å›½åº“èµ”æ¬¾", "è¾¹é˜²å†›æ­»ä¼¤æƒ¨é‡", "é˜²çº¿æºƒè´¥", "ä¸§å¸ˆè¾±å›½", "ä¸¢å¤±é‡é•‡"];
                const desc = loseDescList[randomInt(0, loseDescList.length - 1)];

                logEvent('æˆ˜è´¥', `${initiator}å‘èµ·æˆ˜å½¹ï¼Œ${desc}ã€‚å›½åŠ› -${loss}%`);
            }
        }

        function finalizeMonarchData() {
            const m = gameState.currentMonarch;

            if (m.reignTime >= 10) {
                m.score = Math.floor(m.totalPowerChange / m.reignTime);
            } else {
                m.score = 0;
            }

            const isFounder = (gameState.dynasty.monarchs.length === 1);
            const templeObj = generateTempleName(m.score, isFounder);
            m.temple = templeObj.full;

            const idx = gameState.dynasty.monarchs.length - 1;
            if (idx >= 0) {
                const finalData = { ...m };
                finalData.endYear = gameState.year;
                gameState.dynasty.monarchs[idx] = finalData;
            }

            return m.temple;
        }

        function checkDeath() {
            const m = gameState.currentMonarch;
            if (m.age >= m.maxAge || m.age >= 90) {
                const finalTemple = finalizeMonarchData();
                logEvent('é©¾å´©', `${m.eraName}å¸é©¾å´©ï¼Œç¾¤è‡£ä¸Šè°¥ï¼Œåº™å·${finalTemple}ï¼Œäº«å¹´${m.age} å²ã€‚`);
                newMonarch(false);
            }
        }

        function checkCollapse() {
            if (gameState.stats.power <= 0) {
                finalizeMonarchData();
                gameOver();
            }
        }

        function logEvent(type, content, color) {
            let yearDisplay = `${gameState.era.name}${gameState.era.year}å¹´`;
            if (gameState.era.year === 1) yearDisplay = `${gameState.era.name}å…ƒå¹´`;

            const typeColor = color || ((type === 'äº¡å›½' || type === 'æˆ˜è´¥' || type === 'é©¾å´©') ? '#c0392b' : '#2c3e50');
            const logEntry = { year: yearDisplay, type, content, fullYear: gameState.year, color: typeColor };
            gameState.dynasty.events.unshift(logEntry);

            const bar = document.getElementById('uiEventBar');
            const e1 = gameState.dynasty.events[0];
            const e2 = gameState.dynasty.events[1];

            let html = '';
            if (e1) {
                html += `<div class="event-line"><span class="typing-anim"><span style="font-weight:bold; color:${e1.color}; margin-right:4px;">[${e1.type}]</span>${e1.year}: ${e1.content}</span></div>`;
            }
            if (e2) {
                html += `<div class="event-line"><span style="font-weight:bold; color:${e2.color}; margin-right:4px;">[${e2.type}]</span>${e2.year}: ${e2.content}</div>`;
            }
            bar.innerHTML = html;
        }

        function updateUI() {
            document.getElementById('currentYearDisplay').innerText = `å…¬å…ƒ ${gameState.year} å¹´`;

            document.getElementById('uiDynastyName').innerText = gameState.dynasty.name;
            document.getElementById('uiFoundYear').innerText = `å…¬å…ƒ ${gameState.dynasty.foundYear} å¹´`;
            document.getElementById('uiDuration').innerText = gameState.year - gameState.dynasty.foundYear;

            const m = gameState.currentMonarch;
            let eraText = gameState.era.year === 1 ? `${gameState.era.name}å…ƒå¹´` : `${gameState.era.name}${gameState.era.year}å¹´`;
            document.getElementById('uiEraName').innerText = eraText;
            document.getElementById('uiMonarchName').innerText = `${m.eraName}å¸ ${m.name}`;
            document.getElementById('uiMonarchAge').innerText = m.age;
            document.getElementById('uiReignDuration').innerText = m.reignTime;

            const powerEl = document.getElementById('uiPower');
            powerEl.innerText = gameState.stats.power + '%';
            powerEl.className = 'stat-value' + (gameState.stats.power < 30 ? ' status-critical' : '');

            document.getElementById('uiBattleStats').innerText = `${gameState.stats.battles} / ${gameState.stats.wins}`;

            updateStatusBox('uiMonarchState', gameState.politics.monarch);
            updateStatusBox('uiCourt', gameState.politics.court);
            updateStatusBox('uiPublic', gameState.politics.public);
            updateStatusBox('uiMilitary', gameState.politics.military);

            const badgeEl = document.getElementById('uiHistoryBadge');
            const duration = gameState.year - gameState.dynasty.foundYear;

            if (duration <= 50) {
                badgeEl.className = 'history-badge-card';
                badgeEl.innerText = 'å¾…è§£é” (å›½ç¥š>50å¹´)';
                badgeEl.style.color = '#ccc';
                badgeEl.style.border = '1px dashed #ddd';
                badgeEl.style.background = 'var(--card-bg)';
            } else if (gameState.activeBadge) {
                badgeEl.className = `history-badge-card active ${gameState.activeBadge.css}`;
                badgeEl.innerText = gameState.activeBadge.text;
                badgeEl.style = '';
            } else {
                badgeEl.className = 'history-badge-card active';
                badgeEl.innerText = 'å¹³ç¨³å‘å±•';
                badgeEl.style.color = '#7f8c8d';
                badgeEl.style.border = '1px solid #bdc3c7';
                badgeEl.style.background = '#fff';
            }
        }

        function updateStatusBox(id, value) {
            const el = document.getElementById(id);
            const status = getStatusLevel(value);
            el.innerHTML = `<span class="${status.class}">${status.label} <small style="font-size:12px; opacity:0.7">(${Math.round(value)}%)</small></span>`;
        }

        // --- å¼¹çª—é€»è¾‘ ---

        function openLiveLineage() {
            const list = document.getElementById('lineageList');
            const pastMonarchs = gameState.dynasty.monarchs.slice(0, gameState.dynasty.monarchs.length - 1);

            if (pastMonarchs.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— å…ˆå¸è°±ç³»</p>';
            } else {
                list.innerHTML = pastMonarchs.map(m => `
                    <div class="lineage-row">
                        <div style="font-size:13px; font-weight:bold; color:#2c3e50; display:flex; justify-content:space-between;">
                            <span>${m.temple} ${m.name}</span>
                            <span style="font-weight:normal; color:#7f8c8d; font-size:12px;">[${m.eraName}] äº«å¹´${m.age}</span>
                        </div>
                        <div style="font-size:12px; color:#555; display:flex; justify-content:space-between; margin-top:2px;">
                            <span>åœ¨ä½ ${m.reignTime} å¹´ (${m.startYear}-${m.endYear}) <small style="color:var(--score-color)">åˆ†å€¼ï¼š${m.score}</small></span>
                            ${m.goldenAge ? `<span style="color:#d4ac0d; font-weight:bold;">â˜… ${m.goldenAge}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            openModal('lineageModal');
        }

        function gameOver() {
            clearInterval(gameState.timerId);
            gameState.timerId = null;

            const duration = gameState.year - gameState.dynasty.foundYear;
            logEvent('äº¡å›½', `å›½åŠ›è€—å°½ï¼Œ${gameState.dynasty.name}ç­äº¡ã€‚`);

            const archiveEntry = {
                dynastyName: gameState.dynasty.name,
                foundYear: gameState.dynasty.foundYear,
                endYear: gameState.year,
                duration: duration,
                monarchCount: gameState.dynasty.monarchs.length,
                battles: gameState.stats.battles,
                wins: gameState.stats.wins,
                monarchs: [...gameState.dynasty.monarchs],
                events: [...gameState.dynasty.events]
            };
            historyArchive.unshift(archiveEntry);

            document.getElementById('goDynastyName').innerText = gameState.dynasty.name;
            document.getElementById('goDuration').innerText = duration;
            document.getElementById('goMonarchCount').innerText = archiveEntry.monarchCount;

            openModal('gameOverModal');
        }

        function resetToCreation() {
            closeModal('gameOverModal');
            initCreation();
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'gameOverModal') {
                        // ä¸åšä»»ä½•äº‹
                        return;
                    }
                    overlay.classList.remove('active');
                    if (overlay.id === 'createModal' && document.getElementById('gameUI').style.display === 'none') {
                        overlay.classList.add('active');
                    }
                }
            });
        });

        function openEventLog() {
            const list = document.getElementById('fullEventLog');
            list.innerHTML = gameState.dynasty.events.map(e => `
                <p>
                    <span class="log-year">${e.year}</span>
                    <span style="color:${e.color}">[${e.type}]</span> 
                    ${e.content}
                </p>
            `).join('');
            openModal('eventModal');
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            if (historyArchive.length === 0) {
                list.innerHTML = '<li style="text-align:center; padding:20px; color:#999;">æš‚æ— å†å²æœä»£</li>';
            } else {
                list.innerHTML = historyArchive.map((h, index) => `
                    <li class="history-item-wrap">
                        <div class="history-item">
                            <div>
                                <span style="font-weight:bold; font-size:16px;">${h.dynastyName}</span>
                                <span style="font-size:12px; color:#666; margin-left:8px;">(${h.foundYear} - ${h.endYear})</span>
                            </div>
                            <div>
                                <span style="font-size:12px;">${h.duration}å¹´</span>
                                <span class="btn-more" onclick="toggleHistoryDetail(${index})">æ›´å¤š</span>
                            </div>
                        </div>
                        <div class="history-details" id="hist-detail-${index}">
                            <p><strong>å†ä»£å¸ç‹ï¼š</strong>${h.monarchCount} ä½</p>
                            <p><strong>æ­¦åŠŸï¼š</strong>æˆ˜å½¹ ${h.battles} æ¬¡ï¼Œèƒœ ${h.wins} æ¬¡</p>
                            <div style="margin-top:8px; max-height:150px; overflow-y:auto; border-top:1px solid #ddd; padding-top:4px;">
                                <p style="color:#666; font-size:11px; margin-bottom:5px;">å¸ç‹è°±ç³»ï¼š</p>
                                ${h.monarchs.map(m => `
                                    <div style="font-size:12px; margin-bottom:6px; border-bottom:1px dashed #eee; padding-bottom:4px;">
                                        <div><strong>${m.temple || '(åœ¨ä½)'}</strong> ${m.name} <span style="color:#7f8c8d; font-size:11px;">(äº«å¹´${m.age})</span></div>
                                        <div style="color:#555;">[${m.eraName}] åœ¨ä½${m.reignTime}å¹´ (${m.startYear}-${m.endYear || '?'}å¹´) <small style="color:var(--score-color)">åˆ†å€¼ï¼š${m.score}</small></div>
                                        ${m.goldenAge ? `<div style="color:#d4ac0d; font-weight:bold; font-size:11px;">â˜… å–å¾— ${m.goldenAge}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </li>
                `).join('');
            }
            openModal('historyModal');
        }

        function toggleHistoryDetail(index) {
            const el = document.getElementById(`hist-detail-${index}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // --- æ°´å°ç³»ç»Ÿ (éšæœºé™æ­¢ç”Ÿæˆ) ---
        function createWatermark() {
            const div = document.createElement('div');
            div.className = 'watermark';
            div.innerText = '@çŒç¡çŒ«';

            const w = window.innerWidth;
            const h = window.innerHeight;

            const x = Math.random() * (w - 60);
            const y = Math.random() * (h - 20);

            div.style.left = x + 'px';
            div.style.top = y + 'px';

            document.body.appendChild(div);

            setTimeout(() => {
                if (div.parentNode) div.remove();
            }, 10000);
        }

        setInterval(createWatermark, 60000);
        setTimeout(createWatermark, 1000);

        // åˆå§‹åŒ–
        initCreation();

    </script>
</body>

</html>
