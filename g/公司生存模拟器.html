<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å…¬å¸ç”Ÿå­˜æ¨¡æ‹Ÿ</title>
    <style>
        :root {
            /* é«˜çº§ç°é…è‰² (Slate Palette) */
            --bg-color: #f1f5f9;
            /* æµ…ç°èƒŒæ™¯ */
            --card-bg: #ffffff;
            /* çº¯ç™½å¡ç‰‡ */
            --header-bg: #1e293b;
            /* æ·±å²©çŸ³ç°å¤´éƒ¨ */
            --text-primary: #0f172a;
            /* æ·±è‰²ä¸»æ–‡æœ¬ */
            --text-secondary: #64748b;
            /* æ¬¡çº§æ–‡æœ¬ */
            --border-color: #e2e8f0;
            /* ææ·¡è¾¹æ¡† */
            --primary-color: #3b82f6;
            /* äº®è“ä¸»è‰² */
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --purple-color: #8b5cf6;

            --player-bg: #fffbeb;
            /* ç©å®¶é«˜äº®èƒŒæ™¯ (æ·¡æš–è‰²) */
            --player-text: #b45309;
            --selected-bg: #e0f2fe;
            /* é€‰ä¸­èƒŒæ™¯ */

            --radius-size: 12px;
            /* ç»Ÿä¸€åœ†è§’ */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* ç¦æ­¢é€‰ä¸­ */
            user-select: none;
            -webkit-user-select: none;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            scrollbar-width: none;
            /* Firefox */
        }

        body {
            background: var(--bg-color);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .header-wrap {
            width: 100%;
            background: var(--header-bg);
            color: #fff;
            padding: 14px 16px;
            border-radius: var(--radius-size);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .title-bar h1 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #f8fafc;
        }

        .stats-btn {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .stats-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* å…³é”®ä¿¡æ¯ä¸€è¡Œæ˜¾ç¤º */
        .info-bar-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            color: #94a3b8;
        }

        .info-item span {
            color: #fbbf24;
            /* é‡‘è‰²æ•°å­— */
            font-weight: 600;
            margin-left: 4px;
            font-variant-numeric: tabular-nums;
        }

        /* äº‹ä»¶æ  */
        .event-bar {
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: var(--radius-size);
            border: 1px solid var(--border-color);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .event-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .view-all-btn {
            background: transparent;
            color: var(--primary-color);
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .last-event {
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            border-left: 3px solid var(--purple-color);
        }

        /* å…¬å¸åˆ—è¡¨åŒºåŸŸ */
        .company-box {
            background: var(--card-bg);
            border-radius: var(--radius-size);
            border: 1px solid var(--border-color);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .company-box-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .company-box-header h3 {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .company-box-header h3::before {
            content: "";
            display: block;
            width: 4px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .btn-create-new {
            padding: 6px 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            /* æŒ‰é’®åœ†è§’å¾®è°ƒ */
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }

        thead th {
            background: #f8fafc;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 12px 4px;
            font-size: 11px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody td {
            padding: 14px 6px;
            font-size: 13px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
        }

        /* åˆ—å®½å¾®è°ƒ */
        th:nth-child(1),
        td:nth-child(1) {
            width: 12%;
            color: var(--text-secondary);
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: 34%;
            text-align: left;
            padding-left: 10px;
            font-weight: 500;
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: 22%;
            text-align: right;
            padding-right: 12px;
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: 16%;
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: 16%;
        }

        /* ç©å®¶å…¬å¸æ ·å¼ */
        .player-company td {
            background-color: var(--player-bg);
        }

        .player-company td:nth-child(2) {
            color: var(--player-text);
            font-weight: 700;
        }

        .player-company td:nth-child(2)::before {
            content: "â˜… ";
            font-size: 10px;
            opacity: 0.8;
        }

        /* é€‰ä¸­è¡Œæ ·å¼ */
        tr.selected-row td {
            background-color: var(--selected-bg) !important;
        }

        tr.player-company.selected-row td {
            background-color: #fef3c7 !important;
            /* é€‰ä¸­ç©å®¶è¡Œ */
        }

        /* é¼ æ ‡æ»‘è¿‡é«˜äº®æ–‡æœ¬ */
        .clickable-name {
            transition: color 0.2s;
            cursor: pointer;
        }

        .clickable-name:hover {
            color: var(--primary-color) !important;
        }

        /* å­—ä½“ç¾åŒ–ï¼šå–æ¶ˆç­‰å®½ï¼Œä½¿ç”¨è¡¨æ ¼æ•°å­—å¯¹é½ */
        .market-value {
            font-family: inherit;
            /* ç»§æ‰¿ç³»ç»Ÿå­—ä½“ */
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            /* æ•°å­—å¯¹é½ */
            letter-spacing: -0.3px;
        }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
            /* æ·±è‰²é®ç½© */
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
            /* æ¯›ç»ç’ƒèƒŒæ™¯ */
        }

        .modal-card {
            width: 100%;
            max-width: 380px;
            max-height: 85vh;
            background: var(--card-bg);
            border-radius: var(--radius-size);
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius-size) var(--radius-size) 0 0;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            font-size: 22px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:active {
            background: #f1f5f9;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            background: #fff;
        }

        /* åˆ—è¡¨å¼å¼¹çª—å†…å®¹ */
        .event-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            line-height: 1.5;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-time {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 3px;
        }

        .event-company {
            font-weight: 600;
            color: var(--primary-color);
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: var(--text-secondary);
        }

        .stats-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* è¾“å…¥æ¡†ä¸æŒ‰é’®ç»„ */
        .input-group-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        .form-input {
            flex: 1;
            /* è¾“å…¥æ¡†å æ®å‰©ä½™ç©ºé—´ */
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            background: #f8fafc;
            border-radius: var(--radius-size);
            /* åœ†è§’ä¸€è‡´ */
            font-size: 14px;
            outline: none;
            -webkit-appearance: none;
            color: var(--text-primary);
            transition: border-color 0.2s, background 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            background: #fff;
        }

        .btn-apply-inline {
            width: auto;
            padding: 0 16px;
            background: var(--header-bg);
            color: #fff;
            border: none;
            border-radius: var(--radius-size);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-dice {
            padding: 0 14px;
            background: #fbbf24;
            border: none;
            border-radius: var(--radius-size);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .info-detail-row span:first-child {
            color: var(--text-secondary);
        }

        .info-detail-row span:last-child {
            font-weight: 700;
            color: var(--text-primary);
            font-family: inherit;
            font-variant-numeric: tabular-nums;
        }

        /* æŒ‰é’®ç½‘æ ¼ */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .action-btn {
            padding: 14px;
            border: none;
            border-radius: var(--radius-size);
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: opacity 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .btn-inject {
            background: var(--success-color);
        }

        .btn-withdraw {
            background: var(--warning-color);
        }

        .btn-split {
            background: var(--purple-color);
        }

        .btn-bankrupt {
            background: var(--danger-color);
        }

        /* ç¡®è®¤æŒ‰é’® */
        .btn-confirm {
            width: 100%;
            padding: 14px;
            background: var(--header-bg);
            color: #fff;
            border: none;
            border-radius: var(--radius-size);
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
        }

        .action-btn.disabled {
            background-color: #cbd5e1 !important;
            color: #94a3b8 !important;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* æ»‘å— */
        .slider-wrap {
            margin: 24px 0;
            padding: 16px;
            background: #f8fafc;
            border-radius: var(--radius-size);
            border: 1px solid var(--border-color);
        }

        .slider-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: block;
        }

        .slider-input {
            width: 100%;
            margin: 12px 0;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .slider-val {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            font-variant-numeric: tabular-nums;
        }

        .feedback-text {
            color: var(--danger-color);
            font-size: 12px;
            text-align: center;
            min-height: 20px;
            margin-top: 12px;
            line-height: 1.4;
            font-weight: 500;
        }

        @media (min-width: 768px) {
            body {
                max-width: 600px;
                margin: 0 auto;
                border-left: 1px solid #e2e8f0;
                border-right: 1px solid #e2e8f0;
            }
        }
    </style>
</head>

<body>
    <div class="header-wrap">
        <div class="title-bar">
            <h1>å…¬å¸ç”Ÿå­˜æ¨¡æ‹Ÿ</h1>
            <button class="stats-btn" onclick="openStatsModal()">ç»Ÿè®¡</button>
        </div>
        <!-- æ•´åˆåœ¨ä¸€è¡Œ -->
        <div class="info-bar-row">
            <div class="info-item">å¹´ä»½: <span id="gameYear">0</span></div>
            <div class="info-item">æ€»å¸‚å€¼: <span id="playerTotalValue">0.00</span>äº¿</div>
            <div class="info-item">èµ„äº§: <span id="flexibleAssets">2.00</span>äº¿</div>
        </div>
    </div>

    <div class="event-bar">
        <div class="event-header">
            <h3>å¤§äº‹ä»¶è®°å½•</h3>
            <button class="view-all-btn" onclick="openEventModal()">æŸ¥çœ‹å…¨éƒ¨</button>
        </div>
        <div class="last-event" id="lastEvent">æ¸¸æˆåˆå§‹åŒ–ï¼Œ20å®¶å…¬å¸å‡ä»¥1äº¿å¸‚å€¼æˆç«‹</div>
    </div>

    <div class="company-box">
        <div class="company-box-header">
            <h3>å…¬å¸å¸‚å€¼æ’åæ¦œ</h3>
            <button class="btn-create-new" onclick="openCreateModal()">+ æ–°å»ºå…¬å¸</button>
        </div>
        <div class="table-container">
            <table id="companyTable">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>å…¬å¸åç§°</th>
                        <th>å¸‚å€¼ï¼ˆäº¿ï¼‰</th>
                        <th>æˆç«‹æ—¶é•¿</th>
                        <th>å¹¸è¿å€¼</th>
                    </tr>
                </thead>
                <tbody id="companyList">
                </tbody>
            </table>
        </div>
    </div>

    <!-- äº‹ä»¶å¼¹çª— -->
    <div class="modal-mask" id="eventModalMask" onclick="closeEventModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>å¤§äº‹ä»¶è®°å½•</h3>
                <div class="modal-close" onclick="closeEventModal()">Ã—</div>
            </div>
            <div class="modal-body" id="eventList">
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¼¹çª— -->
    <div class="modal-mask" id="statsModalMask" onclick="closeStatsModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
                <div class="modal-close" onclick="closeStatsModal()">Ã—</div>
            </div>
            <div class="modal-body" id="statsList">
            </div>
        </div>
    </div>

    <!-- æ–°å»ºå…¬å¸å¼¹çª— -->
    <div class="modal-mask" id="createModalMask" onclick="closeCreateModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>æ–°å»ºå…¬å¸</h3>
                <div class="modal-close" onclick="closeCreateModal()">Ã—</div>
            </div>
            <div class="modal-body">
                <div class="input-group-row">
                    <input type="text" class="form-input" id="createNameInput" placeholder="è¾“å…¥å…¬å¸åç§°">
                    <button class="btn-dice" onclick="rollRandomName()">ğŸ²</button>
                </div>

                <div class="slider-wrap">
                    <div class="slider-label">åˆå§‹å¸‚å€¼åˆ†é…ï¼ˆæœ€å°‘1äº¿ï¼‰</div>
                    <input type="range" class="slider-input" id="createMoneySlider" min="0" max="0" step="0.01"
                        value="0">
                    <div class="slider-val" id="createMoneyDisplay">1.00äº¿</div>
                </div>

                <button class="btn-confirm" onclick="applyCreateCompany()">ç¡®è®¤åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- å…¬å¸è¯¦æƒ…å¼¹çª— -->
    <div class="modal-mask" id="companyModalMask" onclick="closeCompanyModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>å…¬å¸è¯¦æƒ…</h3>
                <div class="modal-close" onclick="closeCompanyModal()">Ã—</div>
            </div>
            <div class="modal-body">
                <!-- é‡å‘½ååŒºåŸŸï¼šä¸€è¡Œæ˜¾ç¤º -->
                <div class="input-group-row">
                    <input type="text" class="form-input" id="editCompanyName" placeholder="å…¬å¸åç§°">
                    <button class="btn-apply-inline" onclick="applyRename()">åº”ç”¨</button>
                </div>

                <div style="margin-top: 10px;">
                    <div class="info-detail-row">
                        <span>å…¬å¸å¸‚å€¼</span>
                        <span id="detailMarketValue">0.00äº¿</span>
                    </div>
                    <div class="info-detail-row">
                        <span>æˆç«‹æ—¶é•¿</span>
                        <span id="detailCompanyAge">0</span>
                    </div>
                    <div class="info-detail-row">
                        <span>å¹¸è¿å€¼</span>
                        <span id="detailLucky">0</span>
                    </div>
                </div>

                <div id="playerActions" class="action-grid" style="display: none;">
                    <button id="btnInject" class="action-btn btn-inject">å¸‚å€¼åˆ†é…</button>
                    <button id="btnWithdraw" class="action-btn btn-withdraw">èµ„äº§æç°</button>
                    <button id="btnSplit" class="action-btn btn-split">å…¬å¸æ‹†åˆ†</button>
                    <button id="btnBankrupt" class="action-btn btn-bankrupt">ç ´äº§</button>
                </div>
                <div id="actionFeedback" class="feedback-text"></div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œäº¤äº’å¼¹çª— -->
    <div class="modal-mask" id="actionModalMask" onclick="closeActionModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="actionTitle">æ“ä½œ</h3>
                <div class="modal-close" onclick="closeActionModal()">Ã—</div>
            </div>
            <div class="modal-body">
                <div id="actionInputContainer"></div>

                <div class="slider-wrap" id="sliderContainer">
                    <div id="actionDesc" class="slider-label"></div>
                    <input type="range" class="slider-input" id="actionSlider" min="0" max="100" value="0">
                    <div class="slider-val" id="sliderValueText">0</div>
                </div>

                <button class="btn-confirm" onclick="applyAction()">åº”ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        let companies = [];
        let gameSecond = 0;
        let gameYear = 0;
        let bankruptCount = 0;
        let flexibleAssets = 2.00;
        let eventRecords = [];
        let selectedCompanyId = null;
        let currentOperateCompanyId = null;
        let currentActionType = null;

        // å…¨å±€æ“ä½œé™åˆ¶
        let globalLastActionYear = {
            inject: -1,
            withdraw: -1,
            split: -1,
            bankrupt: -1
        };

        // åŸºç¡€é…ç½®
        const MIN_COMPANIES = 20;
        const UPDATE_INTERVAL = 1000;
        const LUCKY_UPDATE_INTERVAL = 10;
        const MAX_EVENT_RECORDS = 100;
        const LUCKY_MIN = -10;
        const LUCKY_MAX = 10;
        const MARKET_CAP_FORMULA_BASE = 1000;
        const MARKET_CAP_FORMULA_DEN = 999;

        window.onload = function () {
            initCompanies();
            updateBaseInfo();
            renderCompanyList();
            addBigEventRecord("ç³»ç»Ÿ", `æ¸¸æˆåˆå§‹åŒ–ï¼Œ${MIN_COMPANIES}å®¶å…¬å¸å‡ä»¥1äº¿å¸‚å€¼æˆç«‹`);
            setInterval(coreUpdate, UPDATE_INTERVAL);
        };

        function getRandomName() {
            const prefix = ["å¤§ä¿¡", "å¤©å", "å·¦æœ¬", "æ–°å¯¿", "é¼æ³°", "äº‘å¸†", "é”ç§‘", "é‡‘èŒ‚", "åšè¿œ", "å¤§å±‹", "ç‰å", "å¤§æˆ", "æ–°ä¿¡", "æ˜ç‰", "å®è¾¾", "ç››ä¸–"];
            const suffix = ["ç§‘æŠ€", "å®ä¸š", "èµ„æœ¬", "å•†è´¸", "æ™ºé€ ", "æ–‡æ—…", "åŒ»è¯", "æ–°èƒ½æº", "ç‰©æµ", "ä¼ åª’", "é›†å›¢", "æ¸¸æˆ", "ä¿é™©", "Ai", "ç”µå­"];
            return `${prefix[Math.floor(Math.random() * prefix.length)]}${suffix[Math.floor(Math.random() * suffix.length)]}`;
        }

        function initCompanies() {
            for (let i = 0; i < MIN_COMPANIES; i++) {
                companies.push(createCompany(false));
            }
            sortCompaniesByValue();
        }

        function createCompany(isPlayer = false, manualValue = null) {
            const randomName = isPlayer ? "" : getRandomName();
            const initLucky = Math.floor(Math.random() * 21) - 10;
            let initValue = isPlayer ? 1.00 : +(Math.random() * 0.88 + 1.00).toFixed(2);
            if (manualValue !== null) initValue = manualValue;

            return {
                id: Date.now() + Math.random(),
                name: randomName,
                marketValue: initValue,
                createTime: gameYear,
                lucky: initLucky,
                isPlayer
            };
        }

        // --- æ–°å»ºå…¬å¸ç›¸å…³é€»è¾‘ ---

        function openCreateModal() {
            document.getElementById("createNameInput").value = "";
            const slider = document.getElementById("createMoneySlider");
            const display = document.getElementById("createMoneyDisplay");

            if (flexibleAssets < 1) {
                alert("çµæ´»èµ„äº§ä¸è¶³1äº¿ï¼Œæ— æ³•åˆ›å»ºæ–°å…¬å¸ï¼");
                return;
            }

            slider.min = 1.00;
            slider.max = flexibleAssets;
            slider.step = 0.01;
            slider.value = 1.00;
            display.innerText = "1.00äº¿";

            slider.oninput = function () {
                display.innerText = parseFloat(this.value).toFixed(2) + "äº¿";
            }

            document.getElementById("createModalMask").style.display = "flex";
        }

        function closeCreateModal() {
            document.getElementById("createModalMask").style.display = "none";
        }

        function rollRandomName() {
            document.getElementById("createNameInput").value = getRandomName();
        }

        function applyCreateCompany() {
            const name = document.getElementById("createNameInput").value.trim();
            const cost = parseFloat(document.getElementById("createMoneySlider").value);

            if (!name) {
                alert("è¯·è¾“å…¥å…¬å¸åç§°ï¼");
                return;
            }
            if (companies.some(c => c.name === name)) {
                alert("å…¬å¸åç§°å·²å­˜åœ¨ï¼");
                return;
            }
            if (cost > flexibleAssets) {
                alert("èµ„äº§ä¸è¶³ï¼");
                return;
            }
            if (cost < 1) {
                alert("åˆå§‹å¸‚å€¼ä¸èƒ½ä½äº1äº¿ï¼");
                return;
            }

            flexibleAssets -= cost;
            const playerCompany = createCompany(true, cost);
            playerCompany.name = name;
            playerCompany.createTime = gameYear;
            companies.push(playerCompany);

            sortCompaniesByValue();
            renderCompanyList();
            updateBaseInfo();
            addBigEventRecord(name, `ç©å®¶æ¶ˆè€—${cost.toFixed(2)}äº¿çµæ´»èµ„äº§åˆ›å»ºå…¬å¸`);
            closeCreateModal();
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        function calcDynamicRateBase(marketCap) {
            const slope = 0.05 - 0.04 * (Math.min(marketCap, MARKET_CAP_FORMULA_BASE) - 1) / MARKET_CAP_FORMULA_DEN;
            if (marketCap > MARKET_CAP_FORMULA_BASE) {
                const over = marketCap - MARKET_CAP_FORMULA_BASE;
                return Math.max(0.0001, slope - 0.002 * (over / 1000));
            }
            return Math.max(0.0001, slope);
        }

        function coreUpdate() {
            gameSecond++;
            const prevGameYear = gameYear;
            gameYear = Math.floor(gameSecond / 60);

            if (gameSecond % LUCKY_UPDATE_INTERVAL === 0) {
                companies = updateAllLucky(companies);
            }

            companies = companies.map(company => {
                const dynamicBase = calcDynamicRateBase(company.marketValue);
                let rateCoeff = 0;
                if (company.lucky >= 6) {
                    rateCoeff = dynamicBase;
                } else if (company.lucky >= 0) {
                    rateCoeff = dynamicBase * 0.4;
                } else if (company.lucky >= -5) {
                    rateCoeff = -dynamicBase * 0.4;
                } else {
                    rateCoeff = -dynamicBase;
                }
                let newMarketValue = company.marketValue * (1 + rateCoeff);
                newMarketValue = Math.round(newMarketValue * 100) / 100;
                return { ...company, marketValue: newMarketValue };
            });

            // ç ´äº§æ£€æµ‹
            const originCount = companies.length;
            const nonBankrupt = companies.filter(c => c.marketValue > 0.1);
            const bankruptNum = originCount - nonBankrupt.length;
            if (bankruptNum > 0) {
                bankruptCount += bankruptNum;
                addBigEventRecord("ç³»ç»Ÿ", `${bankruptNum}å®¶å…¬å¸å¸‚å€¼å½’é›¶ï¼Œå®£å‘Šç ´äº§`);
            }
            companies = nonBankrupt;

            // æ–°çš„ä¸€å¹´é€»è¾‘
            if (gameYear > prevGameYear) {
                // 1. æ–°å…¬å¸æˆç«‹ (éšæœº0-3ä¸ª)
                const addNum = Math.floor(Math.random() * 4); // 0,1,2,3
                if (addNum > 0) {
                    let newNameList = [];
                    for (let i = 0; i < addNum; i++) {
                        const nc = createCompany(false);
                        companies.push(nc);
                        newNameList.push(`ã€${nc.name}ã€‘`);
                    }
                    addBigEventRecord("ç³»ç»Ÿ", `${gameYear}å¹´ ${newNameList.join('ã€')}è¿›å…¥å¸‚åœº`);
                }

                // 2. æ”¿åºœèµ„åŠ©
                const poorList = companies.filter(c => c.marketValue < 20);
                if (poorList.length > 0) {
                    const luckyOne = poorList[Math.floor(Math.random() * poorList.length)];
                    const subsidy = Math.floor(Math.random() * 9) + 2;
                    luckyOne.marketValue += subsidy;
                    luckyOne.marketValue = Math.round(luckyOne.marketValue * 100) / 100;
                    addBigEventRecord("æ”¿åºœèµ„åŠ©", `å‘ã€${luckyOne.name}ã€‘å‘æ”¾ä¸“é¡¹è¡¥åŠ©${subsidy}äº¿`);
                }

                // 3. éšæœºè‡ªä¸»ç ´äº§äº‹ä»¶ (50%æ¦‚ç‡)
                if (Math.random() < 0.5) {
                    const candidates = companies.filter(c => !c.isPlayer && c.marketValue < 3 && (gameYear - c.createTime) >= 3);
                    if (candidates.length > 0) {
                        const target = candidates[Math.floor(Math.random() * candidates.length)];
                        companies = companies.filter(c => c.id !== target.id); // ç§»é™¤
                        bankruptCount++;
                        addBigEventRecord("ç ´äº§æ¸…ç®—", `ã€${target.name}ã€‘å› ç»è¥ä¸å–„ï¼Œé€‰æ‹©è‡ªä¸»ç ´äº§é€€å¸‚`);
                    }
                }
            }

            sortCompaniesByValue();
            renderCompanyList();
            updateBaseInfo();
            if (document.getElementById("companyModalMask").style.display === "flex" && currentOperateCompanyId) {
                updateCompanyModalData();
            }
        }

        function updateAllLucky(companies) {
            return companies.map(company => {
                let newLucky;
                if (company.lucky === 0) {
                    newLucky = Math.random() < 2 / 3 ? 1 : -1;
                } else {
                    newLucky = Math.round(company.lucky * 0.7 + (Math.random() - 0.5) * 5);
                }
                newLucky = Math.max(LUCKY_MIN, Math.min(LUCKY_MAX, newLucky));
                return { ...company, lucky: newLucky };
            });
        }

        function sortCompaniesByValue() {
            companies.sort((a, b) => b.marketValue - a.marketValue);
        }

        function renderCompanyList() {
            const listEl = document.getElementById("companyList");
            listEl.innerHTML = "";
            companies.forEach((company, index) => {
                const tr = document.createElement("tr");
                if (company.isPlayer) tr.classList.add("player-company");
                if (company.id === selectedCompanyId) tr.classList.add("selected-row");

                const companyAge = gameYear - company.createTime;
                const ageText = companyAge <= 0 ? "0" : companyAge;
                const marketValue = company.marketValue.toFixed(2);

                tr.onclick = () => selectCompanyRow(company.id);

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="clickable-name" onclick="openCompanyModal('${company.id}', event)">${company.name}</td>
                    <td class="market-value">${marketValue}</td>
                    <td>${ageText}</td>
                    <td>${company.lucky}</td>
                `;
                listEl.appendChild(tr);
            });
        }

        function selectCompanyRow(id) {
            selectedCompanyId = id;
            renderCompanyList();
        }

        function updateBaseInfo() {
            document.getElementById("gameYear").innerText = gameYear;
            const playerCompanies = companies.filter(c => c.isPlayer);
            const playerTotal = playerCompanies.reduce((sum, c) => sum + c.marketValue, 0);
            document.getElementById("playerTotalValue").innerText = playerTotal.toFixed(2);
            document.getElementById("flexibleAssets").innerText = flexibleAssets.toFixed(2);
        }

        function addBigEventRecord(actorName, content) {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            let displayActor = actorName;
            const sysNames = ["ç³»ç»Ÿ", "æ”¿åºœèµ„åŠ©", "ç ´äº§æ¸…ç®—"];
            if (!sysNames.includes(actorName)) {
                displayActor = `ã€${actorName}ã€‘`;
            }

            const eventItem = { time: timeStr, company: displayActor, content, gameYear };
            eventRecords.unshift(eventItem);
            if (eventRecords.length > MAX_EVENT_RECORDS) {
                eventRecords.pop();
            }
            document.getElementById("lastEvent").textContent = `[${timeStr}] ${displayActor}ï¼š${content}`;
            renderEventList();
        }

        function renderEventList() {
            const eventListEl = document.getElementById("eventList");
            eventListEl.innerHTML = "";
            eventRecords.forEach(item => {
                const div = document.createElement("div");
                div.className = "event-item";
                div.innerHTML = `
                    <div class="event-time">${item.time} | å¹´ä»½${item.gameYear}</div>
                    <div><span class="event-company">${item.company}</span>ï¼š${item.content}</div>
                `;
                eventListEl.appendChild(div);
            });
        }

        function renderStatsList() {
            const statsListEl = document.getElementById("statsList");
            statsListEl.innerHTML = "";
            const playerCompanies = companies.filter(c => c.isPlayer);
            const playerTotal = playerCompanies.reduce((sum, c) => sum + c.marketValue, 0);
            const avgPlayerValue = playerCompanies.length ? (playerTotal / playerCompanies.length).toFixed(2) : "0.00";
            const topCompany = companies.length ? companies[0] : null;
            const stats = [
                { label: "å¹´ä»½", value: gameYear },
                { label: "å…¬å¸æ€»æ•°é‡", value: companies.length },
                { label: "ç ´äº§å…¬å¸æ€»æ•°", value: bankruptCount },
                { label: "ç©å®¶å…¬å¸æ•°é‡", value: playerCompanies.length },
                { label: "ç©å®¶æ€»å¸‚å€¼", value: playerTotal.toFixed(2) + "äº¿" },
                { label: "ç©å®¶å¹³å‡å¸‚å€¼", value: avgPlayerValue + "äº¿" },
                { label: "çµæ´»èµ„äº§", value: flexibleAssets.toFixed(2) + "äº¿" },
                { label: "å½“å‰æ¦œé¦–å…¬å¸", value: topCompany ? `ã€${topCompany.name}ã€‘` : "--" },
                { label: "æ¦œé¦–å¸‚å€¼", value: topCompany ? topCompany.marketValue.toFixed(2) + "äº¿" : "--" }
            ];
            stats.forEach(stat => {
                const div = document.createElement("div");
                div.className = "stats-item";
                div.innerHTML = `<span class="stats-label">${stat.label}</span><span class="stats-value">${stat.value}</span>`;
                statsListEl.appendChild(div);
            });
        }

        // --- å…¬å¸è¯¦æƒ…ä¸æ“ä½œå¼¹çª— ---

        function openCompanyModal(idStr, event) {
            if (event) event.stopPropagation();
            const id = parseFloat(idStr);
            const company = companies.find(c => c.id === id);
            if (!company) return;

            currentOperateCompanyId = id;
            selectedCompanyId = id;
            renderCompanyList();

            document.getElementById("editCompanyName").value = company.name;
            document.getElementById("actionFeedback").innerText = "";

            const actionsDiv = document.getElementById("playerActions");
            actionsDiv.style.display = company.isPlayer ? "grid" : "none";

            if (company.isPlayer) {
                setupActionButton('btnInject', 'inject', company);
                setupActionButton('btnWithdraw', 'withdraw', company);
                setupActionButton('btnSplit', 'split', company);
                setupActionButton('btnBankrupt', 'bankrupt', company);
            }

            updateCompanyModalData();
            document.getElementById("companyModalMask").style.display = "flex";
        }

        function setupActionButton(btnId, type, company) {
            const btn = document.getElementById(btnId);
            let disabled = false;
            let reason = "";

            if (globalLastActionYear[type] === gameYear) {
                disabled = true;
                reason = "å…¨æœè¯¥åŠŸèƒ½æ¯å¹´åªèƒ½æ“ä½œä¸€æ¬¡ï¼ˆæ‰€æœ‰ç©å®¶å…¬å¸å…±äº«é™åˆ¶ï¼‰";
            }

            if (type === 'bankrupt' && !disabled) {
                if (company.marketValue >= 10) {
                    disabled = true;
                    reason = "å…¬å¸ä¸æ»¡è¶³ç ´äº§æ¡ä»¶ï¼ˆå¸‚å€¼éœ€å°äº10äº¿ï¼‰";
                }
            }

            if (disabled) {
                btn.classList.add('disabled');
            } else {
                btn.classList.remove('disabled');
            }

            btn.onclick = () => {
                document.getElementById("actionFeedback").innerText = "";
                if (disabled) {
                    document.getElementById("actionFeedback").innerText = reason;
                } else {
                    openActionModal(type);
                }
            };
        }

        function updateCompanyModalData() {
            const company = companies.find(c => c.id === currentOperateCompanyId);
            if (!company) {
                closeCompanyModal();
                return;
            }
            const age = gameYear - company.createTime;
            const ageText = age <= 0 ? "0" : age;

            document.getElementById("detailMarketValue").innerText = company.marketValue.toFixed(2) + "äº¿";
            document.getElementById("detailCompanyAge").innerText = ageText;
            document.getElementById("detailLucky").innerText = company.lucky;
        }

        function closeCompanyModal() {
            document.getElementById("companyModalMask").style.display = "none";
            currentOperateCompanyId = null;
        }

        function applyRename() {
            const newName = document.getElementById("editCompanyName").value.trim();
            const company = companies.find(c => c.id === currentOperateCompanyId);
            if (!company || !newName) return;
            if (companies.some(c => c.name === newName && c.id !== company.id)) {
                alert("å…¬å¸åç§°å·²å­˜åœ¨ï¼");
                return;
            }
            const oldName = company.name;
            company.name = newName;
            renderCompanyList();
            addBigEventRecord(company.name, `å…¬å¸æ›´åä¸º ã€${newName}ã€‘ (åŸ: ã€${oldName}ã€‘)`);
            alert("é‡å‘½åæˆåŠŸ");
        }

        function openActionModal(type) {
            const company = companies.find(c => c.id === currentOperateCompanyId);
            if (!company) return;

            currentActionType = type;
            document.getElementById("companyModalMask").style.display = "none";

            const modal = document.getElementById("actionModalMask");
            const slider = document.getElementById("actionSlider");
            const sliderContainer = document.getElementById("sliderContainer");
            const inputContainer = document.getElementById("actionInputContainer");
            const title = document.getElementById("actionTitle");
            const desc = document.getElementById("actionDesc");

            inputContainer.innerHTML = "";
            sliderContainer.style.display = "block";

            slider.oninput = updateSliderDisplay;

            if (type === 'inject') {
                title.innerText = "å¸‚å€¼åˆ†é… (æ³¨èµ„)";
                slider.min = 0;
                slider.max = 100;
                slider.value = 0;
                desc.innerText = `çµæ´»èµ„äº§: ${flexibleAssets.toFixed(2)}äº¿ | å½“å‰å¸‚å€¼: ${company.marketValue.toFixed(2)}äº¿`;
            } else if (type === 'withdraw') {
                title.innerText = "èµ„äº§æç°";
                slider.min = 1;
                slider.max = 90;
                slider.value = 10;
                desc.innerText = `å½“å‰å¸‚å€¼: ${company.marketValue.toFixed(2)}äº¿`;
            } else if (type === 'split') {
                title.innerText = "å…¬å¸æ‹†åˆ†";
                inputContainer.innerHTML = `<input type="text" class="form-input" id="splitNewName" value="æ–°${company.name}" style="width:100%;margin-bottom:10px;">`;
                slider.min = 1;
                slider.max = 90;
                slider.value = 50;
                desc.innerText = `æ¯å…¬å¸å¸‚å€¼: ${company.marketValue.toFixed(2)}äº¿`;
            } else if (type === 'bankrupt') {
                title.innerText = "ç”³è¯·ç ´äº§";
                sliderContainer.style.display = "none";
                desc.innerText = `ç¡®å®šè®© ã€${company.name}ã€‘ ç ´äº§å—ï¼Ÿ\nå½“å‰å¸‚å€¼ ${company.marketValue.toFixed(2)}äº¿ å°†è½¬å…¥çµæ´»èµ„äº§ã€‚`;
            }

            modal.style.display = "flex";
            updateSliderDisplay();
        }

        function updateSliderDisplay() {
            const slider = document.getElementById("actionSlider");
            const display = document.getElementById("sliderValueText");
            const val = parseInt(slider.value);
            const company = companies.find(c => c.id === currentOperateCompanyId);

            if (currentActionType === 'inject') {
                const amount = flexibleAssets * (val / 100);
                display.innerText = `åˆ†é… ${val}% (${amount.toFixed(2)}äº¿)`;
            } else if (currentActionType === 'withdraw') {
                const amount = company.marketValue * (val / 100);
                display.innerText = `æç° ${val}% (${amount.toFixed(2)}äº¿)`;
            } else if (currentActionType === 'split') {
                const amount = company.marketValue * (val / 100);
                display.innerText = `åˆ†é… ${val}% (${amount.toFixed(2)}äº¿)`;
            }
        }

        function applyAction() {
            const company = companies.find(c => c.id === currentOperateCompanyId);
            if (!company) {
                closeActionModal();
                return;
            }

            const sliderVal = parseInt(document.getElementById("actionSlider").value);

            if (currentActionType === 'inject') {
                const amount = flexibleAssets * (sliderVal / 100);
                if (amount <= 0 && flexibleAssets > 0) return alert("åˆ†é…é‡‘é¢éœ€å¤§äº0");

                flexibleAssets -= amount;
                company.marketValue += amount;
                company.marketValue = Math.round(company.marketValue * 100) / 100;

                addBigEventRecord(company.name, `è·å¾—ç©å®¶æ³¨èµ„ ${amount.toFixed(2)}äº¿`);
                globalLastActionYear.inject = gameYear;

            } else if (currentActionType === 'withdraw') {
                const amount = company.marketValue * (sliderVal / 100);

                company.marketValue -= amount;
                company.marketValue = Math.round(company.marketValue * 100) / 100;
                flexibleAssets += amount;

                addBigEventRecord(company.name, `ç©å®¶æç°èµ„é‡‘ ${amount.toFixed(2)}äº¿`);
                globalLastActionYear.withdraw = gameYear;

            } else if (currentActionType === 'split') {
                const newName = document.getElementById("splitNewName").value.trim();
                if (!newName || companies.some(c => c.name === newName)) return alert("åç§°æ— æ•ˆæˆ–å·²å­˜åœ¨");

                const amount = company.marketValue * (sliderVal / 100);
                company.marketValue -= amount;
                company.marketValue = Math.round(company.marketValue * 100) / 100;

                const newCompany = createCompany(true);
                newCompany.name = newName;
                newCompany.marketValue = Math.round(amount * 100) / 100;
                newCompany.createTime = gameYear;

                companies.push(newCompany);
                sortCompaniesByValue();

                addBigEventRecord(company.name, `æ‹†åˆ†å‡ºæ–°å…¬å¸ ã€${newName}ã€‘ï¼Œåˆ†èµ„ ${amount.toFixed(2)}äº¿`);
                globalLastActionYear.split = gameYear;

            } else if (currentActionType === 'bankrupt') {
                const amount = company.marketValue;
                flexibleAssets += amount;
                companies = companies.filter(c => c.id !== company.id);
                bankruptCount++;
                addBigEventRecord(company.name, `ç©å®¶ç”³è¯·ç ´äº§æ¸…ç®—ï¼Œå›æ”¶èµ„é‡‘ ${amount.toFixed(2)}äº¿`);
                globalLastActionYear.bankrupt = gameYear;

                updateBaseInfo();
                renderCompanyList();
                closeActionModal();
                return;
            }

            updateBaseInfo();
            renderCompanyList();
            closeActionModal();
        }

        function closeActionModal() {
            document.getElementById("actionModalMask").style.display = "none";
            currentActionType = null;
            currentOperateCompanyId = null;
        }

        function openEventModal() {
            document.getElementById("eventModalMask").style.display = "flex";
        }
        function closeEventModal() {
            document.getElementById("eventModalMask").style.display = "none";
        }
        function openStatsModal() {
            renderStatsList();
            document.getElementById("statsModalMask").style.display = "flex";
        }
        function closeStatsModal() {
            document.getElementById("statsModalMask").style.display = "none";
        }

        document.addEventListener("keydown", e => {
            if (e.key === "Escape") {
                closeEventModal();
                closeStatsModal();
                closeCompanyModal();
                closeActionModal();
                closeCreateModal();
            }
        });
        document.getElementById("createNameInput").addEventListener("focus", function () {
            this.autocomplete = "off";
        });
    </script>
</body>

</html>