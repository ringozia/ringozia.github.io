# 前端聊天群抢红包游戏开发最终版需求（无代码输出）
开发一款适配手机端与电脑端双端布局及操作逻辑的前端聊天群抢红包游戏，核心优化聊天滚动逻辑，解决新消息强制跳转底部问题，同时保留所有已确认功能，保证界面与交互体验符合微信风格，**仅输出需求文档，不包含代码内容**。

## 一、 核心优化：聊天滚动逻辑
1.  **滚动状态检测**
    - 实时监听聊天消息区的滚动位置，通过 `scrollTop`、`scrollHeight`、`clientHeight` 计算，判断用户是否处于**查看历史消息状态**（滚动条距离底部误差＞10px）。
    - 设定滚动状态标记 `isAtBottom`，用户手动滚动时动态更新标记值。

2.  **新消息处理规则**
    - 当 `isAtBottom = true`（用户处于最新消息底部）：新增消息时，自动滚动到消息底部，保持跟随最新内容。
    - 当 `isAtBottom = false`（用户正在查看历史消息）：新增消息时，**不自动跳转**，在消息区底部显示“新消息(x)”提示（x为未读数量）。
    - 当用户手动滑动到消息底部后：自动将 `isAtBottom` 设为 `true`，恢复新消息自动跟随逻辑。

3.  **新消息提示交互**
    - 提示样式为半透明深色胶囊，居中悬浮于聊天区底部上方。
    - 点击提示可快速跳转至最新消息，并清空未读计数。

## 二、 角色与基础数据规则
1.  **玩家信息**
    - 初始昵称“大六六”，初始头像🎃；支持通过设置弹窗修改昵称、选择内置emoji头像。
    - 初始现金余额50元，累计抢红包数初始为0，数据实时同步至顶部信息胶囊栏。

2.  **群友信息**
    - 昵称由两组各不少于10个的字符串随机组合生成（如姓氏+名字模式）。
    - 头像为圆形设计，从不少于20种emoji中随机分配。
    - 群人数默认初始值100人，支持按配置区间随机波动增减，变动数据实时同步至信息胶囊栏。

## 三、 消息与表情功能规则
1.  **文本消息**
    - 群友随机发送文本消息，内容从不少于20条的预设消息池中抽取，发送频率可配置。
    - 玩家发送文本消息字数上限500字，超出部分禁止输入/自动截断；输入框支持双端回车键发送。
    - 文本消息气泡内文字**强制横向布局**，仅当单行文本超出气泡最大宽度时触发换行，确保无纵向排版问题。

2.  **@高亮功能**
    - 点击群友头像，输入框自动插入“@+群友昵称+空格”格式文本。
    - 聊天气泡、输入框内的文本自动识别该格式，**仅@后的昵称部分高亮为蓝色**；格式破坏（无空格、@位置错误等）则取消高亮。
    - 系统触发的所有@消息（感谢、互动、群友随机互动）均遵循此高亮规则。

3.  **表情功能**
    - 表情资源为指定3张图片，名称分别为“1”“2”“3”，无需关联emoji，发送时仅展示图片。
    - 表情选择弹窗布局为4×3，支持纵向滚动；顶部显示“表情包”标题，右上角设关闭按钮×，支持点击弹窗外关闭。
    - 发送的表情为**自带圆角的独立卡片**（非嵌入气泡），手机端窄屏场景下保证图片完全显示，无挤压变形；群友也会按配置概率随机发送表情。

## 四、 红包核心功能规则
1.  **红包基础属性**
    - 分为拼手气红包、普通红包两类，所有红包气泡统一为**扁矩形、红色背景、金色字体**。
    - 红包气泡排版：
      - 第一行：🧧图标 + 红包类型 + 小字份数（同行展示）；
      - 第二行：备注信息（如有，≤10个汉字）；
      - 第三行：动态显示“剩余X个红包”，抢完后改为“已抢完”；
      - 第四行：交互区域（未抢显示“抢红包”按钮/玩家已抢显示“抢到XX元”/全部抢完显示“已抢完”）。

2.  **红包生成规则**
    - **玩家发红包**：打开弹窗时，金额/份数输入栏随机填入数额（≤玩家当前余额的50%）；“发红包”按钮文本实时更新为“发红包￥xx”（拼手气红包xx=输入金额，普通红包xx=单份金额×份数）。
    - **群友发红包**：按配置频率随机生成，有25%概率从备注池随机抽取备注；金额、份数均在配置区间内取值。
    - **通用校验规则**：最小金额0.01元，最小份数1份，每份最低0.01元，最大份数不超过当前群人数；不满足则判定为无效红包，禁止发送。

3.  **红包抢兑规则**
    - 红包生成后，未被玩家抢的份额在配置时间区间内由群友**陆续抢取**，非瞬间抢空。
    - 玩家可抢自己发送的红包，抢红包后余额与累计抢红包数实时更新。
    - 红包详情弹窗布局紧凑，抢红包人员信息字体缩小，包含类型、发送人、总金额、总份数、剩余份数、备注（如有）；未抢显示“抢红包”按钮，已抢显示个人抢到金额。

## 五、 互动事件规则（全支持@高亮）
1.  **玩家发红包感谢事件**
    - 触发条件：玩家发送红包且份数≥3时，有25%的触发几率。
    - 互动规则：随机生成1~3个群友发送感谢消息，格式为“@玩家昵称 感谢文案”；感谢文案从配置列表中随机选取。
    - 可配置参数：感谢文案列表、触发几率、单次最多感谢人数。

2.  **玩家发文本消息互动事件**
    - 触发条件：玩家发送文本消息后，有15%的触发几率。
    - 互动规则：随机生成1个群友发送互动消息，格式为“@玩家昵称 互动文案”；互动文案从配置列表中随机选取。
    - 可配置参数：互动文案列表、触发几率。

3.  **群友随机互动事件**
    - 触发条件：系统全局随机触发，有10%的触发几率。
    - 互动规则：随机生成1个群友发送消息，格式为“@随机群友昵称 互动文案”；被@昵称从群友名称库随机组合生成，文案从配置列表选取。
    - 可配置参数：互动文案列表、触发几率。

## 六、 界面布局与交互细节
1.  **顶部区域**
    - **标题栏**：居中显示微信风格标题，最右侧设“设置”按钮；样式为浅灰底色、加粗居中文字。
    - **信息胶囊栏**：悬浮于标题栏下方，半透明胶囊状设计，双端适配；显示当前群人数、玩家累计抢红包数、玩家现金余额。

2.  **设置弹窗功能**
    - 入口：标题栏右侧“设置”按钮；弹窗居中显示，手机端占屏宽80%，电脑端固定400px宽。
    - 功能：更换玩家头像（内置若干emoji可选）、修改玩家昵称；弹窗底部放置“清空聊天”按钮，点击清空所有消息。

3.  **底部功能操作区**
    - 布局优化：表情按钮、输入框、发送按钮**水平对齐、尺寸统一**；发红包按钮为红色，宽度最大化。
    - 按钮交互：表情按钮点击弹出表情选择弹窗；发红包按钮点击弹出红包设置弹窗；发送按钮点击发送输入框文本。

## 七、 双端适配要求
1.  **操作适配**
    - 电脑端：支持鼠标点击、滚轮滚动、回车键发送消息。
    - 手机端：按钮最小点击区域40px×40px，支持触屏滑动、回车键发送；所有弹窗适配窄屏，无挤压溢出。

2.  **显示适配**
    - 聊天消息区、弹窗、功能按钮在不同尺寸设备上自动调整布局，保持视觉一致性。
    - 表情卡片、红包气泡在手机端缩小尺寸但保持比例，文本消息气泡自适应屏幕宽度。

## 八、 可配置参数清单（需添加中文注释说明作用）
1.  群友消息/表情/红包发送频率区间
2.  红包金额/份数区间、红包被抢时间区间
3.  群人数波动间隔与范围
4.  红包感谢事件：文案列表、触发几率、单次最多感谢人数
5.  玩家文本互动事件：文案列表、触发几率
6.  群友随机互动事件：文案列表、触发几率

需要我帮你整理**该需求的功能测试用例清单**，方便你后续验证游戏的所有交互逻辑吗？




**********************新增************************



非常好，现在需要修改以下bug，记住没有提及的不要进行修改和删减！

玩家的头像排版有问题，头像应该在最右侧，随后是玩家名称和聊天气泡/红包/表情。


现在打开发红包窗口时，金额/份数输入栏会随机填入数额（不能超过玩家余额的50%），“塞钱进红包”按钮上的文本改成 “发红包￥xx”(实时根据输入更新总额，记住拼手气和普通红包的计算是不一样的)。

顶部新增居中标题，样式参考微信。原有的顶部信息栏改为悬浮胶囊状半透明窗，紧贴在标题栏下方。
标题栏最右新增一个设置按钮，点击打开设置弹窗，可以设置玩家头像（内置若干种emoji头像）、昵称。此外，现在清空聊天按钮放到设置弹窗的底部中。

美化底部栏，发红包按钮是红色的，宽度最大；表情按钮、输入框、发送按钮需要水平对齐，尺寸对齐。另外，聊天输入框需要支持双端回车键发送功能。

@高亮功能。现在玩家点击群友头像时，自动在聊天输入框中添加 被点击群友的昵称，格式“@小明 ”（@+文本+空格）。现在不论是群友/玩家的聊天气泡文本   以及玩家的聊天输入框会自动识别这种格式，并把这个格式的文本高亮为蓝色（仅@的昵称，不是全文），当格式被破坏时就取消高亮。

@功能模拟。玩家每次发送红包时，当该红包份数大于等于3时，25%的几率随机生成1~3个群友对玩家进行感谢，格式“@玩家 多谢老板”支持配制的参数：感谢的文案列表、感谢几率、最多感谢的群友人数。（该@同样支持高亮）

玩家互动事件：玩家每次发送文本消息时，15%的几率随机生成1群友对玩家进行互动，格式“@玩家 真有意思”支持配制的参数：互动的文案列表、互动几率（该@同样支持高亮）

群友随机互动事件：10%的几率随机触发，格式“@随机昵称 哈哈”，这里被@的昵称根据已有的名称库随机组合生成，支持配制的参数：互动的文案列表、互动几率（该@同样支持高亮）


现在红包的样式很好，不做改变。

//////////////////////////////////////////

群人数统计到群标题后的括号中，不再额外显示在胶囊窗口中。
玩家的头像排版还是有问题，不论是发表情/文本/红包，头像都应该在最右侧（现在显示在昵称和消息的左侧）。
现在群名称也可以在设置弹窗中修改，同步到底部标题栏。设置弹窗的头像选择改为水平布局+水平滚动以减少空间占用。
设置页面的清空聊天按钮无效，请修复。

新增 进群退群消息，当群人数随机增加时，30%的几率聊天界面显示1~3条进群消息，格式““xx”加入了群聊”或““xx”邀请“xx”加入了群聊”两者格式相同几率，样式完全参考微信样式。退群消息同进群几率一样，当当群人数随机减少时，显示1~3条退群消息，格式““xx”退出了群聊”。所涉及的昵称都由机制随机生成。


////////////////////////////////////////
非常好，现在需要修改以下bug，记住没有提及的不要进行修改和删减！

配置参数需要注释说明。表情包参数每个字典只需要name和url即可。

修改参数为grabDelayMin: 100, grabDelayMax: 1000

当玩家在聊天消息中成功@某个玩家时，会生成相对应群友的互动，格式“@玩家 文案”文案套用replyTexts的文案。（如果同时@多个群友，只支持第一个）


现在一部分参数配置支持引用外部（同目录下的）的js文件，名为  抢红包配制.js  （这个额外的js文件不是必要的，如果没有也不会影响游戏正常运行）

js文件内置的参数：thanksTexts、replyTexts、randomInteractTexts、NAMES_A、NAMES_B、TEXT_MSGS、STICKERS、RP_NOTES

以上参数整合在一个文件中，每一项需要注释说明，原html的同名参数会加上js上的配置整合为一个完整的列表。

请额外生成一份格式正确的js文件给我。


///////////////////////
基于我提供的前端代码进行更新，记住我没有提及的不要进行修改和删减！

新增：
1.
新增滚动状态检测：监听聊天消息区的滚动位置，判断用户是否处于 “查看历史消息” 状态（未滚动到最底部）；
新消息处理逻辑：
当用户处于查看历史消息状态（滚动条未在最底部）：新增消息时，聊天区不自动跳转到底部；
当用户处于最新消息状态（滚动条在最底部）：新增消息时，自动滚动到最新消息位置；

2.
新机制，玩家每次发红包，红包的总金额×10（乘数）计入系统金池，每次玩家抢红包时都会往金池中扣除相应抢到的金额。当金池小于等于0时（金池总量100，初始金池就是100/100）群友不再发红包，并且每1~3秒随机生成一个群友催促玩家发红包，格式“@玩家 轮到你发红包了”。玩家发红包时金池才会得到增值。群友每次发红包的总金额不需要根据金池的多少来计算，根据之前的区间来随机生成即可，金池即使被扣完变成负数也没关系（因为前面有判断高与0群友才会发红包）。支持配制参数：总金额的乘数、金池总量、每x~y秒的催促时间、催促文案列表。

（不是群友每次发红包消耗金池，而是玩家每次抢红包消耗金池）


3.禁止双端页面选取复制功能。

4.玩家聊天输入栏现在有字数限制，限制为100字。

5.入群欢迎：载入游戏页面时，生成一个账号名为“瞌睡猫”的群友，头像为猫的emoji，发送消息“@玩家 欢迎来到（群名称）！”

6.新增历史功能，记录玩家各项数据。顶部胶囊窗口余额之后新建一个按钮“历史”点击后弹窗展示玩家各项数据（弹窗顶部标题需要注明玩家昵称的历史数据，要有关闭弹窗按钮）弹窗在支持的数据（监听事件并记录）：已发红包数（不是份数）、已抢红包数、发单个红包最高总金额、抢单个红包最高金额、发红包总金额（所有）、抢红包总金额（所有）。

（顶部胶囊窗口不再显示已抢数据）

7.
新增存档功能：
现在对这些数据储存在浏览器中：群里昵称、玩家昵称、玩家头像、玩家余额、玩家已抢红包数、金池余额、历史记录（已发红包数（不是份数）、已抢红包数、发单个红包最高总金额、抢单个红包最高金额、发红包总金额（所有）、抢红包总金额（所有））

8.新增清空存档功能按钮，在设置弹窗中，与“清空聊天记录”按钮水平对齐等宽即可。能清空上述储存的数据，并恢复默认数值。


***代码如下：


///////////////////
很好，现在为了让金池更加可视化，在历史页面的底部新增一个“信任值”参数，直接把金池放上去，
格式：信任值：100%（%号只是装饰没有实际意义）。

记住我没有提及的不要进行修改和删减！



/////////////////////////////
很好，但是有个问题，当进入催促模式时，原有的群友发言被禁止了（包括文本聊天、表情包、@闲聊），应该是同时进行的。

记住我没有提及的不要进行修改和删减！


///////////////////////////
清空数据和清空聊天记录 为什么要询问？
发送消息时屏幕应该滑到底部







